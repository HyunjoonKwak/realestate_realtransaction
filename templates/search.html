{% extends "base.html" %}

{% block title %}ì•„íŒŒíŠ¸ ê²€ìƒ‰ - ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-search me-2"></i>ì•„íŒŒíŠ¸ ê²€ìƒ‰</h1>
            <p class="text-muted">ì§€ì—­ì„ ì„ íƒí•˜ì—¬ ì‹¤ê±°ë˜ê°€ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</p>
        </div>
    </div>

    <!-- ê²€ìƒ‰ í¼ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ê²€ìƒ‰ ì¡°ê±´</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="citySelect" class="form-label">ì‹œ/ë„</label>
                            <select class="form-select" id="citySelect" onchange="loadDistricts()">
                                <option value="">ì‹œ/ë„ ì„ íƒ</option>
                                {% for city in cities %}
                                <option value="{{ city }}">{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="districtSelect" class="form-label">êµ°/êµ¬</label>
                            <select class="form-select" id="districtSelect" disabled onchange="loadDongs()">
                                <option value="">êµ°/êµ¬ ì„ íƒ</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="dongSelect" class="form-label">ë²•ì •ë™</label>
                            <select class="form-select" id="dongSelect" disabled onchange="enableSearchButton()">
                                <option value="">ë²•ì •ë™ ì„ íƒ</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <br>
                            <button type="button" class="btn btn-primary" id="searchBtn" disabled onclick="performSearch()">
                                <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© -->
    <div id="loadingSpinner" class="text-center d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ê²€ìƒ‰ ì¤‘...</span>
        </div>
        <p class="mt-2">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div id="errorMessage" class="alert alert-danger d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText"></span>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
    <div id="searchResults" class="d-none">
        <div class="row mb-3">
            <div class="col-12">
                <h4>ê²€ìƒ‰ ê²°ê³¼</h4>
                <p class="text-muted" id="resultSummary"></p>
            </div>
        </div>

        <div id="apartmentsByDong"></div>
    </div>
</div>

<!-- ì•„íŒŒíŠ¸ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="apartmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="addToFavorites()">
                    <i class="fas fa-heart me-1"></i>ê´€ì‹¬ë‹¨ì§€ ë“±ë¡
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentRegionCode = null;
let currentRegionName = null;
let allApartments = [];
let currentSelectedApartment = null;

// êµ°/êµ¬ ëª©ë¡ ë¡œë“œ
function loadDistricts() {
    const city = document.getElementById('citySelect').value;
    const districtSelect = document.getElementById('districtSelect');
    const dongSelect = document.getElementById('dongSelect');
    const searchBtn = document.getElementById('searchBtn');

    console.log('ì‹œ/ë„ ì„ íƒ:', city);

    // í•˜ìœ„ í•„ë“œ ì´ˆê¸°í™”
    districtSelect.innerHTML = '<option value="">êµ°/êµ¬ ì„ íƒ</option>';
    districtSelect.disabled = true;
    dongSelect.innerHTML = '<option value="">ë²•ì •ë™ ì„ íƒ</option>';
    dongSelect.disabled = true;
    searchBtn.disabled = true;
    hideResults();

    if (!city) return;

    console.log('êµ°/êµ¬ ëª©ë¡ ë¡œë“œ ì‹œì‘:', city);

    fetch(`/api/districts/${encodeURIComponent(city)}`)
        .then(response => response.json())
        .then(data => {
            console.log('êµ°/êµ¬ API ì‘ë‹µ:', data);

            if (data.success && data.districts) {
                data.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.name;
                    option.textContent = `${district.name} (${district.code})`;
                    districtSelect.appendChild(option);
                });

                districtSelect.disabled = false;
                console.log('êµ°/êµ¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.districts.length + 'ê°œ');
            } else {
                showError('êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('êµ°/êµ¬ ë¡œë“œ ì˜¤ë¥˜:', error);
            showError('êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ë²•ì •ë™ ëª©ë¡ ë¡œë“œ
function loadDongs() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const dongSelect = document.getElementById('dongSelect');
    const searchBtn = document.getElementById('searchBtn');

    console.log('êµ°/êµ¬ ì„ íƒ:', district);

    // ë²•ì •ë™ í•„ë“œ ì´ˆê¸°í™”
    dongSelect.innerHTML = '<option value="">ë²•ì •ë™ ì„ íƒ</option>';
    dongSelect.disabled = true;
    searchBtn.disabled = true;
    hideResults();

    if (!city || !district) return;

    console.log('ë²•ì •ë™ ëª©ë¡ ë¡œë“œ ì‹œì‘:', city, district);

    fetch(`/api/dongs/${encodeURIComponent(city)}/${encodeURIComponent(district)}`)
        .then(response => response.json())
        .then(data => {
            console.log('ë²•ì •ë™ API ì‘ë‹µ:', data);

            if (data.success && data.dongs) {
                data.dongs.forEach(dong => {
                    const option = document.createElement('option');
                    option.value = dong;
                    option.textContent = dong;
                    dongSelect.appendChild(option);
                });

                dongSelect.disabled = false;
                console.log('ë²•ì •ë™ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.dongs.length + 'ê°œ');
            } else {
                showError('ë²•ì •ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ë²•ì •ë™ ë¡œë“œ ì˜¤ë¥˜:', error);
            showError('ë²•ì •ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”
function enableSearchButton() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const dong = document.getElementById('dongSelect').value;
    const searchBtn = document.getElementById('searchBtn');

    console.log('ë²•ì •ë™ ì„ íƒ:', dong);

    if (city && district && dong) {
        searchBtn.disabled = false;
        console.log('ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”ë¨');
    } else {
        searchBtn.disabled = true;
        console.log('ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”ë¨');
    }

    hideResults();
}

// ì•„íŒŒíŠ¸ ê²€ìƒ‰ ì‹¤í–‰
function performSearch() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const dong = document.getElementById('dongSelect').value;

    console.log('ê²€ìƒ‰ ì‹¤í–‰:', city, district, dong);

    if (!city || !district || !dong) {
        showError('ì‹œ/ë„, êµ°/êµ¬, ë²•ì •ë™ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    showLoading();
    hideError();
    hideResults();

    fetch('/api/search/step1', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            city: city,
            district: district,
            dong: dong
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        console.log('ê²€ìƒ‰ API ì‘ë‹µ:', data);

        if (data.success) {
            currentRegionCode = data.region_code;
            currentRegionName = `${city} ${district} ${dong}`;
            allApartments = data.apartment_list || [];

            displaySearchResults(data);
        } else {
            showError(data.message || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        showError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function displaySearchResults(response) {
    const totalCount = response.total_count || 0;
    const apartmentCount = allApartments.length;
    const dongName = response.dong_name || '';

    document.getElementById('resultSummary').textContent =
        `${currentRegionName}: ${apartmentCount}ê°œ ì•„íŒŒíŠ¸, ${totalCount.toLocaleString()}ê±´ ê±°ë˜ê¸°ë¡`;

    displayApartmentsByDong(allApartments);
    document.getElementById('searchResults').classList.remove('d-none');
}

// ë™ë³„ ì•„íŒŒíŠ¸ ëª©ë¡ í‘œì‹œ
function displayApartmentsByDong(apartments) {
    console.log('ì•„íŒŒíŠ¸ í‘œì‹œ:', apartments.length + 'ê°œ');

    let filteredApartments = apartments;

    // ë™ë³„ë¡œ ê·¸ë£¹í™”
    const apartmentsByDong = {};
    filteredApartments.forEach(apt => {
        if (apt.dong_list && apt.dong_list.length > 0) {
            apt.dong_list.forEach(dong => {
                if (!apartmentsByDong[dong]) {
                    apartmentsByDong[dong] = [];
                }
                apartmentsByDong[dong].push(apt);
            });
        }
    });

    // HTML ìƒì„±
    let html = '';
    const dongNames = Object.keys(apartmentsByDong).sort();

    dongNames.forEach(dong => {
        const dongApartments = apartmentsByDong[dong];
        html += `
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>${dong}
                        <span class="badge bg-primary ms-2">${dongApartments.length}ê°œ</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
        `;

        dongApartments.forEach(apt => {
            const avgPrice = formatPrice(Math.round(apt.avg_price));
            const priceRange = `${formatPrice(Math.round(apt.min_price))} ~ ${formatPrice(Math.round(apt.max_price))}`;

            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 apartment-card" style="cursor: pointer;"
                         data-apt-name="${apt.apt_name}" data-region-code="${apt.region_code}"
                         onclick="showApartmentDetailFromData(this)">
                        <div class="card-body">
                            <h6 class="card-title text-primary">${apt.apt_name}</h6>
                            <p class="card-text small">
                                <i class="fas fa-calendar me-1"></i>ì¤€ê³µ: ${apt.build_year}ë…„<br>
                                <i class="fas fa-chart-line me-1"></i>í‰ê· : ${avgPrice}<br>
                                <i class="fas fa-arrows-alt-h me-1"></i>ë²”ìœ„: ${priceRange}<br>
                                <i class="fas fa-exchange-alt me-1"></i>ê±°ë˜: ${apt.transaction_count}ê±´
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                    </div>
                </div>
            </div>
        `;
    });

    if (html === '') {
        html = '<div class="alert alert-warning">ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ì•„íŒŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    document.getElementById('apartmentsByDong').innerHTML = html;
}

// ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ
function showApartmentDetail(aptName, regionCode) {
    console.log('ğŸ¢ ì•„íŒŒíŠ¸ ìƒì„¸ ìš”ì²­:', aptName, 'ì§€ì—­ì½”ë“œ:', regionCode);

    currentSelectedApartment = { name: aptName, regionCode: regionCode };
    document.getElementById('modalTitle').textContent = aptName + ' - ê±°ë˜ê¸°ë¡';
    document.getElementById('modalBody').innerHTML =
        '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

    const modal = new bootstrap.Modal(document.getElementById('apartmentModal'));
    modal.show();

    const requestData = {
        region_code: regionCode,
        apt_name: aptName
    };
    console.log('ğŸ“¡ Step3 ìš”ì²­ ë°ì´í„°:', requestData);

    fetch('/api/search/step3', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('ğŸ“Š Step3 ì‘ë‹µ:', data);
        if (data.success) {
            console.log(`âœ… ê±°ë˜ê¸°ë¡ ${data.transactions?.length || 0}ê±´ ì¡°íšŒ`);
            displayTransactionHistory(data.transactions || []);
        } else {
            console.error('âŒ ê±°ë˜ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', data.message);
            document.getElementById('modalBody').innerHTML =
                '<div class="alert alert-danger">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    })
    .catch(error => {
        console.error('ê±°ë˜ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('modalBody').innerHTML =
            '<div class="alert alert-danger">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    });
}

// ë°ì´í„° ì†ì„±ì„ ì‚¬ìš©í•œ ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ (íŠ¹ìˆ˜ë¬¸ì ì•ˆì „)
function showApartmentDetailFromData(element) {
    const aptName = element.getAttribute('data-apt-name');
    const regionCode = element.getAttribute('data-region-code');
    showApartmentDetail(aptName, regionCode);
}

// ê±°ë˜ê¸°ë¡ í‘œì‹œ
function displayTransactionHistory(transactions) {
    if (transactions.length === 0) {
        document.getElementById('modalBody').innerHTML =
            '<div class="alert alert-info">ê±°ë˜ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    let html = `
        <div class="mb-3">
            <h6>ìµœê·¼ ê±°ë˜ê¸°ë¡ (${transactions.length}ê±´)</h6>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>ê±°ë˜ì¼</th>
                        <th>ë©´ì (ã¡)</th>
                        <th>ì¸µ</th>
                        <th>ê±°ë˜ê°€ê²©</th>
                    </tr>
                </thead>
                <tbody>
    `;

    transactions.forEach(tx => {
        const price = formatPrice(tx.deal_amount);
        html += `
            <tr>
                <td>${tx.deal_date}</td>
                <td>${tx.exclusive_area}</td>
                <td>${tx.floor}ì¸µ</td>
                <td class="text-primary fw-bold">${price}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    document.getElementById('modalBody').innerHTML = html;
}

// ê´€ì‹¬ë‹¨ì§€ ë“±ë¡
function addToFavorites() {
    if (!currentSelectedApartment) return;

    const aptData = allApartments.find(apt => apt.apt_name === currentSelectedApartment.name);
    if (!aptData) return;

    fetch('/api/favorites', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            apt_name: aptData.apt_name,
            region_code: aptData.region_code,
            region_name: currentRegionName,
            build_year: aptData.build_year,
            avg_price: Math.round(aptData.avg_price),
            min_price: Math.round(aptData.min_price),
            max_price: Math.round(aptData.max_price),
            transaction_count: aptData.transaction_count
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ê´€ì‹¬ë‹¨ì§€ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('apartmentModal')).hide();
        } else {
            alert(data.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('ê´€ì‹¬ë‹¨ì§€ ë“±ë¡ ì˜¤ë¥˜:', error);
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// í¼ ì´ˆê¸°í™”
function resetForm() {
    document.getElementById('citySelect').value = '';
    document.getElementById('districtSelect').innerHTML = '<option value="">êµ°/êµ¬ ì„ íƒ</option>';
    document.getElementById('districtSelect').disabled = true;
    document.getElementById('dongSelect').innerHTML = '<option value="">ë²•ì •ë™ ì„ íƒ</option>';
    document.getElementById('dongSelect').disabled = true;
    document.getElementById('searchBtn').disabled = true;

    hideError();
    hideResults();

    currentRegionCode = null;
    currentRegionName = null;
    allApartments = [];

    console.log('í¼ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function formatPrice(amount) {
    if (amount >= 10000) {
        const eok = Math.floor(amount / 10000);
        const man = amount % 10000;
        if (man === 0) {
            return `${eok.toLocaleString()}ì–µì›`;
        } else {
            return `${eok.toLocaleString()}ì–µ ${man.toLocaleString()}ë§Œì›`;
        }
    } else {
        return `${amount.toLocaleString()}ë§Œì›`;
    }
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.remove('d-none');
}

function hideError() {
    document.getElementById('errorMessage').classList.add('d-none');
}

function showLoading() {
    document.getElementById('loadingSpinner').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.add('d-none');
}

function hideResults() {
    document.getElementById('searchResults').classList.add('d-none');
}

console.log('ê²€ìƒ‰ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
</script>

<style>
.apartment-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

{% endblock %}