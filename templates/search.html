{% extends "base.html" %}

{% block title %}ì•„íŒŒíŠ¸ ê²€ìƒ‰ - ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-search me-2"></i>ì•„íŒŒíŠ¸ ê²€ìƒ‰</h1>
            <p class="text-muted">ì§€ì—­ì„ ì„ íƒí•˜ì—¬ ì‹¤ê±°ë˜ê°€ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</p>
        </div>
    </div>

    <!-- ê²€ìƒ‰ í¼ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ê²€ìƒ‰ ì¡°ê±´</h5>
                </div>
                <div class="card-body">
                    <!-- í†µí•© ê²€ìƒ‰ ì•ˆë‚´ -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>ë§¤ë§¤ì™€ ì „ì›”ì„¸ ê±°ë˜ë¥¼ ëª¨ë‘ í¬í•¨í•˜ì—¬ ê²€ìƒ‰í•©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label for="citySelect" class="form-label">ì‹œ/ë„</label>
                            <select class="form-select" id="citySelect" onchange="loadDistricts()">
                                <option value="">ì‹œ/ë„ ì„ íƒ</option>
                                {% for city in cities %}
                                <option value="{{ city }}">{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="districtSelect" class="form-label">êµ°/êµ¬</label>
                            <select class="form-select" id="districtSelect" disabled onchange="loadDongs()">
                                <option value="">êµ°/êµ¬ ì„ íƒ</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="dongSelect" class="form-label">ë²•ì •ë™</label>
                            <select class="form-select" id="dongSelect" disabled onchange="enableSearchButton()">
                                <option value="">ë²•ì •ë™ ì„ íƒ</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <br>
                            <button type="button" class="btn btn-primary" id="searchBtn" disabled onclick="performSearch()">
                                <i class="fas fa-search me-1"></i>ê²€ìƒ‰
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>ì´ˆê¸°í™”
                            </button>
                            <div class="btn-group ms-2" role="group">
                                <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="fas fa-database me-1"></i>ë°ì´í„° ê´€ë¦¬
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="clearCache()">
                                        <i class="fas fa-refresh me-2"></i>ìºì‹œ ì´ˆê¸°í™”
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="clearDatabase()">
                                        <i class="fas fa-database me-2"></i>DB ì´ˆê¸°í™”
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ë° ì§„í–‰ë¥  í‘œì‹œ -->
    <div id="loadingSpinner" class="text-center d-none" style="position: relative; z-index: 1000; background: white; border: 2px solid #007bff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 20px 0;">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-search me-2"></i>ê²€ìƒ‰ ì§„í–‰ ì¤‘
                </h5>

                <!-- ì „ì²´ ì§„í–‰ë¥  í‘œì‹œ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span id="progressText">ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                             role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>

                <!-- ì„¸ë¶€ ì§„í–‰ ìƒí™© -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="text-muted small">ì²˜ë¦¬ ì™„ë£Œ</div>
                            <div class="fw-bold" id="completedMonths">0</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="text-muted small">ì „ì²´ ê°œì›”</div>
                            <div class="fw-bold" id="totalMonths">0</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="text-muted small">ì´ ë°ì´í„°</div>
                            <div class="fw-bold" id="totalData">0ê±´</div>
                        </div>
                    </div>
                </div>

                <!-- í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì›” ì •ë³´ -->
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        í˜„ì¬ ì²˜ë¦¬: <span id="currentMonth">-</span>
                    </small>
                </div>

                <!-- ì·¨ì†Œ ë²„íŠ¼ -->
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelSearch()">
                        <i class="fas fa-times me-1"></i>ê²€ìƒ‰ ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div id="errorMessage" class="alert alert-danger d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText"></span>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
    <div id="searchResults" class="d-none">
        <div class="row mb-3">
            <div class="col-12">
                <h4>ê²€ìƒ‰ ê²°ê³¼</h4>
                <p class="text-muted" id="resultSummary"></p>
            </div>
        </div>

        <div id="apartmentsByDong"></div>
    </div>
</div>

<!-- ì•„íŒŒíŠ¸ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="apartmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="addToFavorites()">
                    <i class="fas fa-heart me-1"></i>ê´€ì‹¬ë‹¨ì§€ ë“±ë¡
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentRegionCode = null;
let currentRegionName = null;
let allApartments = [];
let currentSelectedApartment = null;

// êµ°/êµ¬ ëª©ë¡ ë¡œë“œ
function loadDistricts() {
    const city = document.getElementById('citySelect').value;
    const districtSelect = document.getElementById('districtSelect');
    const dongSelect = document.getElementById('dongSelect');
    const searchBtn = document.getElementById('searchBtn');

    console.log('ì‹œ/ë„ ì„ íƒ:', city);

    // í•˜ìœ„ í•„ë“œ ì´ˆê¸°í™”
    districtSelect.innerHTML = '<option value="">êµ°/êµ¬ ì„ íƒ</option>';
    districtSelect.disabled = true;
    dongSelect.innerHTML = '<option value="">ë²•ì •ë™ ì„ íƒ</option>';
    dongSelect.disabled = true;
    searchBtn.disabled = true;
    hideResults();

    if (!city) return;

    console.log('êµ°/êµ¬ ëª©ë¡ ë¡œë“œ ì‹œì‘:', city);

    fetch(`/api/districts/${encodeURIComponent(city)}`)
        .then(response => response.json())
        .then(data => {
            console.log('êµ°/êµ¬ API ì‘ë‹µ:', data);

            if (data.success && data.districts) {
                data.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.name;
                    option.textContent = `${district.name} (${district.code})`;
                    districtSelect.appendChild(option);
                });

                districtSelect.disabled = false;
                console.log('êµ°/êµ¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.districts.length + 'ê°œ');
            } else {
                showError('êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('êµ°/êµ¬ ë¡œë“œ ì˜¤ë¥˜:', error);
            showError('êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ë²•ì •ë™ ëª©ë¡ ë¡œë“œ
function loadDongs() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const dongSelect = document.getElementById('dongSelect');
    const searchBtn = document.getElementById('searchBtn');

    console.log('êµ°/êµ¬ ì„ íƒ:', district);

    // ë²•ì •ë™ í•„ë“œ ì´ˆê¸°í™”
    dongSelect.innerHTML = '<option value="">ë²•ì •ë™ ì„ íƒ</option>';
    dongSelect.disabled = true;
    searchBtn.disabled = true;
    hideResults();

    if (!city || !district) return;

    console.log('ë²•ì •ë™ ëª©ë¡ ë¡œë“œ ì‹œì‘ (dong_codeì—ì„œ íŒŒì‹±):', city, district);

    // dong_code_active.txtì—ì„œ ë²•ì •ë™ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (API í˜¸ì¶œ ì—†ìŒ)
    fetch(`/api/dongs/${encodeURIComponent(city)}/${encodeURIComponent(district)}`)
        .then(response => response.json())
        .then(data => {
            console.log('ë²•ì •ë™ API ì‘ë‹µ:', data);

            if (data.success && data.dongs) {
                data.dongs.forEach(dong => {
                    const option = document.createElement('option');
                    option.value = dong.name;
                    option.textContent = dong.name;
                    dongSelect.appendChild(option);
                });

                dongSelect.disabled = false;
                console.log('ë²•ì •ë™ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data.dongs.length + 'ê°œ');
            } else {
                showError('ë²•ì •ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('ë²•ì •ë™ ë¡œë“œ ì˜¤ë¥˜:', error);
            showError('ë²•ì •ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”
function enableSearchButton() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const dong = document.getElementById('dongSelect').value;
    const searchBtn = document.getElementById('searchBtn');

    console.log('ë²•ì •ë™ ì„ íƒ:', dong);

    if (city && district && dong) {
        searchBtn.disabled = false;
        console.log('ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”ë¨');
    } else {
        searchBtn.disabled = true;
        console.log('ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”ë¨');
    }

    hideResults();
}

// ì•„íŒŒíŠ¸ ê²€ìƒ‰ ì‹¤í–‰
function performSearch() {
    console.log('ğŸš€ performSearch() í•¨ìˆ˜ ì‹œì‘');

    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const dong = document.getElementById('dongSelect').value;
    const searchType = 'all'; // í†µí•© ê²€ìƒ‰ìœ¼ë¡œ ê³ ì •

    console.log('ğŸ“ ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', { city, district, dong, searchType });

    if (!city || !district || !dong) {
        console.warn('âš ï¸ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½');
        showError('ì‹œ/ë„, êµ°/êµ¬, ë²•ì •ë™ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    console.log('ğŸ”„ UI ìƒíƒœ ë³€ê²½ ì‹œì‘');
    showProgressBar();
    hideError();
    hideResults();
    console.log('âœ… UI ìƒíƒœ ë³€ê²½ ì™„ë£Œ');

    // ì§„í–‰ë¥  ê¸°ë°˜ ê²€ìƒ‰ ì‹œì‘
    searchAbortController = new AbortController();

    // ì´ˆê¸° ì§„í–‰ë¥  ì„¤ì •
    initializeProgress(36); // ê¸°ë³¸ 36ê°œì›”

    fetch('/api/search/with-progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            city: city,
            district: district,
            dong: dong,
            search_type: searchType,
            months: 36
        }),
        signal: searchAbortController.signal
    })
    .then(response => response.json())
    .then(data => {
        console.log('ì§„í–‰ë¥  ê²€ìƒ‰ API ì‘ë‹µ:', data);

        if (data.success) {
            const searchId = data.search_id;

            // ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§ ì‹œì‘
            monitorSearchProgress(searchId, city, district, dong);
        } else {
            hideProgressBar();
            showError(data.message || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        if (error.name !== 'AbortError') {
            hideProgressBar();
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            showError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });
}

// ê²€ìƒ‰ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§
function monitorSearchProgress(searchId, city, district, dong) {
    console.log('ğŸ” ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§ ì‹œì‘:', searchId);

    const interval = setInterval(() => {
        if (searchAbortController && searchAbortController.signal.aborted) {
            console.log('ğŸ›‘ ê²€ìƒ‰ì´ ì·¨ì†Œë˜ì–´ ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨');
            clearInterval(interval);
            return;
        }

        console.log('ğŸ“¡ ì§„í–‰ë¥  ì¡°íšŒ ì¤‘...', searchId);
        fetch(`/api/search/progress/${searchId}`)
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“¡ ì§„í–‰ë¥  API ì‘ë‹µ:', data);

                if (data.success && data.progress) {
                    const progress = data.progress;
                    updateProgress(
                        progress.completed,
                        progress.total,
                        progress.current_month,
                        progress.total_data,
                        progress.message
                    );

                    // 100% ì™„ë£Œì‹œ ê²°ê³¼ ì¡°íšŒ
                    if (progress.percentage >= 100) {
                        console.log('ğŸ‰ ê²€ìƒ‰ ì™„ë£Œ! ê²°ê³¼ ì¡°íšŒ ì‹œì‘');
                        clearInterval(interval);
                        fetchSearchResult(searchId, city, district, dong);
                    }
                } else {
                    console.warn('âš ï¸ ì§„í–‰ë¥  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤:', data);
                }
            })
            .catch(error => {
                console.error('âŒ ì§„í–‰ë¥  ì¡°íšŒ ì˜¤ë¥˜:', error);
            });
    }, 1000); // 1ì´ˆë§ˆë‹¤ ì§„í–‰ë¥  í™•ì¸
}

// ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ
function fetchSearchResult(searchId, city, district, dong) {
    fetch(`/api/search/result/${searchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.result) {
                const result = data.result;

                currentRegionCode = result.region_code;
                currentRegionName = `${city} ${district} ${dong}`;
                allApartments = result.apartment_list || [];

                // ì§„í–‰ë¥  ì™„ë£Œ í‘œì‹œ
                completeProgress();

                setTimeout(() => {
                    hideProgressBar();
                    displaySearchResults({
                        ...result,
                        dong_name: dong
                    });
                }, 1000); // 1ì´ˆ í›„ ê²°ê³¼ í‘œì‹œ
            } else {
                hideProgressBar();
                showError('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            hideProgressBar();
            console.error('ê²°ê³¼ ì¡°íšŒ ì˜¤ë¥˜:', error);
            showError('ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function displaySearchResults(response) {
    const totalCount = response.total_count || 0;
    const apartmentCount = allApartments.length;
    const dongName = response.dong_name || '';
    const searchType = response.search_type || 'sale';
    const searchTypeName = searchType === 'sale' ? 'ë§¤ë§¤' : 'ì „ì›”ì„¸';

    document.getElementById('resultSummary').textContent =
        `${currentRegionName} (${searchTypeName}): ${apartmentCount}ê°œ ì•„íŒŒíŠ¸, ${totalCount.toLocaleString()}ê±´ ê±°ë˜ê¸°ë¡`;

    displayApartmentsByDong(allApartments);
    document.getElementById('searchResults').classList.remove('d-none');
}

// ë™ë³„ ì•„íŒŒíŠ¸ ëª©ë¡ í‘œì‹œ
function displayApartmentsByDong(apartments) {
    console.log('ğŸ¢ ì•„íŒŒíŠ¸ í‘œì‹œ:', apartments.length + 'ê°œ');
    console.log('ğŸ” ì²« ë²ˆì§¸ ì•„íŒŒíŠ¸ ë°ì´í„°:', apartments[0]);

    let filteredApartments = apartments;

    // ë™ë³„ë¡œ ê·¸ë£¹í™”
    const apartmentsByDong = {};
    filteredApartments.forEach(apt => {
        console.log('ğŸ  ì•„íŒŒíŠ¸ ì²˜ë¦¬:', apt.apt_name, 'dong_list:', apt.dong_list);
        if (apt.dong_list && apt.dong_list.length > 0) {
            apt.dong_list.forEach(dong => {
                if (!apartmentsByDong[dong]) {
                    apartmentsByDong[dong] = [];
                }
                apartmentsByDong[dong].push(apt);
            });
        } else {
            console.warn('âš ï¸ dong_listê°€ ì—†ëŠ” ì•„íŒŒíŠ¸:', apt.apt_name, apt);
        }
    });

    console.log('ğŸ“ ë™ë³„ ê·¸ë£¹í™” ê²°ê³¼:', apartmentsByDong);

    // HTML ìƒì„±
    let html = '';
    const dongNames = Object.keys(apartmentsByDong).sort();

    dongNames.forEach(dong => {
        const dongApartments = apartmentsByDong[dong];
        html += `
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>${dong}
                        <span class="badge bg-primary ms-2">${dongApartments.length}ê°œ</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
        `;

        dongApartments.forEach(apt => {
            const avgPrice = formatPrice(Math.round(apt.avg_price));
            const priceRange = `${formatPrice(Math.round(apt.min_price))} ~ ${formatPrice(Math.round(apt.max_price))}`;

            // ì „ì›”ì„¸ ì—¬ë¶€ì— ë”°ë¥¸ ë¼ë²¨ ë³€ê²½
            const isRent = apt.is_rent || false;
            const priceLabel = isRent ? 'í‰ê·  ë³´ì¦ê¸ˆ' : 'í‰ê·  ê±°ë˜ê°€';
            const rangeLabel = isRent ? 'ë³´ì¦ê¸ˆ ë²”ìœ„' : 'ê±°ë˜ê°€ ë²”ìœ„';

            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 apartment-card" style="cursor: pointer;"
                         data-apt-name="${apt.apt_name}" data-region-code="${apt.region_code}"
                         onclick="showApartmentDetailFromData(this)">
                        <div class="card-body">
                            <h6 class="card-title text-primary">${apt.apt_name}</h6>
                            <p class="card-text small">
                                <i class="fas fa-calendar me-1"></i>ì¤€ê³µ: ${apt.build_year}ë…„<br>
                                <i class="fas fa-chart-line me-1"></i>${priceLabel}: ${avgPrice}<br>
                                <i class="fas fa-arrows-alt-h me-1"></i>${rangeLabel}: ${priceRange}<br>
                                <i class="fas fa-exchange-alt me-1"></i>ì´ ${apt.transaction_count}ê±´
                                (ë§¤ë§¤ ${apt.sale_count || 0}ê±´, ì „ì›”ì„¸ ${apt.rent_count || 0}ê±´)
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                    </div>
                </div>
            </div>
        `;
    });

    if (html === '') {
        html = '<div class="alert alert-warning">ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ì•„íŒŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    document.getElementById('apartmentsByDong').innerHTML = html;
}

// ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ
function showApartmentDetail(aptName, regionCode) {
    console.log('ğŸ¢ ì•„íŒŒíŠ¸ ìƒì„¸ ìš”ì²­:', aptName, 'ì§€ì—­ì½”ë“œ:', regionCode);

    currentSelectedApartment = { name: aptName, regionCode: regionCode };
    document.getElementById('modalTitle').textContent = aptName + ' - ê±°ë˜ê¸°ë¡';
    document.getElementById('modalBody').innerHTML =
        '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

    const modal = new bootstrap.Modal(document.getElementById('apartmentModal'));
    modal.show();

    const requestData = {
        region_code: regionCode,
        apt_name: aptName
    };
    console.log('ğŸ“¡ Step3 ìš”ì²­ ë°ì´í„°:', requestData);

    fetch('/api/search/step3', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('ğŸ“Š Step3 ì‘ë‹µ:', data);
        if (data.success) {
            console.log(`âœ… ê±°ë˜ê¸°ë¡ ${data.transactions?.length || 0}ê±´ ì¡°íšŒ`);
            displayTransactionHistory(data.transactions || []);
        } else {
            console.error('âŒ ê±°ë˜ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨:', data.message);
            document.getElementById('modalBody').innerHTML =
                '<div class="alert alert-danger">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    })
    .catch(error => {
        console.error('ê±°ë˜ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('modalBody').innerHTML =
            '<div class="alert alert-danger">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    });
}

// ë°ì´í„° ì†ì„±ì„ ì‚¬ìš©í•œ ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ (íŠ¹ìˆ˜ë¬¸ì ì•ˆì „)
function showApartmentDetailFromData(element) {
    const aptName = element.getAttribute('data-apt-name');
    const regionCode = element.getAttribute('data-region-code');
    showApartmentDetail(aptName, regionCode);
}

// ê±°ë˜ê¸°ë¡ í‘œì‹œ
function displayTransactionHistory(transactions) {
    if (transactions.length === 0) {
        document.getElementById('modalBody').innerHTML =
            '<div class="alert alert-info">ê±°ë˜ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    // ê±°ë˜ íƒ€ì… í™•ì¸ (ì „ì›”ì„¸ì¸ì§€ ë§¤ë§¤ì¸ì§€)
    const isRentTransaction = transactions.length > 0 && transactions[0].transaction_type !== undefined;

    let html = `
        <div class="mb-3">
            <h6>ìµœê·¼ ê±°ë˜ê¸°ë¡ (${transactions.length}ê±´)</h6>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>ê±°ë˜ì¼</th>`;

    if (isRentTransaction) {
        html += `
                        <th>ê±°ë˜ìœ í˜•</th>`;
    } else {
        // ë§¤ë§¤ ê±°ë˜ëŠ” ê¸°ë³¸ ì»¬ëŸ¼ë§Œ í‘œì‹œ
    }

    html += `
                        <th>ë©´ì (ã¡)</th>
                        <th>ì¸µ</th>
                        <th>ê±°ë˜ê°€ê²©</th>
                    </tr>
                </thead>
                <tbody>
    `;

    transactions.forEach(tx => {
        const price = formatPrice(tx.deal_amount);

        if (isRentTransaction) {
            // ì „ì›”ì„¸ ê±°ë˜ìš© ì»¬ëŸ¼ (ê¸°ë³¸ ì •ë³´ë§Œ)
            const transactionType = tx.transaction_type || '-';

            html += `
                <tr>
                    <td>${tx.deal_date}</td>
                    <td>${transactionType}</td>
                    <td>${tx.exclusive_area}</td>
                    <td>${tx.floor}ì¸µ</td>
                    <td class="text-primary fw-bold">${price}</td>
                </tr>
            `;
        } else {
            // ë§¤ë§¤ ê±°ë˜ìš© ì»¬ëŸ¼ (ê¸°ë³¸ ì •ë³´ë§Œ)
            html += `
                <tr>
                    <td>${tx.deal_date}</td>
                    <td>${tx.exclusive_area}</td>
                    <td>${tx.floor}ì¸µ</td>
                    <td class="text-primary fw-bold">${price}</td>
                </tr>
            `;
        }
    });

    html += '</tbody></table></div>';
    document.getElementById('modalBody').innerHTML = html;
}

// ê´€ì‹¬ë‹¨ì§€ ë“±ë¡
function addToFavorites() {
    if (!currentSelectedApartment) return;

    const aptData = allApartments.find(apt => apt.apt_name === currentSelectedApartment.name);
    if (!aptData) return;

    fetch('/api/favorites', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            apt_name: aptData.apt_name,
            region_code: aptData.region_code,
            region_name: currentRegionName,
            build_year: aptData.build_year,
            avg_price: Math.round(aptData.avg_price),
            min_price: Math.round(aptData.min_price),
            max_price: Math.round(aptData.max_price),
            transaction_count: aptData.transaction_count
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('ê´€ì‹¬ë‹¨ì§€ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            bootstrap.Modal.getInstance(document.getElementById('apartmentModal')).hide();
        } else {
            alert(data.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('ê´€ì‹¬ë‹¨ì§€ ë“±ë¡ ì˜¤ë¥˜:', error);
        alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// í¼ ì´ˆê¸°í™”
function resetForm() {
    document.getElementById('citySelect').value = '';
    document.getElementById('districtSelect').innerHTML = '<option value="">êµ°/êµ¬ ì„ íƒ</option>';
    document.getElementById('districtSelect').disabled = true;
    document.getElementById('dongSelect').innerHTML = '<option value="">ë²•ì •ë™ ì„ íƒ</option>';
    document.getElementById('dongSelect').disabled = true;
    document.getElementById('searchBtn').disabled = true;

    hideError();
    hideResults();

    currentRegionCode = null;
    currentRegionName = null;
    allApartments = [];

    console.log('í¼ ì´ˆê¸°í™” ì™„ë£Œ');
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function formatPrice(amount) {
    if (amount >= 10000) {
        const eok = Math.floor(amount / 10000);
        const man = amount % 10000;
        if (man === 0) {
            return `${eok.toLocaleString()}ì–µì›`;
        } else {
            return `${eok.toLocaleString()}ì–µ ${man.toLocaleString()}ë§Œì›`;
        }
    } else {
        return `${amount.toLocaleString()}ë§Œì›`;
    }
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.remove('d-none');
}

function hideError() {
    document.getElementById('errorMessage').classList.add('d-none');
}

function showProgressBar() {
    console.log('ğŸ”„ showProgressBar() í˜¸ì¶œë¨');

    // ê¸°ë³¸ ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
    $('.loading-spinner').hide();

    const loadingElement = document.getElementById('loadingSpinner');
    if (loadingElement) {
        loadingElement.classList.remove('d-none');
        loadingElement.style.display = 'block';
        loadingElement.style.visibility = 'visible';
        console.log('âœ… í”„ë¡œê·¸ë ˆìŠ¤ë°” í‘œì‹œë¨ - í´ë˜ìŠ¤:', loadingElement.className);
        console.log('âœ… í”„ë¡œê·¸ë ˆìŠ¤ë°” ìŠ¤íƒ€ì¼:', loadingElement.style.display);

        // ìŠ¤í¬ë¡¤í•´ì„œ ë³´ì´ë„ë¡
        loadingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        console.error('âŒ loadingSpinner ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
}

function hideProgressBar() {
    console.log('ğŸ”„ hideProgressBar() í˜¸ì¶œë¨');
    const loadingElement = document.getElementById('loadingSpinner');
    if (loadingElement) {
        loadingElement.classList.add('d-none');
        console.log('âœ… í”„ë¡œê·¸ë ˆìŠ¤ë°” ìˆ¨ê²¨ì§');
    } else {
        console.error('âŒ loadingSpinner ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }

    // ê¸°ë³¸ ë¡œë”© ìŠ¤í”¼ë„ˆë„ ìˆ¨ê¸°ê¸°
    $('.loading-spinner').hide();
}

function hideResults() {
    document.getElementById('searchResults').classList.add('d-none');
}

// ìºì‹œ ì´ˆê¸°í™” í•¨ìˆ˜
function clearCache() {
    if (!confirm('ìºì‹œ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê²€ìƒ‰ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
        return;
    }

    fetch('/api/database/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: 'cache' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('ìºì‹œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        showToast('ìºì‹œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

// ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í•¨ìˆ˜
function clearDatabase() {
    if (!confirm('ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê±°ë˜ ë°ì´í„°ì™€ ìºì‹œê°€ ì‚­ì œë©ë‹ˆë‹¤.\n(ê´€ì‹¬ë‹¨ì§€ëŠ” ë¹„í™œì„±í™”ë©ë‹ˆë‹¤)')) {
        return;
    }

    fetch('/api/database/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ type: 'all' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            hideResults();
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        showToast('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

// í”„ë¡œê·¸ë ˆìŠ¤ë°” ê´€ë ¨ í•¨ìˆ˜ë“¤
let searchAbortController = null;

function initializeProgress(totalMonths) {
    console.log('ğŸš€ í”„ë¡œê·¸ë ˆìŠ¤ë°” ì´ˆê¸°í™”:', totalMonths);

    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const progressText = document.getElementById('progressText');
    const completedMonths = document.getElementById('completedMonths');
    const totalMonthsElement = document.getElementById('totalMonths');
    const totalData = document.getElementById('totalData');
    const currentMonth = document.getElementById('currentMonth');

    if (!progressBar) {
        console.error('âŒ progressBar ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    progressPercent.textContent = '0%';
    progressText.textContent = 'ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
    completedMonths.textContent = '0';
    totalMonthsElement.textContent = totalMonths;
    totalData.textContent = '0ê±´';
    currentMonth.textContent = '-';

    console.log('âœ… í”„ë¡œê·¸ë ˆìŠ¤ë°” ì´ˆê¸°í™” ì™„ë£Œ');
}

function updateProgress(completedMonths, totalMonths, currentMonth, totalData, currentProgressText) {
    const percentage = Math.round((completedMonths / totalMonths) * 100);

    console.log('ğŸ“Š í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸:', {
        completedMonths,
        totalMonths,
        percentage,
        currentMonth,
        totalData,
        currentProgressText
    });

    const progressBar = document.getElementById('progressBar');
    if (!progressBar) {
        console.error('âŒ progressBar ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
    }

    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    document.getElementById('progressPercent').textContent = percentage + '%';
    document.getElementById('progressText').textContent = currentProgressText || `${completedMonths}/${totalMonths} ê°œì›” ì²˜ë¦¬ ì™„ë£Œ`;
    document.getElementById('completedMonths').textContent = completedMonths;
    document.getElementById('totalMonths').textContent = totalMonths;
    document.getElementById('totalData').textContent = totalData.toLocaleString() + 'ê±´';
    document.getElementById('currentMonth').textContent = currentMonth || '-';

    console.log('âœ… í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

function completeProgress() {
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', '100');
    document.getElementById('progressPercent').textContent = '100%';
    document.getElementById('progressText').textContent = 'ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
    document.getElementById('progressBar').classList.remove('progress-bar-animated');
    document.getElementById('progressBar').classList.add('bg-success');
}

function cancelSearch() {
    if (searchAbortController) {
        searchAbortController.abort();
        hideProgressBar();
        showError('ê²€ìƒ‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
}

console.log('ê²€ìƒ‰ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
</script>

<style>
.apartment-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* í”„ë¡œê·¸ë ˆìŠ¤ë°” ê°•ì œ í‘œì‹œ */
#loadingSpinner {
    z-index: 9999 !important;
    position: relative !important;
}

#loadingSpinner .card {
    border: 2px solid #007bff !important;
    background-color: #ffffff !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

#progressBar {
    transition: width 0.3s ease-in-out !important;
}
</style>

{% endblock %}