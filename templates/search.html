{% extends "base.html" %}

{% block title %}아파트 검색 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-search text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">아파트 검색</h1>
                <p class="text-muted mb-0">지역과 아파트명으로 실거래가 정보를 검색하세요</p>
            </div>
        </div>
    </div>
</div>

<!-- 검색 폼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>검색 조건
                </h5>
            </div>
            <div class="card-body">
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-2">
                            <label for="citySelect" class="form-label">시/도</label>
                            <select class="form-select" id="citySelect" required>
                                <option value="">시/도 선택</option>
                                {% for city in cities %}
                                <option value="{{ city }}">{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="districtSelect" class="form-label">군/구</label>
                            <select class="form-select" id="districtSelect" required disabled>
                                <option value="">군/구 선택</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="aptNameInput" class="form-label">아파트명 (선택사항)</label>
                            <input type="text" class="form-control" id="aptNameInput" 
                                   placeholder="예: 래미안, 힐스테이트">
                        </div>
                        <div class="col-md-2">
                            <label for="startDate" class="form-label">시작일</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-2">
                            <label for="endDate" class="form-label">종료일</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="periodType" id="periodMonths" value="months" checked>
                                <label class="form-check-label" for="periodMonths">
                                    기간별 조회
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="periodType" id="periodDate" value="date">
                                <label class="form-check-label" for="periodDate">
                                    날짜별 조회
                                </label>
                            </div>
                            <div class="form-check form-check-inline ms-3">
                                <select class="form-select form-select-sm d-inline-block w-auto" id="monthsSelect">
                                    <option value="3">최근 3개월</option>
                                    <option value="6" selected>최근 6개월</option>
                                    <option value="12">최근 12개월</option>
                                    <option value="24">최근 24개월</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 스피너 -->
<div id="loadingSpinner" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">검색 중...</span>
    </div>
    <p class="mt-2">실거래가 데이터를 검색하고 있습니다...</p>
</div>

<!-- 검색 결과 -->
<div id="searchResults" class="d-none">
    <!-- 데모 데이터 경고 -->
    <div class="alert alert-warning d-none" id="demoDataWarning">
        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> 데모 데이터 표시 중</h5>
        <p class="mb-0">현재 국토교통부 API 서버에 연결할 수 없어 데모 데이터를 표시하고 있습니다. 실제 서비스에서는 실시간 실거래가 데이터가 제공됩니다.</p>
    </div>

    <!-- 검색 요약 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>검색 결과 요약
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="searchSummary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 아파트 목록 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>검색 결과
                    </h5>
                    <div>
                        <button class="btn btn-outline-success btn-sm me-2" onclick="exportToCSV()">
                            <i class="fas fa-download me-1"></i>CSV 내보내기
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleView()">
                            <i class="fas fa-th-list me-1"></i>목록 보기
                        </button>
                    </div>
                </div>
                
                <!-- 탭 네비게이션 -->
                <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dong-tab" data-bs-toggle="tab" data-bs-target="#dong-pane" type="button" role="tab">
                            <i class="fas fa-map-marker-alt me-1"></i>법정동별
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="month-tab" data-bs-toggle="tab" data-bs-target="#month-pane" type="button" role="tab">
                            <i class="fas fa-calendar-alt me-1"></i>월별
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="apartment-tab" data-bs-toggle="tab" data-bs-target="#apartment-pane" type="button" role="tab">
                            <i class="fas fa-building me-1"></i>아파트별
                        </button>
                    </li>
                </ul>
                
                <!-- 탭 콘텐츠 -->
                <div class="tab-content" id="resultTabContent">
                    <!-- 법정동별 탭 -->
                    <div class="tab-pane fade show active" id="dong-pane" role="tabpanel">
                        <div class="card-body" id="dongContent">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>
                    
                    <!-- 월별 탭 -->
                    <div class="tab-pane fade" id="month-pane" role="tabpanel">
                        <div class="card-body" id="monthContent">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>
                    
                    <!-- 아파트별 탭 -->
                    <div class="tab-pane fade" id="apartment-pane" role="tabpanel">
                        <div class="card-body" id="apartmentContent">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 오류 메시지 -->
<div id="errorMessage" class="alert alert-danger d-none">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> 검색 오류</h5>
    <p id="errorText" class="mb-0"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
let searchData = [];
let currentClassifiedData = null;

$(document).ready(function() {
    // 기본 날짜 설정
    setDefaultDates();
    
    // 검색 폼 제출
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        performSearch();
    });

    // 초기화 버튼
    $('#clearBtn').on('click', function() {
        $('#searchForm')[0].reset();
        $('#districtSelect').prop('disabled', true).find('option:not(:first)').remove();
        $('#searchResults').addClass('d-none');
        $('#errorMessage').addClass('d-none');
        setDefaultDates();
    });

    // 시/도 변경 이벤트
    $('#citySelect').on('change', function() {
        const city = $(this).val();
        // 군/구 선택값 초기화
        $('#districtSelect').val('').prop('disabled', true);
        loadDistricts(city);
        // 검색 결과 초기화
        clearSearchResults();
    });

    // 군/구 변경 이벤트
    $('#districtSelect').on('change', function() {
        // 검색 결과 초기화
        clearSearchResults();
    });

    // 아파트명 입력 이벤트
    $('#aptNameInput').on('input', function() {
        // 검색 결과 초기화
        clearSearchResults();
    });

    // 기간 타입 변경 이벤트
    $('input[name="periodType"]').on('change', function() {
        const periodType = $(this).val();
        if (periodType === 'months') {
            $('#monthsSelect').show();
            $('#startDate, #endDate').hide();
        } else {
            $('#monthsSelect').hide();
            $('#startDate, #endDate').show();
        }
        // 검색 결과 초기화
        clearSearchResults();
    });

    // 개월 수 변경 이벤트
    $('#monthsSelect').on('change', function() {
        clearSearchResults();
    });

    // 날짜 변경 이벤트
    $('#startDate, #endDate').on('change', function() {
        clearSearchResults();
    });

    // 초기 상태 설정
    $('#monthsSelect').show();
    $('#startDate, #endDate').hide();
});

function setDefaultDates() {
    const today = new Date();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(today.getMonth() - 6);
    
    $('#endDate').val(today.toISOString().split('T')[0]);
    $('#startDate').val(sixMonthsAgo.toISOString().split('T')[0]);
}

function clearSearchResults() {
    console.log('검색 결과 초기화 시작');
    
    // 검색 결과 숨기기
    $('#searchResults').addClass('d-none');
    $('#errorMessage').addClass('d-none');
    $('#demoDataWarning').addClass('d-none');
    
    // 검색 결과 영역 초기화
    $('#searchSummary').empty();
    
    // searchData 전역 변수 초기화
    searchData = [];
    currentClassifiedData = null;
    
    // 각 탭 콘텐츠 초기화
    $('#dongContent').empty();
    $('#monthContent').empty();
    $('#apartmentContent').empty();
    
    // 아코디언 요소들 제거
    $('#dongAccordion').remove();
    $('#monthAccordion').remove();
    $('#apartmentAccordion').remove();
    console.log('모든 아코디언 요소 제거');
    
    console.log('검색 결과 초기화 완료');
}

function formatPrice(amount) {
    // 만원 단위를 억원 단위로 변환하여 표시
    if (amount >= 10000) {
        const eok = Math.floor(amount / 10000);
        const man = amount % 10000;
        if (man === 0) {
            return `${eok.toLocaleString()}억원`;
        } else {
            return `${eok.toLocaleString()}억 ${man.toLocaleString()}만원`;
        }
    } else {
        return `${amount.toLocaleString()}만원`;
    }
}

function loadDistricts(city) {
    if (!city) {
        $('#districtSelect').prop('disabled', true).find('option:not(:first)').remove();
        return;
    }

    $.get(`/api/districts/${encodeURIComponent(city)}`)
        .done(function(response) {
            const select = $('#districtSelect');
            select.find('option:not(:first)').remove();
            select.val(''); // 선택값 초기화

            if (response.success && response.districts) {
                response.districts.forEach(district => {
                    select.append(`<option value="${district.name}">${district.name}</option>`);
                });
                select.prop('disabled', false);
            } else {
                console.error('군/구 목록 불러오기 실패:', response.message);
            }
        })
        .fail(function(xhr, status, error) {
            console.error('군/구 API 호출 실패:', error);
            showToast('군/구 목록을 불러올 수 없습니다.', 'error');
        });
}

function performSearch() {
    const city = $('#citySelect').val();
    const district = $('#districtSelect').val();
    const aptName = $('#aptNameInput').val().trim();
    const periodType = $('input[name="periodType"]:checked').val();
    
    if (!city || !district) {
        showToast('시/도와 군/구를 모두 선택해주세요.', 'warning');
        return;
    }

    // 기간 설정
    let months = 6;
    let startDate = '';
    let endDate = '';
    
    if (periodType === 'months') {
        months = parseInt($('#monthsSelect').val());
    } else {
        startDate = $('#startDate').val();
        endDate = $('#endDate').val();
        
        if (!startDate || !endDate) {
            showToast('시작일과 종료일을 모두 선택해주세요.', 'warning');
            return;
        }
        
        // 날짜 차이로 개월 수 계산
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        months = Math.ceil(diffDays / 30);
    }

    $('#loadingSpinner').removeClass('d-none');
    $('#searchResults').addClass('d-none');
    $('#errorMessage').addClass('d-none');

    const requestData = {
        city: city,
        district: district,
        apt_name: aptName,
        months: months
    };

    if (periodType === 'date') {
        requestData.start_date = startDate;
        requestData.end_date = endDate;
    }

    $.ajax({
        url: '/api/search',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function(response) {
            $('#loadingSpinner').addClass('d-none');

            console.log('API 응답:', response);
            console.log('응답 데이터 길이:', response.data ? response.data.length : 0);

            if (response.success) {
                searchData = response.data;
                console.log('searchData 설정 완료, 길이:', searchData.length);
                displaySearchResults(response);
                
                // 데모 데이터 여부 확인
                if (response.is_demo) {
                    showToast(`${response.total_count}건의 아파트를 찾았습니다. (데모 데이터)`, 'warning');
                } else {
                    showToast(`${response.total_count}건의 아파트를 찾았습니다.`, 'success');
                }
            } else {
                showError(response.message);
            }
        },
        error: function(xhr, status, error) {
            $('#loadingSpinner').addClass('d-none');
            showError('검색 중 오류가 발생했습니다.');
        }
    });
}

function displaySearchResults(response) {
    console.log('displaySearchResults 호출됨');
    console.log('response:', response);
    
    // 데모 데이터 경고 표시
    if (response.is_demo) {
        $('#demoDataWarning').removeClass('d-none');
    } else {
        $('#demoDataWarning').addClass('d-none');
    }

    // 지역코드 필터링 확인 (추가 안전장치)
    const expectedRegionCode = response.region_code;
    if (expectedRegionCode && response.data) {
        const originalLength = response.data.length;
        response.data = response.data.filter(tx => tx.region_code === expectedRegionCode);
        console.log(`지역코드 필터링: ${expectedRegionCode}, 원본: ${originalLength}, 필터링 후: ${response.data.length}`);
    }

    // 요약 정보 표시
    console.log('요약 정보 표시 시작');
    displaySearchSummary(response);

    // 법정동별 분류된 결과 표시
    if (response.classified_data) {
        console.log('법정동별 분류 결과 표시');
        displayClassifiedResults(response.classified_data);
    } else {
        console.log('아파트 목록 표시');
        // 기존 방식으로 아파트 목록 표시
        displayApartmentList(response.data);
    }

    console.log('검색 결과 영역 표시');
    $('#searchResults').removeClass('d-none');
}

function displaySearchSummary(response) {
    const regionName = response.region_name;
    const totalCount = response.total_count;
    
    // 아파트별 통계 계산
    const apartmentStats = {};
    response.data.forEach(tx => {
        const key = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentStats[key]) {
            apartmentStats[key] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                transactions: [],
                build_year: tx.build_year
            };
        }
        apartmentStats[key].transactions.push(tx);
    });

    const apartmentCount = Object.keys(apartmentStats).length;
    const avgPrice = response.data.length > 0 ? 
        response.data.reduce((sum, tx) => sum + tx.price_per_area, 0) / response.data.length : 0;

    const summaryHtml = `
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-primary mb-0">${regionName}</div>
                <small class="text-muted">검색 지역</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-success mb-0">${apartmentCount}</div>
                <small class="text-muted">검색된 아파트</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-info mb-0">${totalCount}</div>
                <small class="text-muted">총 거래건수</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-warning mb-0">${Math.round(avgPrice / 10000).toLocaleString()}</div>
                <small class="text-muted">평균 평당가격 (만원)</small>
            </div>
        </div>
    `;
    $('#searchSummary').html(summaryHtml);
}

function displayClassifiedResults(classifiedData) {
    console.log('displayClassifiedResults 호출됨, classifiedData:', classifiedData);
    
    // 분류된 데이터를 전역 변수에 저장
    currentClassifiedData = classifiedData;
    
    // 법정동별 탭에 데이터 표시
    displayDongTab(classifiedData);
    
    // 월별 탭에 데이터 표시
    displayMonthTab(searchData);
    
    // 아파트별 탭에 데이터 표시
    displayApartmentTab(searchData);
}

function displayDongTab(classifiedData) {
    console.log('법정동별 탭 표시 시작');
    
    const container = $('#dongContent');
    container.empty();
    
    // 지역코드 필터링 (추가 안전장치)
    const expectedRegionCode = searchData.length > 0 ? searchData[0].region_code : null;
    console.log('expectedRegionCode:', expectedRegionCode);
    
    let html = '<div class="accordion" id="dongAccordion">';
    
    Object.entries(classifiedData).forEach(([dongName, dongData], index) => {
        console.log(`동 처리 중: ${dongName}, 데이터:`, dongData);
        const accordionId = `dong-${index}`;
        const collapseId = `collapse-${index}`;
        
        // 해당 동의 모든 거래 데이터 수집
        const dongTransactions = [];
        Object.values(dongData.months).forEach(monthData => {
            dongTransactions.push(...monthData.transactions);
        });
        
        // 월별 및 아파트별 필터 옵션 생성
        const monthOptions = Object.keys(dongData.months).sort().reverse();
        const apartmentOptions = [...new Set(dongTransactions.map(tx => tx.apt_name))].sort();
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${dongName}</strong>
                                <span class="badge bg-primary ms-2">${dongData.total_count}건</span>
                            </div>
                            <div class="text-muted small">
                                ${Object.keys(dongData.months).length}개월 거래
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="heading-${index}" data-bs-parent="#dongAccordion">
                    <div class="accordion-body">
                        <!-- 필터 섹션 -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-calendar-alt me-1"></i>월별 필터</label>
                                <select class="form-select form-select-sm" id="monthFilter-${index}" onchange="filterDongData('${dongName}', 'month', this.value, ${index})">
                                    <option value="">전체 월</option>
                                    ${monthOptions.map(month => {
                                        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
                                        return `<option value="${month}">${monthName}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-building me-1"></i>아파트별 필터</label>
                                <select class="form-select form-select-sm" id="apartmentFilter-${index}" onchange="filterDongData('${dongName}', 'apartment', this.value, ${index})">
                                    <option value="">전체 아파트</option>
                                    ${apartmentOptions.map(apt => `<option value="${apt}">${apt}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetDongFilter(${index})">
                                    <i class="fas fa-undo me-1"></i>필터 초기화
                                </button>
                            </div>
                        </div>
                        
                        <!-- 필터링된 결과 표시 영역 -->
                        <div id="filteredContent-${index}">
                            ${generateMonthSections(dongData.months, expectedRegionCode)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // DOM에 강제로 적용
    console.log('HTML 적용 시작, 길이:', html.length);
    container.html(html);
    console.log('HTML 적용 완료');
    
    // DOM 업데이트 강제 실행
    container.trigger('DOMNodeInserted');
    console.log('DOM 업데이트 이벤트 트리거');
    
    // Bootstrap accordion 초기화
    console.log('Bootstrap accordion 초기화 시작');
    
    // DOM 업데이트를 기다리는 함수
    const waitForAccordion = (attempts = 0) => {
        const accordionElement = document.getElementById('dongAccordion');
        console.log(`Accordion 요소 찾기 시도 ${attempts + 1}, 결과:`, accordionElement);
        
        if (accordionElement) {
            console.log('Accordion 요소 찾음, 초기화 시도');
            // 첫 번째 accordion item을 열어둠
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
                console.log('첫 번째 아코디언 아이템 열기 완료');
            } else {
                console.log('첫 번째 collapse 요소를 찾을 수 없음');
            }
        } else if (attempts < 10) {
            // 최대 10번까지 재시도 (총 1초)
            setTimeout(() => waitForAccordion(attempts + 1), 100);
        } else {
            console.log('Accordion 요소를 찾을 수 없음 - 최대 재시도 횟수 초과');
            // 디버깅을 위해 컨테이너 내용 확인
            console.log('컨테이너 내용:', container.html());
        }
    };
    
    // 즉시 첫 번째 시도
    waitForAccordion();
}

function generateMonthSections(months, expectedRegionCode = null) {
    let html = '';
    
    // 월별로 정렬 (최신순)
    const sortedMonths = Object.entries(months).sort((a, b) => {
        const [yearA, monthA] = a[0].replace('년', '').replace('월', '').split(' ');
        const [yearB, monthB] = b[0].replace('년', '').replace('월', '').split(' ');
        return (parseInt(yearB) * 12 + parseInt(monthB)) - (parseInt(yearA) * 12 + parseInt(monthA));
    });
    
    sortedMonths.forEach(([monthKey, monthData]) => {
        html += `
            <div class="mb-4">
                <h5 class="text-primary border-bottom pb-2">
                    ${monthData.month_display}
                    <span class="badge bg-success ms-2">${monthData.count}건</span>
                    <span class="badge bg-warning text-dark ms-1">
                        평균 ${formatPrice(Math.round(monthData.avg_price))}/㎡
                    </span>
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            최저: ${formatPrice(Math.round(monthData.min_price))}/㎡
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">
                            최고: ${formatPrice(Math.round(monthData.max_price))}/㎡
                        </small>
                    </div>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>아파트명</th>
                                <th>거래일</th>
                                <th>층수</th>
                                <th>면적</th>
                                <th>거래가</th>
                                <th>평당가격</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // 거래일 기준으로 정렬 (최신순)
        let sortedTransactions = monthData.transactions.sort((a, b) => 
            new Date(b.deal_date) - new Date(a.deal_date)
        );
        
        // 지역코드 필터링 (추가 안전장치)
        if (expectedRegionCode) {
            sortedTransactions = sortedTransactions.filter(tx => tx.region_code === expectedRegionCode);
        }
        
        sortedTransactions.forEach(tx => {
            html += `
                <tr>
                    <td>
                        <strong>${tx.apt_name}</strong>
                        ${tx.apt_dong ? `<br><small class="text-muted">${tx.apt_dong}</small>` : ''}
                        <br><small class="text-muted">${tx.build_year}년</small>
                    </td>
                    <td>${tx.deal_date}</td>
                    <td>${tx.floor}층</td>
                    <td>${tx.exclusive_area}㎡</td>
                    <td><strong>${formatPrice(tx.deal_amount)}</strong></td>
                    <td>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    return html;
}

function displayApartmentList(data) {
    console.log('displayApartmentList 호출됨, 데이터 길이:', data.length);
    
    const tbody = $('#apartmentTable tbody');
    tbody.empty();

    // 지역코드 필터링 (추가 안전장치)
    const expectedRegionCode = data.length > 0 ? data[0].region_code : null;
    if (expectedRegionCode) {
        const originalLength = data.length;
        data = data.filter(tx => tx.region_code === expectedRegionCode);
        console.log(`아파트 목록 지역코드 필터링: ${expectedRegionCode}, 원본: ${originalLength}, 필터링 후: ${data.length}`);
    }

    // 아파트별 통계 계산
    const apartmentStats = {};
    data.forEach(tx => {
        const key = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentStats[key]) {
            apartmentStats[key] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                region_name: tx.region_name,
                transactions: [],
                build_year: tx.build_year
            };
        }
        apartmentStats[key].transactions.push(tx);
    });

    // 평균 가격 기준으로 정렬
    const sortedApartments = Object.values(apartmentStats).sort((a, b) => {
        const avgA = a.transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / a.transactions.length;
        const avgB = b.transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / b.transactions.length;
        return avgB - avgA;
    });

    console.log('아파트 통계 계산 완료, 아파트 수:', sortedApartments.length);
    console.log('아파트 목록:', sortedApartments.map(apt => apt.name));

    sortedApartments.forEach(apt => {
        const avgPrice = apt.transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / apt.transactions.length;
        const latestTx = apt.transactions.sort((a, b) => new Date(b.deal_date) - new Date(a.deal_date))[0];
        
        const row = `
            <tr>
                <td><strong>${apt.name}</strong></td>
                <td>${apt.region_name}</td>
                <td>${apt.build_year}년</td>
                <td>${latestTx.deal_date}</td>
                <td><strong>${Math.round(avgPrice / 10000).toLocaleString()}만원</strong></td>
                <td><span class="badge bg-primary">${apt.transactions.length}</span></td>
                <td>
                    <i class="fas fa-heart favorite-btn" 
                       onclick="toggleFavorite('${apt.name}', '${apt.region_code}', false)"
                       title="관심단지 추가"></i>
                </td>
                <td>
                    <a href="/apartment/${encodeURIComponent(apt.name)}/${apt.region_code}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-line me-1"></i>상세보기
                    </a>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function showError(message) {
    $('#errorText').text(message);
    $('#errorMessage').removeClass('d-none');
}

function exportToCSV() {
    if (searchData.length === 0) {
        showToast('내보낼 데이터가 없습니다.', 'warning');
        return;
    }

    // CSV 헤더
    const headers = ['아파트명', '지역', '거래일', '거래금액', '전용면적', '평당가격', '층', '건축년도'];
    
    // CSV 데이터
    const csvData = searchData.map(tx => [
        tx.apt_name,
        tx.region_name,
        tx.deal_date,
        tx.deal_amount,
        tx.exclusive_area,
        Math.round(tx.price_per_area / 10000),
        tx.floor,
        tx.build_year
    ]);

    // CSV 문자열 생성
    const csvContent = [headers, ...csvData]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');

    // 파일 다운로드
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `apartment_data_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('CSV 파일이 다운로드되었습니다.', 'success');
}

function displayMonthTab(data) {
    console.log('월별 탭 표시 시작, 데이터 길이:', data.length);
    
    const container = $('#monthContent');
    container.empty();
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">표시할 데이터가 없습니다.</div>');
        return;
    }
    
    // 월별로 데이터 그룹핑
    const monthlyData = {};
    data.forEach(tx => {
        const monthKey = `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = [];
        }
        monthlyData[monthKey].push(tx);
    });
    
    // 월별로 정렬 (최신순)
    const sortedMonths = Object.keys(monthlyData).sort().reverse();
    
    // 전체 아파트 목록 수집 (필터용)
    const allApartments = [...new Set(data.map(tx => tx.apt_name))].sort();
    
    let html = `
        <!-- 월별 탭 필터 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-building me-1"></i>아파트별 필터</label>
                <select class="form-select form-select-sm" id="monthTabApartmentFilter" onchange="filterMonthTabData(this.value)">
                    <option value="">전체 아파트</option>
                    ${allApartments.map(apt => `<option value="${apt}">${apt}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetMonthTabFilter()">
                    <i class="fas fa-undo me-1"></i>필터 초기화
                </button>
            </div>
        </div>
        
        <!-- 필터 상태 표시 -->
        <div class="alert alert-info alert-sm mb-3" id="monthTabFilterStatus">
            <i class="fas fa-info-circle me-1"></i>
            <span id="monthTabFilterStatusText">필터가 적용되지 않음</span>
        </div>
        
        <div class="accordion" id="monthAccordion">`;
    
    sortedMonths.forEach((month, index) => {
        const monthData = monthlyData[month];
        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
        const collapseId = `month-collapse-${index}`;
        
        // 월별 통계 계산
        const totalCount = monthData.length;
        const avgPrice = monthData.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...monthData.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...monthData.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="month-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${monthName}</strong>
                                <span class="badge bg-success ms-2">${totalCount}건</span>
                            </div>
                            <div class="text-muted small">
                                평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="month-heading-${index}" data-bs-parent="#monthAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>아파트명</th>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthData.map(tx => `
                                        <tr>
                                            <td><strong>${tx.apt_name}</strong></td>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('monthAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

function displayApartmentTab(data) {
    console.log('아파트별 탭 표시 시작, 데이터 길이:', data.length);
    
    const container = $('#apartmentContent');
    container.empty();
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">표시할 데이터가 없습니다.</div>');
        return;
    }
    
    // 아파트별로 데이터 그룹핑
    const apartmentData = {};
    data.forEach(tx => {
        const aptKey = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentData[aptKey]) {
            apartmentData[aptKey] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                region_name: tx.region_name,
                build_year: tx.build_year,
                transactions: []
            };
        }
        apartmentData[aptKey].transactions.push(tx);
    });
    
    // 거래건수 기준으로 정렬
    const sortedApartments = Object.values(apartmentData).sort((a, b) => b.transactions.length - a.transactions.length);
    
    // 전체 월 목록 수집 (필터용)
    const allMonths = [...new Set(data.map(tx => `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`))].sort().reverse();
    
    let html = `
        <!-- 아파트별 탭 필터 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-calendar-alt me-1"></i>월별 필터</label>
                <select class="form-select form-select-sm" id="apartmentTabMonthFilter" onchange="filterApartmentTabData(this.value)">
                    <option value="">전체 월</option>
                    ${allMonths.map(month => {
                        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
                        return `<option value="${month}">${monthName}</option>`;
                    }).join('')}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetApartmentTabFilter()">
                    <i class="fas fa-undo me-1"></i>필터 초기화
                </button>
            </div>
        </div>
        
        <!-- 필터 상태 표시 -->
        <div class="alert alert-info alert-sm mb-3" id="apartmentTabFilterStatus">
            <i class="fas fa-info-circle me-1"></i>
            <span id="apartmentTabFilterStatusText">필터가 적용되지 않음</span>
        </div>
        
        <div class="accordion" id="apartmentAccordion">`;
    
    sortedApartments.forEach((apt, index) => {
        const collapseId = `apt-collapse-${index}`;
        const totalCount = apt.transactions.length;
        
        // 아파트별 통계 계산
        const avgPrice = apt.transactions.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...apt.transactions.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...apt.transactions.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="apt-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${apt.name}</strong>
                                <span class="badge bg-primary ms-2">${totalCount}건</span>
                                <small class="text-muted ms-2">(${apt.build_year}년)</small>
                            </div>
                            <div class="text-muted small">
                                평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="apt-heading-${index}" data-bs-parent="#apartmentAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">거래 내역</h6>
                            <div>
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleFavorite('${apt.name}', '${apt.region_code}', false)">
                                    <i class="fas fa-heart me-1"></i>관심단지 추가
                                </button>
                                <a href="/apartment/${encodeURIComponent(apt.name)}/${apt.region_code}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-chart-line me-1"></i>상세보기
                                </a>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${apt.transactions.sort((a, b) => new Date(b.deal_date) - new Date(a.deal_date)).map(tx => `
                                        <tr>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('apartmentAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

// 법정동별 필터링 함수들
function filterDongData(dongName, filterType, filterValue, dongIndex) {
    console.log(`필터링: ${dongName}, 타입: ${filterType}, 값: ${filterValue}`);
    
    // 해당 동의 원본 데이터 찾기
    const classifiedData = getCurrentClassifiedData();
    if (!classifiedData || !classifiedData[dongName]) {
        console.log('해당 동의 데이터를 찾을 수 없음');
        return;
    }
    
    const dongData = classifiedData[dongName];
    let filteredData = { ...dongData };
    
    if (filterType === 'month' && filterValue) {
        // 월별 필터링
        filteredData.months = { [filterValue]: dongData.months[filterValue] };
        filteredData.total_count = dongData.months[filterValue] ? dongData.months[filterValue].transactions.length : 0;
    } else if (filterType === 'apartment' && filterValue) {
        // 아파트별 필터링
        const filteredMonths = {};
        Object.entries(dongData.months).forEach(([month, monthData]) => {
            const filteredTransactions = monthData.transactions.filter(tx => tx.apt_name === filterValue);
            if (filteredTransactions.length > 0) {
                filteredMonths[month] = {
                    ...monthData,
                    transactions: filteredTransactions,
                    count: filteredTransactions.length
                };
            }
        });
        filteredData.months = filteredMonths;
        filteredData.total_count = Object.values(filteredMonths).reduce((sum, month) => sum + month.count, 0);
    }
    
    // 필터링된 결과 표시
    const container = $(`#filteredContent-${dongIndex}`);
    const expectedRegionCode = searchData.length > 0 ? searchData[0].region_code : null;
    container.html(generateMonthSections(filteredData.months, expectedRegionCode));
    
    // 필터 상태 표시
    updateFilterStatus(dongIndex, filterType, filterValue);
}

function resetDongFilter(dongIndex) {
    console.log(`필터 초기화: 동 인덱스 ${dongIndex}`);
    
    // 필터 선택값 초기화
    $(`#monthFilter-${dongIndex}`).val('');
    $(`#apartmentFilter-${dongIndex}`).val('');
    
    // 원본 데이터로 복원
    const classifiedData = getCurrentClassifiedData();
    const dongNames = Object.keys(classifiedData);
    const dongName = dongNames[dongIndex];
    
    if (dongName && classifiedData[dongName]) {
        const dongData = classifiedData[dongName];
        const container = $(`#filteredContent-${dongIndex}`);
        const expectedRegionCode = searchData.length > 0 ? searchData[0].region_code : null;
        container.html(generateMonthSections(dongData.months, expectedRegionCode));
        
        // 필터 상태 초기화
        updateFilterStatus(dongIndex, '', '');
    }
}

function updateFilterStatus(dongIndex, filterType, filterValue) {
    const statusContainer = $(`#filterStatus-${dongIndex}`);
    if (statusContainer.length === 0) {
        // 상태 표시 영역이 없으면 생성
        const statusHtml = `
            <div class="alert alert-info alert-sm mb-3" id="filterStatus-${dongIndex}">
                <i class="fas fa-info-circle me-1"></i>
                <span id="filterStatusText-${dongIndex}">필터가 적용되지 않음</span>
            </div>
        `;
        $(`#filteredContent-${dongIndex}`).before(statusHtml);
    }
    
    let statusText = '필터가 적용되지 않음';
    if (filterType === 'month' && filterValue) {
        const monthName = `${filterValue.substring(0, 4)}년 ${filterValue.substring(5, 7)}월`;
        statusText = `월별 필터 적용: ${monthName}`;
    } else if (filterType === 'apartment' && filterValue) {
        statusText = `아파트별 필터 적용: ${filterValue}`;
    }
    
    $(`#filterStatusText-${dongIndex}`).text(statusText);
}

function getCurrentClassifiedData() {
    // 전역 변수에 저장된 분류된 데이터가 있으면 반환
    if (currentClassifiedData) {
        return currentClassifiedData;
    }
    
    // 전역 변수가 없으면 searchData를 다시 분류하여 반환
    if (searchData.length === 0) return null;
    
    const classified = {};
    searchData.forEach(tx => {
        const dongName = tx.umd_nm || '기타';
        if (!classified[dongName]) {
            classified[dongName] = {
                dong_name: dongName,
                months: {},
                total_count: 0
            };
        }
        
        const monthKey = `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`;
        if (!classified[dongName].months[monthKey]) {
            classified[dongName].months[monthKey] = {
                month: monthKey,
                transactions: [],
                count: 0,
                min_price: Infinity,
                max_price: 0
            };
        }
        
        classified[dongName].months[monthKey].transactions.push(tx);
        classified[dongName].months[monthKey].count++;
        classified[dongName].total_count++;
        
        // 가격 범위 업데이트
        const price = tx.price_per_area || 0;
        if (price < classified[dongName].months[monthKey].min_price) {
            classified[dongName].months[monthKey].min_price = price;
        }
        if (price > classified[dongName].months[monthKey].max_price) {
            classified[dongName].months[monthKey].max_price = price;
        }
    });
    
    // 무한대 처리
    Object.values(classified).forEach(dongData => {
        Object.values(dongData.months).forEach(monthData => {
            if (monthData.min_price === Infinity) {
                monthData.min_price = 0;
            }
        });
    });
    
    return classified;
}

// 월별 탭 필터링 함수들
function filterMonthTabData(apartmentName) {
    console.log('월별 탭 필터링:', apartmentName);
    
    if (!apartmentName) {
        // 필터 초기화
        displayMonthTab(searchData);
        return;
    }
    
    // 해당 아파트의 거래만 필터링
    const filteredData = searchData.filter(tx => tx.apt_name === apartmentName);
    
    // 필터링된 데이터로 월별 탭 다시 표시
    displayMonthTabWithFilter(filteredData, apartmentName);
}

function displayMonthTabWithFilter(data, filterName) {
    console.log('필터링된 월별 탭 표시:', filterName, '데이터 길이:', data.length);
    
    const container = $('#monthContent');
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">해당 아파트의 거래 데이터가 없습니다.</div>');
        return;
    }
    
    // 월별로 데이터 그룹핑
    const monthlyData = {};
    data.forEach(tx => {
        const monthKey = `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = [];
        }
        monthlyData[monthKey].push(tx);
    });
    
    // 월별로 정렬 (최신순)
    const sortedMonths = Object.keys(monthlyData).sort().reverse();
    
    let html = `
        <!-- 월별 탭 필터 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-building me-1"></i>아파트별 필터</label>
                <select class="form-select form-select-sm" id="monthTabApartmentFilter" onchange="filterMonthTabData(this.value)">
                    <option value="">전체 아파트</option>
                    ${[...new Set(searchData.map(tx => tx.apt_name))].sort().map(apt => 
                        `<option value="${apt}" ${apt === filterName ? 'selected' : ''}>${apt}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetMonthTabFilter()">
                    <i class="fas fa-undo me-1"></i>필터 초기화
                </button>
            </div>
        </div>
        
        <!-- 필터 상태 표시 -->
        <div class="alert alert-info alert-sm mb-3" id="monthTabFilterStatus">
            <i class="fas fa-info-circle me-1"></i>
            <span id="monthTabFilterStatusText">아파트별 필터 적용: ${filterName}</span>
        </div>
        
        <div class="accordion" id="monthAccordion">`;
    
    sortedMonths.forEach((month, index) => {
        const monthData = monthlyData[month];
        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
        const collapseId = `month-collapse-${index}`;
        
        // 월별 통계 계산
        const totalCount = monthData.length;
        const avgPrice = monthData.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...monthData.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...monthData.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="month-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${monthName}</strong>
                                <span class="badge bg-success ms-2">${totalCount}건</span>
                            </div>
                            <div class="text-muted small">
                                평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="month-heading-${index}" data-bs-parent="#monthAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>아파트명</th>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthData.map(tx => `
                                        <tr>
                                            <td><strong>${tx.apt_name}</strong></td>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('monthAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

function resetMonthTabFilter() {
    console.log('월별 탭 필터 초기화');
    displayMonthTab(searchData);
}

// 아파트별 탭 필터링 함수들
function filterApartmentTabData(monthValue) {
    console.log('아파트별 탭 필터링:', monthValue);
    
    if (!monthValue) {
        // 필터 초기화
        displayApartmentTab(searchData);
        return;
    }
    
    // 해당 월의 거래만 필터링
    const filteredData = searchData.filter(tx => {
        const monthKey = `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`;
        return monthKey === monthValue;
    });
    
    // 필터링된 데이터로 아파트별 탭 다시 표시
    displayApartmentTabWithFilter(filteredData, monthValue);
}

function displayApartmentTabWithFilter(data, filterMonth) {
    console.log('필터링된 아파트별 탭 표시:', filterMonth, '데이터 길이:', data.length);
    
    const container = $('#apartmentContent');
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">해당 월의 거래 데이터가 없습니다.</div>');
        return;
    }
    
    // 아파트별로 데이터 그룹핑
    const apartmentData = {};
    data.forEach(tx => {
        const aptKey = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentData[aptKey]) {
            apartmentData[aptKey] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                region_name: tx.region_name,
                build_year: tx.build_year,
                transactions: []
            };
        }
        apartmentData[aptKey].transactions.push(tx);
    });
    
    // 거래건수 기준으로 정렬
    const sortedApartments = Object.values(apartmentData).sort((a, b) => b.transactions.length - a.transactions.length);
    
    const monthName = `${filterMonth.substring(0, 4)}년 ${filterMonth.substring(5, 7)}월`;
    
    let html = `
        <!-- 아파트별 탭 필터 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-calendar-alt me-1"></i>월별 필터</label>
                <select class="form-select form-select-sm" id="apartmentTabMonthFilter" onchange="filterApartmentTabData(this.value)">
                    <option value="">전체 월</option>
                    ${[...new Set(searchData.map(tx => `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`))].sort().reverse().map(month => {
                        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
                        return `<option value="${month}" ${month === filterMonth ? 'selected' : ''}>${monthName}</option>`;
                    }).join('')}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetApartmentTabFilter()">
                    <i class="fas fa-undo me-1"></i>필터 초기화
                </button>
            </div>
        </div>
        
        <!-- 필터 상태 표시 -->
        <div class="alert alert-info alert-sm mb-3" id="apartmentTabFilterStatus">
            <i class="fas fa-info-circle me-1"></i>
            <span id="apartmentTabFilterStatusText">월별 필터 적용: ${monthName}</span>
        </div>
        
        <div class="accordion" id="apartmentAccordion">`;
    
    sortedApartments.forEach((apt, index) => {
        const collapseId = `apt-collapse-${index}`;
        const totalCount = apt.transactions.length;
        
        // 아파트별 통계 계산
        const avgPrice = apt.transactions.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...apt.transactions.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...apt.transactions.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="apt-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${apt.name}</strong>
                                <span class="badge bg-primary ms-2">${totalCount}건</span>
                                <small class="text-muted ms-2">(${apt.build_year}년)</small>
                            </div>
                            <div class="text-muted small">
                                평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="apt-heading-${index}" data-bs-parent="#apartmentAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">거래 내역</h6>
                            <div>
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleFavorite('${apt.name}', '${apt.region_code}', false)">
                                    <i class="fas fa-heart me-1"></i>관심단지 추가
                                </button>
                                <a href="/apartment/${encodeURIComponent(apt.name)}/${apt.region_code}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-chart-line me-1"></i>상세보기
                                </a>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${apt.transactions.sort((a, b) => new Date(b.deal_date) - new Date(a.deal_date)).map(tx => `
                                        <tr>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('apartmentAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

function resetApartmentTabFilter() {
    console.log('아파트별 탭 필터 초기화');
    displayApartmentTab(searchData);
}
</script>
{% endblock %}
