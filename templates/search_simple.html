{% extends "base.html" %}

{% block title %}아파트 검색 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-search me-2"></i>아파트 검색</h1>
            <p class="text-muted">지역을 선택하여 실거래가 정보를 검색하세요</p>
        </div>
    </div>

    <!-- 검색 폼 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">검색 조건</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="citySelect" class="form-label">시/도</label>
                            <select class="form-select" id="citySelect" onchange="loadDistricts()">
                                <option value="">시/도 선택</option>
                                {% for city in cities %}
                                <option value="{{ city }}">{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="districtSelect" class="form-label">군/구</label>
                            <select class="form-select" id="districtSelect" disabled onchange="enableSearchButton()">
                                <option value="">군/구 선택</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="dongFilter" class="form-label">법정동 (선택)</label>
                            <select class="form-select" id="dongFilter" disabled>
                                <option value="">전체 법정동</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <br>
                            <button type="button" class="btn btn-primary" id="searchBtn" disabled onclick="performSearch()">
                                <i class="fas fa-search me-1"></i>검색
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 로딩 -->
    <div id="loadingSpinner" class="text-center d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">검색 중...</span>
        </div>
        <p class="mt-2">검색 중입니다...</p>
    </div>

    <!-- 에러 메시지 -->
    <div id="errorMessage" class="alert alert-danger d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText"></span>
    </div>

    <!-- 검색 결과 -->
    <div id="searchResults" class="d-none">
        <div class="row mb-3">
            <div class="col-12">
                <h4>검색 결과</h4>
                <p class="text-muted" id="resultSummary"></p>
            </div>
        </div>

        <div id="apartmentsByDong"></div>
    </div>
</div>

<!-- 아파트 상세 모달 -->
<div class="modal fade" id="apartmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 아파트 상세 정보 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="addToFavorites()">
                    <i class="fas fa-heart me-1"></i>관심단지 등록
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 변수
let currentRegionCode = null;
let currentRegionName = null;
let allApartments = [];
let currentSelectedApartment = null;

// 군/구 목록 로드
function loadDistricts() {
    const city = document.getElementById('citySelect').value;
    const districtSelect = document.getElementById('districtSelect');
    const dongFilter = document.getElementById('dongFilter');
    const searchBtn = document.getElementById('searchBtn');

    console.log('시/도 선택:', city);

    // 하위 필드 초기화
    districtSelect.innerHTML = '<option value="">군/구 선택</option>';
    districtSelect.disabled = true;
    dongFilter.innerHTML = '<option value="">전체 법정동</option>';
    dongFilter.disabled = true;
    searchBtn.disabled = true;
    hideResults();

    if (!city) return;

    console.log('군/구 목록 로드 시작:', city);

    fetch(`/api/districts/${encodeURIComponent(city)}`)
        .then(response => response.json())
        .then(data => {
            console.log('군/구 API 응답:', data);

            if (data.success && data.districts) {
                data.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.name;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });

                districtSelect.disabled = false;
                console.log('군/구 목록 로드 완료:', data.districts.length + '개');
            } else {
                showError('군/구 목록을 불러오는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('군/구 로드 오류:', error);
            showError('군/구 목록을 불러오는 중 오류가 발생했습니다.');
        });
}

// 검색 버튼 활성화
function enableSearchButton() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;
    const searchBtn = document.getElementById('searchBtn');

    console.log('군/구 선택:', district);

    if (city && district) {
        searchBtn.disabled = false;
        console.log('검색 버튼 활성화됨');
    } else {
        searchBtn.disabled = true;
        console.log('검색 버튼 비활성화됨');
    }

    hideResults();
}

// 아파트 검색 실행
function performSearch() {
    const city = document.getElementById('citySelect').value;
    const district = document.getElementById('districtSelect').value;

    console.log('검색 실행:', city, district);

    if (!city || !district) {
        showError('시/도와 군/구를 모두 선택해주세요.');
        return;
    }

    showLoading();
    hideError();
    hideResults();

    fetch('/api/search/step1', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            city: city,
            district: district
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        console.log('검색 API 응답:', data);

        if (data.success) {
            currentRegionCode = data.region_code;
            currentRegionName = `${city} ${district}`;
            allApartments = data.apartment_list || [];

            setupDongFilter(data.dong_list || []);
            displaySearchResults(data);
        } else {
            showError(data.message || '검색 중 오류가 발생했습니다.');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('검색 오류:', error);
        showError('검색 중 오류가 발생했습니다.');
    });
}

// 법정동 필터 설정
function setupDongFilter(dongList) {
    const dongFilter = document.getElementById('dongFilter');
    dongFilter.innerHTML = '<option value="">전체 법정동</option>';

    dongList.forEach(dong => {
        const option = document.createElement('option');
        option.value = dong;
        option.textContent = dong;
        dongFilter.appendChild(option);
    });

    dongFilter.disabled = false;
    dongFilter.onchange = function() {
        const selectedDong = this.value;
        console.log('법정동 필터:', selectedDong);
        displayApartmentsByDong(allApartments, selectedDong);
    };
}

// 검색 결과 표시
function displaySearchResults(response) {
    const totalCount = response.total_count || 0;
    const apartmentCount = allApartments.length;
    const dongCount = (response.dong_list || []).length;

    document.getElementById('resultSummary').textContent =
        `${currentRegionName}: ${apartmentCount}개 아파트, ${dongCount}개 법정동, ${totalCount.toLocaleString()}건 거래기록`;

    displayApartmentsByDong(allApartments);
    document.getElementById('searchResults').classList.remove('d-none');
}

// 동별 아파트 목록 표시
function displayApartmentsByDong(apartments, selectedDong = '') {
    console.log('동별 아파트 표시:', apartments.length + '개');

    let filteredApartments = apartments;
    if (selectedDong) {
        filteredApartments = apartments.filter(apt =>
            apt.dong_list && apt.dong_list.includes(selectedDong)
        );
    }

    // 동별로 그룹화
    const apartmentsByDong = {};
    filteredApartments.forEach(apt => {
        if (apt.dong_list && apt.dong_list.length > 0) {
            apt.dong_list.forEach(dong => {
                if (!apartmentsByDong[dong]) {
                    apartmentsByDong[dong] = [];
                }
                apartmentsByDong[dong].push(apt);
            });
        }
    });

    // HTML 생성
    let html = '';
    const dongNames = Object.keys(apartmentsByDong).sort();

    dongNames.forEach(dong => {
        const dongApartments = apartmentsByDong[dong];
        html += `
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>${dong}
                        <span class="badge bg-primary ms-2">${dongApartments.length}개</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
        `;

        dongApartments.forEach(apt => {
            const avgPrice = formatPrice(Math.round(apt.avg_price / 10000));
            const priceRange = `${formatPrice(Math.round(apt.min_price / 10000))} ~ ${formatPrice(Math.round(apt.max_price / 10000))}`;

            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 apartment-card" style="cursor: pointer;"
                         onclick="showApartmentDetail('${apt.apt_name}', '${apt.region_code}')">
                        <div class="card-body">
                            <h6 class="card-title text-primary">${apt.apt_name}</h6>
                            <p class="card-text small">
                                <i class="fas fa-calendar me-1"></i>준공: ${apt.build_year}년<br>
                                <i class="fas fa-chart-line me-1"></i>평균: ${avgPrice}<br>
                                <i class="fas fa-arrows-alt-h me-1"></i>범위: ${priceRange}<br>
                                <i class="fas fa-exchange-alt me-1"></i>거래: ${apt.transaction_count}건
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                    </div>
                </div>
            </div>
        `;
    });

    if (html === '') {
        html = '<div class="alert alert-warning">선택한 조건에 해당하는 아파트가 없습니다.</div>';
    }

    document.getElementById('apartmentsByDong').innerHTML = html;
}

// 아파트 상세 정보 표시
function showApartmentDetail(aptName, regionCode) {
    console.log('아파트 상세:', aptName);

    currentSelectedApartment = { name: aptName, regionCode: regionCode };
    document.getElementById('modalTitle').textContent = aptName + ' - 거래기록';
    document.getElementById('modalBody').innerHTML =
        '<div class="text-center"><div class="spinner-border"></div><p class="mt-2">거래기록을 불러오는 중...</p></div>';

    const modal = new bootstrap.Modal(document.getElementById('apartmentModal'));
    modal.show();

    fetch('/api/search/step3', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            region_code: regionCode,
            apt_name: aptName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTransactionHistory(data.transactions || []);
        } else {
            document.getElementById('modalBody').innerHTML =
                '<div class="alert alert-danger">거래기록을 불러오는데 실패했습니다.</div>';
        }
    })
    .catch(error => {
        console.error('거래기록 로드 오류:', error);
        document.getElementById('modalBody').innerHTML =
            '<div class="alert alert-danger">거래기록을 불러오는 중 오류가 발생했습니다.</div>';
    });
}

// 거래기록 표시
function displayTransactionHistory(transactions) {
    if (transactions.length === 0) {
        document.getElementById('modalBody').innerHTML =
            '<div class="alert alert-info">거래기록이 없습니다.</div>';
        return;
    }

    let html = `
        <div class="mb-3">
            <h6>최근 거래기록 (${transactions.length}건)</h6>
        </div>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>거래일</th>
                        <th>면적(㎡)</th>
                        <th>층</th>
                        <th>거래가격</th>
                    </tr>
                </thead>
                <tbody>
    `;

    transactions.forEach(tx => {
        const price = formatPrice(tx.deal_amount);
        html += `
            <tr>
                <td>${tx.deal_date}</td>
                <td>${tx.exclusive_area}</td>
                <td>${tx.floor}층</td>
                <td class="text-primary fw-bold">${price}</td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    document.getElementById('modalBody').innerHTML = html;
}

// 관심단지 등록
function addToFavorites() {
    if (!currentSelectedApartment) return;

    const aptData = allApartments.find(apt => apt.apt_name === currentSelectedApartment.name);
    if (!aptData) return;

    fetch('/api/favorites', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            apt_name: aptData.apt_name,
            region_code: aptData.region_code,
            region_name: currentRegionName,
            build_year: aptData.build_year,
            avg_price: Math.round(aptData.avg_price),
            min_price: Math.round(aptData.min_price),
            max_price: Math.round(aptData.max_price),
            transaction_count: aptData.transaction_count
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('관심단지로 등록되었습니다.');
            bootstrap.Modal.getInstance(document.getElementById('apartmentModal')).hide();
        } else {
            alert(data.message || '등록에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('관심단지 등록 오류:', error);
        alert('등록 중 오류가 발생했습니다.');
    });
}

// 폼 초기화
function resetForm() {
    document.getElementById('citySelect').value = '';
    document.getElementById('districtSelect').innerHTML = '<option value="">군/구 선택</option>';
    document.getElementById('districtSelect').disabled = true;
    document.getElementById('dongFilter').innerHTML = '<option value="">전체 법정동</option>';
    document.getElementById('dongFilter').disabled = true;
    document.getElementById('searchBtn').disabled = true;

    hideError();
    hideResults();

    currentRegionCode = null;
    currentRegionName = null;
    allApartments = [];

    console.log('폼 초기화 완료');
}

// 유틸리티 함수들
function formatPrice(amount) {
    if (amount >= 10000) {
        const eok = Math.floor(amount / 10000);
        const man = amount % 10000;
        if (man === 0) {
            return `${eok.toLocaleString()}억원`;
        } else {
            return `${eok.toLocaleString()}억 ${man.toLocaleString()}만원`;
        }
    } else {
        return `${amount.toLocaleString()}만원`;
    }
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.remove('d-none');
}

function hideError() {
    document.getElementById('errorMessage').classList.add('d-none');
}

function showLoading() {
    document.getElementById('loadingSpinner').classList.remove('d-none');
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.add('d-none');
}

function hideResults() {
    document.getElementById('searchResults').classList.add('d-none');
}

console.log('검색 페이지 로드 완료');
</script>

<style>
.apartment-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

{% endblock %}