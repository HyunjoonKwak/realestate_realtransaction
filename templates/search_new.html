{% extends "base.html" %}

{% block title %}ì•„íŒŒíŠ¸ ê²€ìƒ‰ - ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-search text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">ì•„íŒŒíŠ¸ ê²€ìƒ‰</h1>
                <p class="text-muted mb-0">ì§€ì—­ì„ ì„ íƒí•˜ì—¬ ì‹¤ê±°ë˜ê°€ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</p>
            </div>
        </div>
    </div>
</div>

<!-- ê²€ìƒ‰ í¼ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>ê²€ìƒ‰ ì¡°ê±´
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 1ë‹¨ê³„: ì‹œ/ë„ ì„ íƒ -->
                    <div class="col-md-4">
                        <label for="citySelect" class="form-label">
                            <i class="fas fa-map-marked-alt me-1"></i>1ë‹¨ê³„: ì‹œ/ë„
                        </label>
                        <select class="form-select" id="citySelect">
                            <option value="">ì‹œ/ë„ ì„ íƒ</option>
                        </select>
                    </div>

                    <!-- 2ë‹¨ê³„: ì‹œ/êµ°/êµ¬ ì„ íƒ -->
                    <div class="col-md-4">
                        <label for="districtSelect" class="form-label">
                            <i class="fas fa-building me-1"></i>2ë‹¨ê³„: ì‹œ/êµ°/êµ¬
                        </label>
                        <select class="form-select" id="districtSelect" disabled>
                            <option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option>
                        </select>
                    </div>

                    <!-- 3ë‹¨ê³„: ì/ë©´/ë™ ì„ íƒ -->
                    <div class="col-md-4">
                        <label for="townSelect" class="form-label">
                            <i class="fas fa-home me-1"></i>3ë‹¨ê³„: ì/ë©´/ë™
                        </label>
                        <select class="form-select" id="townSelect" disabled>
                            <option value="">ì/ë©´/ë™ ì„ íƒ</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-primary btn-lg" id="searchBtn" disabled>
                            <i class="fas fa-search me-2"></i>ì•„íŒŒíŠ¸ ê²€ìƒ‰
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-2" id="clearBtn">
                            <i class="fas fa-undo me-2"></i>ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>ì‚¬ìš©ë²•:</strong> 1ë‹¨ê³„(ì‹œ/ë„) â†’ 2ë‹¨ê³„(ì‹œ/êµ°/êµ¬) â†’ 3ë‹¨ê³„(ì/ë©´/ë™) ìˆœì„œë¡œ ì„ íƒí•œ í›„ ê²€ìƒ‰í•˜ë©´ í•´ë‹¹ ì§€ì—­ì˜ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¡œë”© ë° ì—ëŸ¬ ë©”ì‹œì§€ -->
<div id="loadingSpinner" class="row d-none">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ê²€ìƒ‰ ì¤‘...</span>
        </div>
        <p class="mt-2">ì•„íŒŒíŠ¸ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>
</div>

<div id="errorMessage" class="row d-none">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
    </div>
</div>

<!-- ê²€ìƒ‰ ê²°ê³¼ -->
<div id="searchResults" class="d-none">
    <div class="row mb-3">
        <div class="col-12">
            <h4><i class="fas fa-building me-2"></i>ê²€ìƒ‰ ê²°ê³¼</h4>
            <p class="text-muted mb-0" id="resultSummary"></p>
        </div>
    </div>

    <!-- ë™ë³„ ì•„íŒŒíŠ¸ ëª©ë¡ -->
    <div id="apartmentsByDong"></div>
</div>

<!-- ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
<div class="modal fade" id="apartmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="addToFavoritesBtn">
                    <i class="fas fa-heart me-2"></i>ê´€ì‹¬ë‹¨ì§€ ë“±ë¡
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('3ë‹¨ê³„ ê²€ìƒ‰ í˜ì´ì§€ ì´ˆê¸°í™”');

    let currentRegionCode = null;
    let currentRegionName = null;
    let allApartments = [];
    let currentSelectedApartment = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œ/ë„ ëª©ë¡ ë¡œë“œ
    loadCities();

    // 1ë‹¨ê³„: ì‹œ/ë„ ì„ íƒ ì´ë²¤íŠ¸
    $('#citySelect').on('change', function() {
        const city = $(this).val();
        console.log('1ë‹¨ê³„ - ì‹œ/ë„ ë³€ê²½:', city);

        // í•˜ìœ„ í•„ë“œ ì´ˆê¸°í™”
        resetLowerFields();

        if (city) {
            loadDistricts(city);
        }
    });

    // 2ë‹¨ê³„: ì‹œ/êµ°/êµ¬ ì„ íƒ ì´ë²¤íŠ¸
    $('#districtSelect').on('change', function() {
        const city = $('#citySelect').val();
        const district = $(this).val();
        console.log('2ë‹¨ê³„ - ì‹œ/êµ°/êµ¬ ë³€ê²½:', district);

        // 3ë‹¨ê³„ í•„ë“œ ì´ˆê¸°í™”
        resetTownField();

        if (city && district) {
            loadTowns(city, district);
        }

        // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
        $('#searchResults').addClass('d-none');
        hideError();
    });

    // 3ë‹¨ê³„: ì/ë©´/ë™ ì„ íƒ ì´ë²¤íŠ¸
    $('#townSelect').on('change', function() {
        const city = $('#citySelect').val();
        const district = $('#districtSelect').val();
        const town = $(this).val();
        console.log('3ë‹¨ê³„ - ì/ë©´/ë™ ë³€ê²½:', town);

        // ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        if (city && district && town) {
            $('#searchBtn').prop('disabled', false);
            console.log('ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”');
        } else {
            $('#searchBtn').prop('disabled', true);
            console.log('ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”');
        }

        // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
        $('#searchResults').addClass('d-none');
        hideError();
    });

    // ë²•ì •ë™ í•„í„° ë³€ê²½ ì´ë²¤íŠ¸
    $('#dongFilter').on('change', function() {
        const selectedDong = $(this).val();
        console.log('ë²•ì •ë™ í•„í„° ë³€ê²½:', selectedDong);

        if (allApartments.length > 0) {
            displayApartmentsByDong(allApartments, selectedDong);
        }
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    $('#searchBtn').on('click', function() {
        performSearch();
    });

    // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­
    $('#clearBtn').on('click', function() {
        resetForm();
    });

    // ì‹œ/ë„ ëª©ë¡ ë¡œë“œ
    function loadCities() {
        console.log('ğŸš€ ì‹œ/ë„ ëª©ë¡ ë¡œë“œ ì‹œì‘');

        $.ajax({
            url: '/api/cities',
            method: 'GET',
            beforeSend: function() {
                console.log('ğŸ“¤ ì‹œ/ë„ API ìš”ì²­ ì „ì†¡ ì¤‘...');
            },
            success: function(response) {
                console.log('ğŸ“¨ ì‹œ/ë„ API ì‘ë‹µ ìˆ˜ì‹ :', response);
                if (response.success) {
                    const cities = response.cities;
                    console.log('ğŸ“‹ ë°›ì€ ì‹œ/ë„ ëª©ë¡:', cities);

                    const $citySelect = $('#citySelect');
                    $citySelect.find('option:not(:first)').remove();

                    cities.forEach((city, index) => {
                        const option = `<option value="${city.name}">${city.name}</option>`;
                        $citySelect.append(option);
                        console.log(`ğŸ“ ì‹œ/ë„ ì˜µì…˜ ì¶”ê°€ ${index + 1}/${cities.length}:`, city.name);
                    });

                    console.log('âœ… ì‹œ/ë„ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', cities.length + 'ê°œ');
                } else {
                    console.error('âŒ ì‹œ/ë„ API ì‘ë‹µ ì‹¤íŒ¨:', response.message);
                    showError('ì‹œ/ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },
            error: function(xhr, status, error) {
                console.error('ğŸ’¥ ì‹œ/ë„ API ì˜¤ë¥˜:', { xhr, status, error });
                showError('ì‹œ/ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // êµ°/êµ¬ ëª©ë¡ ë¡œë“œ
    function loadDistricts(city) {
        console.log('ğŸš€ êµ°/êµ¬ ëª©ë¡ ë¡œë“œ ì‹œì‘:', city);
        console.log('ğŸ”— API URL:', `/api/districts/${encodeURIComponent(city)}`);

        $.ajax({
            url: `/api/districts/${encodeURIComponent(city)}`,
            method: 'GET',
            beforeSend: function() {
                console.log('ğŸ“¤ êµ°/êµ¬ API ìš”ì²­ ì „ì†¡ ì¤‘...');
            },
            success: function(response) {
                console.log('ğŸ“¨ êµ°/êµ¬ API ì‘ë‹µ ìˆ˜ì‹ :', response);
                if (response.success) {
                    const districts = response.districts;
                    console.log('ğŸ“‹ ë°›ì€ êµ°/êµ¬ ëª©ë¡:', districts);

                    const $districtSelect = $('#districtSelect');
                    console.log('ğŸ¯ districtSelect ìš”ì†Œ:', $districtSelect.length);

                    $districtSelect.find('option:not(:first)').remove();
                    console.log('ğŸ§¹ ê¸°ì¡´ ì˜µì…˜ ì •ë¦¬ ì™„ë£Œ');

                    districts.forEach((district, index) => {
                        const option = `<option value="${district.name}">${district.name}</option>`;
                        $districtSelect.append(option);
                        console.log(`ğŸ“ ì˜µì…˜ ì¶”ê°€ ${index + 1}/${districts.length}:`, district.name);
                    });

                    $districtSelect.prop('disabled', false);
                    console.log('âœ… êµ°/êµ¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', districts.length + 'ê°œ');
                    console.log('ğŸ”“ districtSelect í™œì„±í™”ë¨');
                } else {
                    console.error('âŒ êµ°/êµ¬ API ì‘ë‹µ ì‹¤íŒ¨:', response.message);
                    showError('êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },
            error: function(xhr, status, error) {
                console.error('ğŸ’¥ êµ°/êµ¬ API ì˜¤ë¥˜:', { xhr, status, error });
                console.error('ğŸ“„ ì‘ë‹µ í…ìŠ¤íŠ¸:', xhr.responseText);
                showError('êµ°/êµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì/ë©´/ë™ ëª©ë¡ ë¡œë“œ
    function loadTowns(city, district) {
        console.log('ğŸš€ ì/ë©´/ë™ ëª©ë¡ ë¡œë“œ ì‹œì‘:', city, district);

        $.ajax({
            url: `/api/towns/${encodeURIComponent(city)}/${encodeURIComponent(district)}`,
            method: 'GET',
            beforeSend: function() {
                console.log('ğŸ“¤ ì/ë©´/ë™ API ìš”ì²­ ì „ì†¡ ì¤‘...');
            },
            success: function(response) {
                console.log('ğŸ“¨ ì/ë©´/ë™ API ì‘ë‹µ ìˆ˜ì‹ :', response);
                if (response.success) {
                    const towns = response.towns;
                    console.log('ğŸ“‹ ë°›ì€ ì/ë©´/ë™ ëª©ë¡:', towns);

                    const $townSelect = $('#townSelect');
                    $townSelect.find('option:not(:first)').remove();

                    towns.forEach((town, index) => {
                        const levelIcon = town.level === 4 ? 'ğŸ“' : 'ğŸ˜ï¸';
                        const option = `<option value="${town.name}" data-code="${town.code}" data-level="${town.level}">${levelIcon} ${town.name}</option>`;
                        $townSelect.append(option);
                        console.log(`ğŸ“ ì/ë©´/ë™ ì˜µì…˜ ì¶”ê°€ ${index + 1}/${towns.length}:`, town.name, `(ë ˆë²¨: ${town.level})`);
                    });

                    $townSelect.prop('disabled', false);
                    console.log('âœ… ì/ë©´/ë™ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', towns.length + 'ê°œ');
                } else {
                    console.error('âŒ ì/ë©´/ë™ API ì‘ë‹µ ì‹¤íŒ¨:', response.message);
                    showError('ì/ë©´/ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            },
            error: function(xhr, status, error) {
                console.error('ğŸ’¥ ì/ë©´/ë™ API ì˜¤ë¥˜:', { xhr, status, error });
                showError('ì/ë©´/ë™ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    // ì•„íŒŒíŠ¸ ê²€ìƒ‰ ì‹¤í–‰
    function performSearch() {
        const city = $('#citySelect').val();
        const district = $('#districtSelect').val();
        const town = $('#townSelect').val();

        console.log('ê²€ìƒ‰ ì‹¤í–‰:', city, district, town);

        if (!city || !district || !town) {
            showError('ì‹œ/ë„, ì‹œ/êµ°/êµ¬, ì/ë©´/ë™ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        showLoading();
        hideError();
        $('#searchResults').addClass('d-none');

        // API í™•ì¸ê³¼ í•¨ê»˜ ê²€ìƒ‰ ì‹¤í–‰
        const searchData = {
            city: city,
            district: district,
            town: town,
            months: 6,
            search_type: 'sale'
        };

        apiConfirmation.performSearch(
            searchData,
            function(response) {
                // ì„±ê³µ ì½œë°±
                hideLoading();
                console.log('ê²€ìƒ‰ API ì‘ë‹µ:', response);

                if (response.success) {
                    currentRegionCode = response.region_code;
                    // 3ë‹¨ê³„ ê²€ìƒ‰ì—ì„œëŠ” ì‹œ/ë„ + êµ°/êµ¬ + ì/ë©´/ë™ í˜•íƒœë¡œ ì§€ì—­ëª… êµ¬ì„±
                    currentRegionName = `${city} ${district} ${town}`;
                    allApartments = response.data || [];

                    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                    displaySearchResults(response);
                } else {
                    showError(response.message || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
            function(error) {
                // ì—ëŸ¬ ì½œë°±
                hideLoading();
                console.error('ê²€ìƒ‰ API ì˜¤ë¥˜:', error);
                showError(error.message || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        );
    }

    // ë²•ì •ë™ í•„í„° ì„¤ì •
    function setupDongFilter(dongList) {
        $('#dongFilter').find('option:not(:first)').remove();

        dongList.forEach(dong => {
            $('#dongFilter').append(`<option value="${dong}">${dong}</option>`);
        });

        $('#dongFilter').prop('disabled', false);
        console.log('ë²•ì •ë™ í•„í„° ì„¤ì • ì™„ë£Œ:', dongList.length + 'ê°œ');
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function displaySearchResults(response) {
        const totalCount = response.total_count || 0;
        const apartmentCount = allApartments.length;
        const classifiedData = response.classified_data || {};
        const dongCount = Object.keys(classifiedData).length;

        $('#resultSummary').text(
            `${currentRegionName}: ì´ ${apartmentCount.toLocaleString()}ê±´ ê±°ë˜ê¸°ë¡, ${dongCount}ê°œ ë²•ì •ë™`
        );

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        displayTransactionData(allApartments);
        $('#searchResults').removeClass('d-none');
    }

    // ê±°ë˜ ë°ì´í„° í‘œì‹œ
    function displayTransactionData(transactions) {
        const container = $('#apartmentsByDong');
        container.empty();

        if (!transactions || transactions.length === 0) {
            container.html('<div class="alert alert-warning">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
            return;
        }

        // ì•„íŒŒíŠ¸ë³„ë¡œ ê·¸ë£¹í™”
        const apartmentGroups = {};
        transactions.forEach(tx => {
            const aptName = tx.apt_name || 'ì•Œ ìˆ˜ ì—†ìŒ';
            if (!apartmentGroups[aptName]) {
                apartmentGroups[aptName] = [];
            }
            apartmentGroups[aptName].push(tx);
        });

        // ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
        container.html('<div class="row" id="apartmentCards"></div>');
        const cardsContainer = $('#apartmentCards');

        // ì•„íŒŒíŠ¸ë³„ ì¹´ë“œ ìƒì„±
        Object.keys(apartmentGroups).forEach(aptName => {
            const transactions = apartmentGroups[aptName];
            const avgPrice = Math.round(transactions.reduce((sum, tx) => sum + (tx.deal_amount || 0), 0) / transactions.length / 10000);
            const buildYear = transactions[0].build_year || '';
            const region = transactions[0].umd_nm || '';

            const card = `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card apartment-card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${aptName}</h6>
                            <p class="card-text">
                                <small class="text-muted">${region} Â· ${buildYear}ë…„</small><br>
                                <strong>í‰ê·  ê±°ë˜ê°€: ${avgPrice.toLocaleString()}ì–µì›</strong><br>
                                <span class="badge bg-primary">${transactions.length}ê±´ ê±°ë˜</span>
                            </p>
                            <button class="btn btn-sm btn-outline-primary" onclick="showApartmentDetail('${aptName}', '${transactions[0].region_code || currentRegionCode}')">
                                ìƒì„¸ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            `;
            cardsContainer.append(card);
        });
    }

    // ë™ë³„ ì•„íŒŒíŠ¸ ëª©ë¡ í‘œì‹œ
    function displayApartmentsByDong(apartments, selectedDong = '') {
        console.log('ë™ë³„ ì•„íŒŒíŠ¸ í‘œì‹œ:', apartments.length + 'ê°œ', selectedDong ? `(${selectedDong} í•„í„°)` : '');

        // í•„í„°ë§
        let filteredApartments = apartments;
        if (selectedDong) {
            filteredApartments = apartments.filter(apt =>
                apt.dong_list && apt.dong_list.includes(selectedDong)
            );
        }

        // ë™ë³„ë¡œ ê·¸ë£¹í™”
        const apartmentsByDong = {};
        filteredApartments.forEach(apt => {
            if (apt.dong_list && apt.dong_list.length > 0) {
                apt.dong_list.forEach(dong => {
                    if (!apartmentsByDong[dong]) {
                        apartmentsByDong[dong] = [];
                    }
                    apartmentsByDong[dong].push(apt);
                });
            }
        });

        // HTML ìƒì„±
        let html = '';
        const dongNames = Object.keys(apartmentsByDong).sort();

        dongNames.forEach(dong => {
            const dongApartments = apartmentsByDong[dong];
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>${dong}
                            <span class="badge bg-primary ms-2">${dongApartments.length}ê°œ ë‹¨ì§€</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;

            dongApartments.forEach(apt => {
                const avgPrice = formatPrice(Math.round(apt.avg_price / 10000));
                const priceRange = `${formatPrice(Math.round(apt.min_price / 10000))} ~ ${formatPrice(Math.round(apt.max_price / 10000))}`;

                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm apartment-card"
                             data-apt-name="${apt.apt_name}"
                             data-region-code="${apt.region_code}"
                             style="cursor: pointer;">
                            <div class="card-body">
                                <h6 class="card-title text-primary">${apt.apt_name}</h6>
                                <p class="card-text small">
                                    <i class="fas fa-calendar me-1"></i>ì¤€ê³µ: ${apt.build_year}ë…„<br>
                                    <i class="fas fa-chart-line me-1"></i>í‰ê· : ${avgPrice}<br>
                                    <i class="fas fa-arrows-alt-h me-1"></i>ë²”ìœ„: ${priceRange}<br>
                                    <i class="fas fa-exchange-alt me-1"></i>ê±°ë˜: ${apt.transaction_count}ê±´
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ì•„íŒŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            `;
        }

        $('#apartmentsByDong').html(html);

        // ì•„íŒŒíŠ¸ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        $('.apartment-card').on('click', function() {
            const aptName = $(this).data('apt-name');
            const regionCode = $(this).data('region-code');
            showApartmentDetail(aptName, regionCode);
        });
    }

    // ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´ í‘œì‹œ
    window.showApartmentDetail = function(aptName, regionCode) {
        console.log('ì•„íŒŒíŠ¸ ìƒì„¸ ì •ë³´:', aptName, regionCode);

        currentSelectedApartment = { name: aptName, regionCode: regionCode };
        $('#modalTitle').text(aptName + ' - ê±°ë˜ê¸°ë¡');
        $('#modalBody').html('<div class="text-center"><div class="spinner-border"></div><p class="mt-2">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>');
        $('#apartmentModal').modal('show');

        // ê±°ë˜ê¸°ë¡ API í˜¸ì¶œ
        $.ajax({
            url: '/api/search/step3',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                region_code: regionCode,
                apt_name: aptName
            }),
            success: function(response) {
                if (response.success) {
                    displayTransactionHistory(response.transactions || []);
                } else {
                    $('#modalBody').html('<div class="alert alert-danger">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>');
                }
            },
            error: function() {
                $('#modalBody').html('<div class="alert alert-danger">ê±°ë˜ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>');
            }
        });
    }

    // ê±°ë˜ê¸°ë¡ í‘œì‹œ
    function displayTransactionHistory(transactions) {
        console.log('ê±°ë˜ê¸°ë¡ í‘œì‹œ:', transactions.length + 'ê±´');

        if (transactions.length === 0) {
            $('#modalBody').html('<div class="alert alert-info">ê±°ë˜ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
            return;
        }

        let html = `
            <div class="mb-3">
                <h6>ìµœê·¼ ê±°ë˜ê¸°ë¡ (${transactions.length}ê±´)</h6>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>ê±°ë˜ì¼</th>
                            <th>ë©´ì (ã¡)</th>
                            <th>ì¸µ</th>
                            <th>ê±°ë˜ê°€ê²©</th>
                            <th>ã¡ë‹¹ ê°€ê²©</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        transactions.forEach(tx => {
            const price = formatPrice(tx.deal_amount);
            const pricePerArea = formatPrice(Math.round(tx.price_per_area / 10000));

            html += `
                <tr>
                    <td>${tx.deal_date}</td>
                    <td>${tx.exclusive_area}</td>
                    <td>${tx.floor}ì¸µ</td>
                    <td class="text-primary fw-bold">${price}</td>
                    <td>${pricePerArea}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        $('#modalBody').html(html);
    }

    // ê´€ì‹¬ë‹¨ì§€ ë“±ë¡
    $('#addToFavoritesBtn').on('click', function() {
        if (!currentSelectedApartment) return;

        const aptData = allApartments.find(apt => apt.apt_name === currentSelectedApartment.name);
        if (!aptData) return;

        // ê´€ì‹¬ë‹¨ì§€ ë“±ë¡ API í˜¸ì¶œ
        $.ajax({
            url: '/api/favorites',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                apt_name: aptData.apt_name,
                region_code: aptData.region_code,
                region_name: currentRegionName,
                build_year: aptData.build_year,
                avg_price: Math.round(aptData.avg_price),
                min_price: Math.round(aptData.min_price),
                max_price: Math.round(aptData.max_price),
                transaction_count: aptData.transaction_count
            }),
            success: function(response) {
                if (response.success) {
                    showToast('ê´€ì‹¬ë‹¨ì§€ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    $('#apartmentModal').modal('hide');
                } else {
                    showToast(response.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            },
            error: function() {
                showToast('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });
    });

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function resetLowerFields() {
        // 2ë‹¨ê³„(ì‹œ/êµ°/êµ¬) ì´ˆê¸°í™”
        $('#districtSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        // 3ë‹¨ê³„(ì/ë©´/ë™) ì´ˆê¸°í™”
        resetTownField();
        // ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”
        $('#searchBtn').prop('disabled', true);
        $('#searchResults').addClass('d-none');
        hideError();
    }

    function resetTownField() {
        $('#townSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#searchBtn').prop('disabled', true);
    }

    function resetForm() {
        $('#citySelect').val('');
        resetLowerFields();
        currentRegionCode = null;
        currentRegionName = null;
        allApartments = [];
        console.log('í¼ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    function formatPrice(amount) {
        if (amount >= 10000) {
            const eok = Math.floor(amount / 10000);
            const man = amount % 10000;
            if (man === 0) {
                return `${eok.toLocaleString()}ì–µì›`;
            } else {
                return `${eok.toLocaleString()}ì–µ ${man.toLocaleString()}ë§Œì›`;
            }
        } else {
            return `${amount.toLocaleString()}ë§Œì›`;
        }
    }

    function showError(message) {
        $('#errorText').text(message);
        $('#errorMessage').removeClass('d-none');
    }

    function hideError() {
        $('#errorMessage').addClass('d-none');
    }

    function showLoading() {
        $('#loadingSpinner').removeClass('d-none');
    }

    function hideLoading() {
        $('#loadingSpinner').addClass('d-none');
    }

    function showToast(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        const toastHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        $('body').append(toastHtml);

        setTimeout(() => {
            $('.alert').fadeOut(() => {
                $('.alert').remove();
            });
        }, 3000);
    }
});
</script>

<style>
.apartment-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
}

.apartment-card:hover .card-title {
    color: #0d6efd !important;
}
</style>
{% endblock %}