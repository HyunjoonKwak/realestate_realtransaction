{% extends "base.html" %}

{% block title %}아파트 검색 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-search text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">아파트 검색</h1>
                <p class="text-muted mb-0">지역을 선택하여 실거래가 정보를 검색하세요</p>
            </div>
        </div>
    </div>
</div>

<!-- 검색 폼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>검색 조건
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 1단계: 시/도 선택 -->
                    <div class="col-md-4">
                        <label for="citySelect" class="form-label">
                            <i class="fas fa-map-marked-alt me-1"></i>1단계: 시/도
                        </label>
                        <select class="form-select" id="citySelect">
                            <option value="">시/도 선택</option>
                        </select>
                    </div>

                    <!-- 2단계: 시/군/구 선택 -->
                    <div class="col-md-4">
                        <label for="districtSelect" class="form-label">
                            <i class="fas fa-building me-1"></i>2단계: 시/군/구
                        </label>
                        <select class="form-select" id="districtSelect" disabled>
                            <option value="">시/군/구 선택</option>
                        </select>
                    </div>

                    <!-- 3단계: 읍/면/동 선택 -->
                    <div class="col-md-4">
                        <label for="townSelect" class="form-label">
                            <i class="fas fa-home me-1"></i>3단계: 읍/면/동
                        </label>
                        <select class="form-select" id="townSelect" disabled>
                            <option value="">읍/면/동 선택</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-primary btn-lg" id="searchBtn" disabled>
                            <i class="fas fa-search me-2"></i>아파트 검색
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-2" id="clearBtn">
                            <i class="fas fa-undo me-2"></i>초기화
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>사용법:</strong> 1단계(시/도) → 2단계(시/군/구) → 3단계(읍/면/동) 순서로 선택한 후 검색하면 해당 지역의 아파트 실거래가 정보를 조회할 수 있습니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 및 에러 메시지 -->
<div id="loadingSpinner" class="row d-none">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">검색 중...</span>
        </div>
        <p class="mt-2">아파트 정보를 검색하고 있습니다...</p>
    </div>
</div>

<div id="errorMessage" class="row d-none">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
    </div>
</div>

<!-- 검색 결과 -->
<div id="searchResults" class="d-none">
    <div class="row mb-3">
        <div class="col-12">
            <h4><i class="fas fa-building me-2"></i>검색 결과</h4>
            <p class="text-muted mb-0" id="resultSummary"></p>
        </div>
    </div>

    <!-- 동별 아파트 목록 -->
    <div id="apartmentsByDong"></div>
</div>

<!-- 아파트 상세 정보 모달 -->
<div class="modal fade" id="apartmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 아파트 상세 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="addToFavoritesBtn">
                    <i class="fas fa-heart me-2"></i>관심단지 등록
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('3단계 검색 페이지 초기화');

    let currentRegionCode = null;
    let currentRegionName = null;
    let allApartments = [];
    let currentSelectedApartment = null;

    // 페이지 로드 시 시/도 목록 로드
    loadCities();

    // 1단계: 시/도 선택 이벤트
    $('#citySelect').on('change', function() {
        const city = $(this).val();
        console.log('1단계 - 시/도 변경:', city);

        // 하위 필드 초기화
        resetLowerFields();

        if (city) {
            loadDistricts(city);
        }
    });

    // 2단계: 시/군/구 선택 이벤트
    $('#districtSelect').on('change', function() {
        const city = $('#citySelect').val();
        const district = $(this).val();
        console.log('2단계 - 시/군/구 변경:', district);

        // 3단계 필드 초기화
        resetTownField();

        if (city && district) {
            loadTowns(city, district);
        }

        // 검색 결과 숨기기
        $('#searchResults').addClass('d-none');
        hideError();
    });

    // 3단계: 읍/면/동 선택 이벤트
    $('#townSelect').on('change', function() {
        const city = $('#citySelect').val();
        const district = $('#districtSelect').val();
        const town = $(this).val();
        console.log('3단계 - 읍/면/동 변경:', town);

        // 검색 버튼 활성화/비활성화
        if (city && district && town) {
            $('#searchBtn').prop('disabled', false);
            console.log('검색 버튼 활성화');
        } else {
            $('#searchBtn').prop('disabled', true);
            console.log('검색 버튼 비활성화');
        }

        // 검색 결과 숨기기
        $('#searchResults').addClass('d-none');
        hideError();
    });

    // 법정동 필터 변경 이벤트
    $('#dongFilter').on('change', function() {
        const selectedDong = $(this).val();
        console.log('법정동 필터 변경:', selectedDong);

        if (allApartments.length > 0) {
            displayApartmentsByDong(allApartments, selectedDong);
        }
    });

    // 검색 버튼 클릭
    $('#searchBtn').on('click', function() {
        performSearch();
    });

    // 초기화 버튼 클릭
    $('#clearBtn').on('click', function() {
        resetForm();
    });

    // 시/도 목록 로드
    function loadCities() {
        console.log('🚀 시/도 목록 로드 시작');

        $.ajax({
            url: '/api/cities',
            method: 'GET',
            beforeSend: function() {
                console.log('📤 시/도 API 요청 전송 중...');
            },
            success: function(response) {
                console.log('📨 시/도 API 응답 수신:', response);
                if (response.success) {
                    const cities = response.cities;
                    console.log('📋 받은 시/도 목록:', cities);

                    const $citySelect = $('#citySelect');
                    $citySelect.find('option:not(:first)').remove();

                    cities.forEach((city, index) => {
                        const option = `<option value="${city.name}">${city.name}</option>`;
                        $citySelect.append(option);
                        console.log(`📝 시/도 옵션 추가 ${index + 1}/${cities.length}:`, city.name);
                    });

                    console.log('✅ 시/도 목록 로드 완료:', cities.length + '개');
                } else {
                    console.error('❌ 시/도 API 응답 실패:', response.message);
                    showError('시/도 목록을 불러오는데 실패했습니다.');
                }
            },
            error: function(xhr, status, error) {
                console.error('💥 시/도 API 오류:', { xhr, status, error });
                showError('시/도 목록을 불러오는데 실패했습니다.');
            }
        });
    }

    // 군/구 목록 로드
    function loadDistricts(city) {
        console.log('🚀 군/구 목록 로드 시작:', city);
        console.log('🔗 API URL:', `/api/districts/${encodeURIComponent(city)}`);

        $.ajax({
            url: `/api/districts/${encodeURIComponent(city)}`,
            method: 'GET',
            beforeSend: function() {
                console.log('📤 군/구 API 요청 전송 중...');
            },
            success: function(response) {
                console.log('📨 군/구 API 응답 수신:', response);
                if (response.success) {
                    const districts = response.districts;
                    console.log('📋 받은 군/구 목록:', districts);

                    const $districtSelect = $('#districtSelect');
                    console.log('🎯 districtSelect 요소:', $districtSelect.length);

                    $districtSelect.find('option:not(:first)').remove();
                    console.log('🧹 기존 옵션 정리 완료');

                    districts.forEach((district, index) => {
                        const option = `<option value="${district.name}">${district.name}</option>`;
                        $districtSelect.append(option);
                        console.log(`📝 옵션 추가 ${index + 1}/${districts.length}:`, district.name);
                    });

                    $districtSelect.prop('disabled', false);
                    console.log('✅ 군/구 목록 로드 완료:', districts.length + '개');
                    console.log('🔓 districtSelect 활성화됨');
                } else {
                    console.error('❌ 군/구 API 응답 실패:', response.message);
                    showError('군/구 목록을 불러오는데 실패했습니다.');
                }
            },
            error: function(xhr, status, error) {
                console.error('💥 군/구 API 오류:', { xhr, status, error });
                console.error('📄 응답 텍스트:', xhr.responseText);
                showError('군/구 목록을 불러오는데 실패했습니다.');
            }
        });
    }

    // 읍/면/동 목록 로드
    function loadTowns(city, district) {
        console.log('🚀 읍/면/동 목록 로드 시작:', city, district);

        $.ajax({
            url: `/api/towns/${encodeURIComponent(city)}/${encodeURIComponent(district)}`,
            method: 'GET',
            beforeSend: function() {
                console.log('📤 읍/면/동 API 요청 전송 중...');
            },
            success: function(response) {
                console.log('📨 읍/면/동 API 응답 수신:', response);
                if (response.success) {
                    const towns = response.towns;
                    console.log('📋 받은 읍/면/동 목록:', towns);

                    const $townSelect = $('#townSelect');
                    $townSelect.find('option:not(:first)').remove();

                    towns.forEach((town, index) => {
                        const levelIcon = town.level === 4 ? '📍' : '🏘️';
                        const option = `<option value="${town.name}" data-code="${town.code}" data-level="${town.level}">${levelIcon} ${town.name}</option>`;
                        $townSelect.append(option);
                        console.log(`📝 읍/면/동 옵션 추가 ${index + 1}/${towns.length}:`, town.name, `(레벨: ${town.level})`);
                    });

                    $townSelect.prop('disabled', false);
                    console.log('✅ 읍/면/동 목록 로드 완료:', towns.length + '개');
                } else {
                    console.error('❌ 읍/면/동 API 응답 실패:', response.message);
                    showError('읍/면/동 목록을 불러오는데 실패했습니다.');
                }
            },
            error: function(xhr, status, error) {
                console.error('💥 읍/면/동 API 오류:', { xhr, status, error });
                showError('읍/면/동 목록을 불러오는데 실패했습니다.');
            }
        });
    }

    // 아파트 검색 실행
    function performSearch() {
        const city = $('#citySelect').val();
        const district = $('#districtSelect').val();
        const town = $('#townSelect').val();

        console.log('검색 실행:', city, district, town);

        if (!city || !district || !town) {
            showError('시/도, 시/군/구, 읍/면/동을 모두 선택해주세요.');
            return;
        }

        showLoading();
        hideError();
        $('#searchResults').addClass('d-none');

        // API 확인과 함께 검색 실행
        const searchData = {
            city: city,
            district: district,
            town: town,
            months: 6,
            search_type: 'sale'
        };

        apiConfirmation.performSearch(
            searchData,
            function(response) {
                // 성공 콜백
                hideLoading();
                console.log('검색 API 응답:', response);

                if (response.success) {
                    currentRegionCode = response.region_code;
                    // 3단계 검색에서는 시/도 + 군/구 + 읍/면/동 형태로 지역명 구성
                    currentRegionName = `${city} ${district} ${town}`;
                    allApartments = response.data || [];

                    // 검색 결과 표시
                    displaySearchResults(response);
                } else {
                    showError(response.message || '검색 중 오류가 발생했습니다.');
                }
            },
            function(error) {
                // 에러 콜백
                hideLoading();
                console.error('검색 API 오류:', error);
                showError(error.message || '검색 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        );
    }

    // 법정동 필터 설정
    function setupDongFilter(dongList) {
        $('#dongFilter').find('option:not(:first)').remove();

        dongList.forEach(dong => {
            $('#dongFilter').append(`<option value="${dong}">${dong}</option>`);
        });

        $('#dongFilter').prop('disabled', false);
        console.log('법정동 필터 설정 완료:', dongList.length + '개');
    }

    // 검색 결과 표시
    function displaySearchResults(response) {
        const totalCount = response.total_count || 0;
        const apartmentCount = allApartments.length;
        const classifiedData = response.classified_data || {};
        const dongCount = Object.keys(classifiedData).length;

        $('#resultSummary').text(
            `${currentRegionName}: 총 ${apartmentCount.toLocaleString()}건 거래기록, ${dongCount}개 법정동`
        );

        // 검색 결과 표시
        displayTransactionData(allApartments);
        $('#searchResults').removeClass('d-none');
    }

    // 거래 데이터 표시
    function displayTransactionData(transactions) {
        const container = $('#apartmentsByDong');
        container.empty();

        if (!transactions || transactions.length === 0) {
            container.html('<div class="alert alert-warning">검색 결과가 없습니다.</div>');
            return;
        }

        // 아파트별로 그룹화
        const apartmentGroups = {};
        transactions.forEach(tx => {
            const aptName = tx.apt_name || '알 수 없음';
            if (!apartmentGroups[aptName]) {
                apartmentGroups[aptName] = [];
            }
            apartmentGroups[aptName].push(tx);
        });

        // 카드 컨테이너 생성
        container.html('<div class="row" id="apartmentCards"></div>');
        const cardsContainer = $('#apartmentCards');

        // 아파트별 카드 생성
        Object.keys(apartmentGroups).forEach(aptName => {
            const transactions = apartmentGroups[aptName];
            const avgPrice = Math.round(transactions.reduce((sum, tx) => sum + (tx.deal_amount || 0), 0) / transactions.length / 10000);
            const buildYear = transactions[0].build_year || '';
            const region = transactions[0].umd_nm || '';

            const card = `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card apartment-card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${aptName}</h6>
                            <p class="card-text">
                                <small class="text-muted">${region} · ${buildYear}년</small><br>
                                <strong>평균 거래가: ${avgPrice.toLocaleString()}억원</strong><br>
                                <span class="badge bg-primary">${transactions.length}건 거래</span>
                            </p>
                            <button class="btn btn-sm btn-outline-primary" onclick="showApartmentDetail('${aptName}', '${transactions[0].region_code || currentRegionCode}')">
                                상세보기
                            </button>
                        </div>
                    </div>
                </div>
            `;
            cardsContainer.append(card);
        });
    }

    // 동별 아파트 목록 표시
    function displayApartmentsByDong(apartments, selectedDong = '') {
        console.log('동별 아파트 표시:', apartments.length + '개', selectedDong ? `(${selectedDong} 필터)` : '');

        // 필터링
        let filteredApartments = apartments;
        if (selectedDong) {
            filteredApartments = apartments.filter(apt =>
                apt.dong_list && apt.dong_list.includes(selectedDong)
            );
        }

        // 동별로 그룹화
        const apartmentsByDong = {};
        filteredApartments.forEach(apt => {
            if (apt.dong_list && apt.dong_list.length > 0) {
                apt.dong_list.forEach(dong => {
                    if (!apartmentsByDong[dong]) {
                        apartmentsByDong[dong] = [];
                    }
                    apartmentsByDong[dong].push(apt);
                });
            }
        });

        // HTML 생성
        let html = '';
        const dongNames = Object.keys(apartmentsByDong).sort();

        dongNames.forEach(dong => {
            const dongApartments = apartmentsByDong[dong];
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>${dong}
                            <span class="badge bg-primary ms-2">${dongApartments.length}개 단지</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;

            dongApartments.forEach(apt => {
                const avgPrice = formatPrice(Math.round(apt.avg_price / 10000));
                const priceRange = `${formatPrice(Math.round(apt.min_price / 10000))} ~ ${formatPrice(Math.round(apt.max_price / 10000))}`;

                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm apartment-card"
                             data-apt-name="${apt.apt_name}"
                             data-region-code="${apt.region_code}"
                             style="cursor: pointer;">
                            <div class="card-body">
                                <h6 class="card-title text-primary">${apt.apt_name}</h6>
                                <p class="card-text small">
                                    <i class="fas fa-calendar me-1"></i>준공: ${apt.build_year}년<br>
                                    <i class="fas fa-chart-line me-1"></i>평균: ${avgPrice}<br>
                                    <i class="fas fa-arrows-alt-h me-1"></i>범위: ${priceRange}<br>
                                    <i class="fas fa-exchange-alt me-1"></i>거래: ${apt.transaction_count}건
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    선택한 조건에 해당하는 아파트가 없습니다.
                </div>
            `;
        }

        $('#apartmentsByDong').html(html);

        // 아파트 카드 클릭 이벤트
        $('.apartment-card').on('click', function() {
            const aptName = $(this).data('apt-name');
            const regionCode = $(this).data('region-code');
            showApartmentDetail(aptName, regionCode);
        });
    }

    // 아파트 상세 정보 표시
    window.showApartmentDetail = function(aptName, regionCode) {
        console.log('아파트 상세 정보:', aptName, regionCode);

        currentSelectedApartment = { name: aptName, regionCode: regionCode };
        $('#modalTitle').text(aptName + ' - 거래기록');
        $('#modalBody').html('<div class="text-center"><div class="spinner-border"></div><p class="mt-2">거래기록을 불러오는 중...</p></div>');
        $('#apartmentModal').modal('show');

        // 거래기록 API 호출
        $.ajax({
            url: '/api/search/step3',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                region_code: regionCode,
                apt_name: aptName
            }),
            success: function(response) {
                if (response.success) {
                    displayTransactionHistory(response.transactions || []);
                } else {
                    $('#modalBody').html('<div class="alert alert-danger">거래기록을 불러오는데 실패했습니다.</div>');
                }
            },
            error: function() {
                $('#modalBody').html('<div class="alert alert-danger">거래기록을 불러오는 중 오류가 발생했습니다.</div>');
            }
        });
    }

    // 거래기록 표시
    function displayTransactionHistory(transactions) {
        console.log('거래기록 표시:', transactions.length + '건');

        if (transactions.length === 0) {
            $('#modalBody').html('<div class="alert alert-info">거래기록이 없습니다.</div>');
            return;
        }

        let html = `
            <div class="mb-3">
                <h6>최근 거래기록 (${transactions.length}건)</h6>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>거래일</th>
                            <th>면적(㎡)</th>
                            <th>층</th>
                            <th>거래가격</th>
                            <th>㎡당 가격</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        transactions.forEach(tx => {
            const price = formatPrice(tx.deal_amount);
            const pricePerArea = formatPrice(Math.round(tx.price_per_area / 10000));

            html += `
                <tr>
                    <td>${tx.deal_date}</td>
                    <td>${tx.exclusive_area}</td>
                    <td>${tx.floor}층</td>
                    <td class="text-primary fw-bold">${price}</td>
                    <td>${pricePerArea}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        $('#modalBody').html(html);
    }

    // 관심단지 등록
    $('#addToFavoritesBtn').on('click', function() {
        if (!currentSelectedApartment) return;

        const aptData = allApartments.find(apt => apt.apt_name === currentSelectedApartment.name);
        if (!aptData) return;

        // 관심단지 등록 API 호출
        $.ajax({
            url: '/api/favorites',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                apt_name: aptData.apt_name,
                region_code: aptData.region_code,
                region_name: currentRegionName,
                build_year: aptData.build_year,
                avg_price: Math.round(aptData.avg_price),
                min_price: Math.round(aptData.min_price),
                max_price: Math.round(aptData.max_price),
                transaction_count: aptData.transaction_count
            }),
            success: function(response) {
                if (response.success) {
                    showToast('관심단지로 등록되었습니다.', 'success');
                    $('#apartmentModal').modal('hide');
                } else {
                    showToast(response.message || '등록에 실패했습니다.', 'error');
                }
            },
            error: function() {
                showToast('등록 중 오류가 발생했습니다.', 'error');
            }
        });
    });

    // 유틸리티 함수들
    function resetLowerFields() {
        // 2단계(시/군/구) 초기화
        $('#districtSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        // 3단계(읍/면/동) 초기화
        resetTownField();
        // 검색 버튼 비활성화
        $('#searchBtn').prop('disabled', true);
        $('#searchResults').addClass('d-none');
        hideError();
    }

    function resetTownField() {
        $('#townSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#searchBtn').prop('disabled', true);
    }

    function resetForm() {
        $('#citySelect').val('');
        resetLowerFields();
        currentRegionCode = null;
        currentRegionName = null;
        allApartments = [];
        console.log('폼 초기화 완료');
    }

    function formatPrice(amount) {
        if (amount >= 10000) {
            const eok = Math.floor(amount / 10000);
            const man = amount % 10000;
            if (man === 0) {
                return `${eok.toLocaleString()}억원`;
            } else {
                return `${eok.toLocaleString()}억 ${man.toLocaleString()}만원`;
            }
        } else {
            return `${amount.toLocaleString()}만원`;
        }
    }

    function showError(message) {
        $('#errorText').text(message);
        $('#errorMessage').removeClass('d-none');
    }

    function hideError() {
        $('#errorMessage').addClass('d-none');
    }

    function showLoading() {
        $('#loadingSpinner').removeClass('d-none');
    }

    function hideLoading() {
        $('#loadingSpinner').addClass('d-none');
    }

    function showToast(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        const toastHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        $('body').append(toastHtml);

        setTimeout(() => {
            $('.alert').fadeOut(() => {
                $('.alert').remove();
            });
        }, 3000);
    }
});
</script>

<style>
.apartment-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
}

.apartment-card:hover .card-title {
    color: #0d6efd !important;
}
</style>
{% endblock %}