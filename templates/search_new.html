{% extends "base.html" %}

{% block title %}아파트 검색 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-search text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">아파트 검색</h1>
                <p class="text-muted mb-0">지역을 선택하여 실거래가 정보를 검색하세요</p>
            </div>
        </div>
    </div>
</div>

<!-- 검색 폼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>검색 조건
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 지역 선택 -->
                    <div class="col-md-4">
                        <label for="citySelect" class="form-label">시/도</label>
                        <select class="form-select" id="citySelect">
                            <option value="">시/도 선택</option>
                            {% for city in cities %}
                            <option value="{{ city }}">{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="districtSelect" class="form-label">군/구</label>
                        <select class="form-select" id="districtSelect" disabled>
                            <option value="">군/구 선택</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="dongFilter" class="form-label">법정동 (선택사항)</label>
                        <select class="form-select" id="dongFilter" disabled>
                            <option value="">전체 법정동</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-primary btn-lg" id="searchBtn" disabled>
                            <i class="fas fa-search me-2"></i>아파트 검색
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg ms-2" id="clearBtn">
                            <i class="fas fa-undo me-2"></i>초기화
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>사용법:</strong> 시/도와 군/구를 선택한 후 검색 버튼을 클릭하면 해당 지역의 아파트가 법정동별로 분류되어 표시됩니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 및 에러 메시지 -->
<div id="loadingSpinner" class="row d-none">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">검색 중...</span>
        </div>
        <p class="mt-2">아파트 정보를 검색하고 있습니다...</p>
    </div>
</div>

<div id="errorMessage" class="row d-none">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
    </div>
</div>

<!-- 검색 결과 -->
<div id="searchResults" class="d-none">
    <div class="row mb-3">
        <div class="col-12">
            <h4><i class="fas fa-building me-2"></i>검색 결과</h4>
            <p class="text-muted mb-0" id="resultSummary"></p>
        </div>
    </div>

    <!-- 동별 아파트 목록 -->
    <div id="apartmentsByDong"></div>
</div>

<!-- 아파트 상세 정보 모달 -->
<div class="modal fade" id="apartmentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 아파트 상세 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="addToFavoritesBtn">
                    <i class="fas fa-heart me-2"></i>관심단지 등록
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    console.log('검색 페이지 초기화');

    let currentRegionCode = null;
    let currentRegionName = null;
    let allApartments = [];
    let currentSelectedApartment = null;

    // 시/도 선택 이벤트
    $('#citySelect').on('change', function() {
        const city = $(this).val();
        console.log('시/도 변경:', city);

        // 하위 필드 초기화
        resetLowerFields();

        if (city) {
            loadDistricts(city);
        }
    });

    // 군/구 선택 이벤트
    $('#districtSelect').on('change', function() {
        const city = $('#citySelect').val();
        const district = $(this).val();
        console.log('군/구 변경:', district);

        // 검색 버튼 활성화/비활성화
        if (city && district) {
            $('#searchBtn').prop('disabled', false);
            console.log('검색 버튼 활성화');
        } else {
            $('#searchBtn').prop('disabled', true);
            console.log('검색 버튼 비활성화');
        }

        // 검색 결과 숨기기
        $('#searchResults').addClass('d-none');
        hideError();
    });

    // 법정동 필터 변경 이벤트
    $('#dongFilter').on('change', function() {
        const selectedDong = $(this).val();
        console.log('법정동 필터 변경:', selectedDong);

        if (allApartments.length > 0) {
            displayApartmentsByDong(allApartments, selectedDong);
        }
    });

    // 검색 버튼 클릭
    $('#searchBtn').on('click', function() {
        performSearch();
    });

    // 초기화 버튼 클릭
    $('#clearBtn').on('click', function() {
        resetForm();
    });

    // 군/구 목록 로드
    function loadDistricts(city) {
        console.log('군/구 목록 로드:', city);

        $.ajax({
            url: `/api/districts/${encodeURIComponent(city)}`,
            method: 'GET',
            success: function(response) {
                console.log('군/구 API 응답:', response);
                if (response.success) {
                    const districts = response.districts;
                    $('#districtSelect').find('option:not(:first)').remove();

                    districts.forEach(district => {
                        $('#districtSelect').append(`<option value="${district.name}">${district.name}</option>`);
                    });

                    $('#districtSelect').prop('disabled', false);
                    console.log('군/구 목록 로드 완료:', districts.length + '개');
                } else {
                    showError('군/구 목록을 불러오는데 실패했습니다.');
                }
            },
            error: function(xhr, status, error) {
                console.error('군/구 API 오류:', error);
                showError('군/구 목록을 불러오는 중 오류가 발생했습니다.');
            }
        });
    }

    // 아파트 검색 실행
    function performSearch() {
        const city = $('#citySelect').val();
        const district = $('#districtSelect').val();

        console.log('검색 실행:', city, district);

        if (!city || !district) {
            showError('시/도와 군/구를 모두 선택해주세요.');
            return;
        }

        showLoading();
        hideError();
        $('#searchResults').addClass('d-none');

        $.ajax({
            url: '/api/search/step1',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                city: city,
                district: district
            }),
            success: function(response) {
                hideLoading();
                console.log('검색 API 응답:', response);

                if (response.success) {
                    currentRegionCode = response.region_code;
                    currentRegionName = `${city} ${district}`;
                    allApartments = response.apartment_list || [];

                    // 법정동 필터 옵션 설정
                    setupDongFilter(response.dong_list || []);

                    // 검색 결과 표시
                    displaySearchResults(response);
                } else {
                    showError(response.message || '검색 중 오류가 발생했습니다.');
                }
            },
            error: function(xhr, status, error) {
                hideLoading();
                console.error('검색 API 오류:', error);
                showError('검색 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });
    }

    // 법정동 필터 설정
    function setupDongFilter(dongList) {
        $('#dongFilter').find('option:not(:first)').remove();

        dongList.forEach(dong => {
            $('#dongFilter').append(`<option value="${dong}">${dong}</option>`);
        });

        $('#dongFilter').prop('disabled', false);
        console.log('법정동 필터 설정 완료:', dongList.length + '개');
    }

    // 검색 결과 표시
    function displaySearchResults(response) {
        const totalCount = response.total_count || 0;
        const apartmentCount = allApartments.length;
        const dongCount = (response.dong_list || []).length;

        $('#resultSummary').text(
            `${currentRegionName}: 총 ${apartmentCount}개 아파트, ${dongCount}개 법정동, ${totalCount.toLocaleString()}건 거래기록`
        );

        displayApartmentsByDong(allApartments);
        $('#searchResults').removeClass('d-none');
    }

    // 동별 아파트 목록 표시
    function displayApartmentsByDong(apartments, selectedDong = '') {
        console.log('동별 아파트 표시:', apartments.length + '개', selectedDong ? `(${selectedDong} 필터)` : '');

        // 필터링
        let filteredApartments = apartments;
        if (selectedDong) {
            filteredApartments = apartments.filter(apt =>
                apt.dong_list && apt.dong_list.includes(selectedDong)
            );
        }

        // 동별로 그룹화
        const apartmentsByDong = {};
        filteredApartments.forEach(apt => {
            if (apt.dong_list && apt.dong_list.length > 0) {
                apt.dong_list.forEach(dong => {
                    if (!apartmentsByDong[dong]) {
                        apartmentsByDong[dong] = [];
                    }
                    apartmentsByDong[dong].push(apt);
                });
            }
        });

        // HTML 생성
        let html = '';
        const dongNames = Object.keys(apartmentsByDong).sort();

        dongNames.forEach(dong => {
            const dongApartments = apartmentsByDong[dong];
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>${dong}
                            <span class="badge bg-primary ms-2">${dongApartments.length}개 단지</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;

            dongApartments.forEach(apt => {
                const avgPrice = formatPrice(Math.round(apt.avg_price / 10000));
                const priceRange = `${formatPrice(Math.round(apt.min_price / 10000))} ~ ${formatPrice(Math.round(apt.max_price / 10000))}`;

                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm apartment-card"
                             data-apt-name="${apt.apt_name}"
                             data-region-code="${apt.region_code}"
                             style="cursor: pointer;">
                            <div class="card-body">
                                <h6 class="card-title text-primary">${apt.apt_name}</h6>
                                <p class="card-text small">
                                    <i class="fas fa-calendar me-1"></i>준공: ${apt.build_year}년<br>
                                    <i class="fas fa-chart-line me-1"></i>평균: ${avgPrice}<br>
                                    <i class="fas fa-arrows-alt-h me-1"></i>범위: ${priceRange}<br>
                                    <i class="fas fa-exchange-alt me-1"></i>거래: ${apt.transaction_count}건
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;
        });

        if (html === '') {
            html = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    선택한 조건에 해당하는 아파트가 없습니다.
                </div>
            `;
        }

        $('#apartmentsByDong').html(html);

        // 아파트 카드 클릭 이벤트
        $('.apartment-card').on('click', function() {
            const aptName = $(this).data('apt-name');
            const regionCode = $(this).data('region-code');
            showApartmentDetail(aptName, regionCode);
        });
    }

    // 아파트 상세 정보 표시
    function showApartmentDetail(aptName, regionCode) {
        console.log('아파트 상세 정보:', aptName, regionCode);

        currentSelectedApartment = { name: aptName, regionCode: regionCode };
        $('#modalTitle').text(aptName + ' - 거래기록');
        $('#modalBody').html('<div class="text-center"><div class="spinner-border"></div><p class="mt-2">거래기록을 불러오는 중...</p></div>');
        $('#apartmentModal').modal('show');

        // 거래기록 API 호출
        $.ajax({
            url: '/api/search/step3',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                region_code: regionCode,
                apt_name: aptName
            }),
            success: function(response) {
                if (response.success) {
                    displayTransactionHistory(response.transactions || []);
                } else {
                    $('#modalBody').html('<div class="alert alert-danger">거래기록을 불러오는데 실패했습니다.</div>');
                }
            },
            error: function() {
                $('#modalBody').html('<div class="alert alert-danger">거래기록을 불러오는 중 오류가 발생했습니다.</div>');
            }
        });
    }

    // 거래기록 표시
    function displayTransactionHistory(transactions) {
        console.log('거래기록 표시:', transactions.length + '건');

        if (transactions.length === 0) {
            $('#modalBody').html('<div class="alert alert-info">거래기록이 없습니다.</div>');
            return;
        }

        let html = `
            <div class="mb-3">
                <h6>최근 거래기록 (${transactions.length}건)</h6>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>거래일</th>
                            <th>면적(㎡)</th>
                            <th>층</th>
                            <th>거래가격</th>
                            <th>㎡당 가격</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        transactions.forEach(tx => {
            const price = formatPrice(tx.deal_amount);
            const pricePerArea = formatPrice(Math.round(tx.price_per_area / 10000));

            html += `
                <tr>
                    <td>${tx.deal_date}</td>
                    <td>${tx.exclusive_area}</td>
                    <td>${tx.floor}층</td>
                    <td class="text-primary fw-bold">${price}</td>
                    <td>${pricePerArea}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        $('#modalBody').html(html);
    }

    // 관심단지 등록
    $('#addToFavoritesBtn').on('click', function() {
        if (!currentSelectedApartment) return;

        const aptData = allApartments.find(apt => apt.apt_name === currentSelectedApartment.name);
        if (!aptData) return;

        // 관심단지 등록 API 호출
        $.ajax({
            url: '/api/favorites',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                apt_name: aptData.apt_name,
                region_code: aptData.region_code,
                region_name: currentRegionName,
                build_year: aptData.build_year,
                avg_price: Math.round(aptData.avg_price),
                min_price: Math.round(aptData.min_price),
                max_price: Math.round(aptData.max_price),
                transaction_count: aptData.transaction_count
            }),
            success: function(response) {
                if (response.success) {
                    showToast('관심단지로 등록되었습니다.', 'success');
                    $('#apartmentModal').modal('hide');
                } else {
                    showToast(response.message || '등록에 실패했습니다.', 'error');
                }
            },
            error: function() {
                showToast('등록 중 오류가 발생했습니다.', 'error');
            }
        });
    });

    // 유틸리티 함수들
    function resetLowerFields() {
        $('#districtSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#dongFilter').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#searchBtn').prop('disabled', true);
        $('#searchResults').addClass('d-none');
        hideError();
    }

    function resetForm() {
        $('#citySelect').val('');
        resetLowerFields();
        currentRegionCode = null;
        currentRegionName = null;
        allApartments = [];
        console.log('폼 초기화 완료');
    }

    function formatPrice(amount) {
        if (amount >= 10000) {
            const eok = Math.floor(amount / 10000);
            const man = amount % 10000;
            if (man === 0) {
                return `${eok.toLocaleString()}억원`;
            } else {
                return `${eok.toLocaleString()}억 ${man.toLocaleString()}만원`;
            }
        } else {
            return `${amount.toLocaleString()}만원`;
        }
    }

    function showError(message) {
        $('#errorText').text(message);
        $('#errorMessage').removeClass('d-none');
    }

    function hideError() {
        $('#errorMessage').addClass('d-none');
    }

    function showLoading() {
        $('#loadingSpinner').removeClass('d-none');
    }

    function hideLoading() {
        $('#loadingSpinner').addClass('d-none');
    }

    function showToast(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        const toastHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        $('body').append(toastHtml);

        setTimeout(() => {
            $('.alert').fadeOut(() => {
                $('.alert').remove();
            });
        }, 3000);
    }
});
</script>

<style>
.apartment-card:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease-in-out;
}

.apartment-card:hover .card-title {
    color: #0d6efd !important;
}
</style>

{% endblock %}