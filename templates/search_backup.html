{% extends "base.html" %}

{% block title %}아파트 검색 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-search text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">아파트 검색</h1>
                <p class="text-muted mb-0">지역과 아파트명으로 실거래가 정보를 검색하세요</p>
            </div>
        </div>
    </div>
</div>

<!-- 검색 폼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>검색 조건
                </h5>
            </div>
            <div class="card-body">
                <!-- 단계별 검색 폼 -->
                <div class="row">
                    <!-- 1단계: 시도/군구 선택 -->
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-map-marker-alt me-1"></i>1단계: 지역 선택</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="citySelect" class="form-label">시/도</label>
                                    <select class="form-select" id="citySelect" required>
                                        <option value="">시/도 선택</option>
                                        {% for city in cities %}
                                        <option value="{{ city }}">{{ city }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="districtSelect" class="form-label">군/구</label>
                                    <select class="form-select" id="districtSelect" required disabled>
                                        <option value="">군/구 선택</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary w-100" id="step1Btn" disabled>
                                    <i class="fas fa-search me-1"></i>법정동 조회
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2단계: 법정동 선택 -->
                    <div class="col-md-4">
                        <div class="card border-success" id="step2Card" style="opacity: 0.5;">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-building me-1"></i>2단계: 법정동 선택</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dongSelect" class="form-label">법정동</label>
                                    <select class="form-select" id="dongSelect" required disabled>
                                        <option value="">법정동 선택</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-success w-100" id="step2Btn" disabled>
                                    <i class="fas fa-list me-1"></i>아파트 목록 조회
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3단계: 아파트 선택 -->
                    <div class="col-md-4">
                        <div class="card border-warning" id="step3Card" style="opacity: 0.5;">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-home me-1"></i>3단계: 아파트 선택</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="apartmentSelect" class="form-label">아파트</label>
                                    <select class="form-select" id="apartmentSelect" required disabled>
                                        <option value="">아파트 선택</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-warning w-100" id="step3Btn" disabled>
                                    <i class="fas fa-chart-line me-1"></i>거래기록 조회
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 초기화 버튼 -->
                <div class="row mt-3">
                    <div class="col-md-12 text-center">
                        <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                            <i class="fas fa-undo me-1"></i>검색 초기화
                        </button>
                    </div>
                </div>
                
                <!-- 검색 안내 -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info alert-sm mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>검색 안내:</strong> 시/도 → 군/구 → 법정동 → 아파트 순서로 단계별 검색하여 관심단지를 등록하세요.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 스피너 -->
<div id="loadingSpinner" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">검색 중...</span>
    </div>
    <p class="mt-2">실거래가 데이터를 검색하고 있습니다...</p>
</div>

<!-- 단계별 검색 결과 -->
<!-- 1단계 결과: 법정동 목록 -->
<div id="step1Results" class="d-none">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>법정동 목록
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="step1Summary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>다음 단계:</strong> 관심있는 법정동을 선택하여 해당 동의 아파트 목록을 확인하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2단계 결과: 아파트 목록 -->
<div id="step2Results" class="d-none">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>아파트 목록
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="step2Summary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-success">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>다음 단계:</strong> 관심있는 아파트를 선택하여 해당 아파트의 거래기록을 확인하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3단계 결과: 거래기록 -->
<div id="step3Results" class="d-none">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>거래기록
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="step3Summary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-heart me-1"></i>
                                <strong>관심단지 등록:</strong> 이 아파트를 관심단지로 등록하여 지속적으로 추적하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 오류 메시지 -->
<div id="errorMessage" class="alert alert-danger d-none">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> 검색 오류</h5>
    <p id="errorText" class="mb-0"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
// 전역 변수
let currentRegionCode = null;
let currentDongName = null;
let currentApartmentName = null;

$(document).ready(function() {
    // 초기화 버튼
    $('#clearBtn').on('click', function() {
        resetAllSteps();
    });

    // 시/도 변경 이벤트
    $('#citySelect').on('change', function() {
        const city = $(this).val();
        $('#districtSelect').val('').prop('disabled', true);
        loadDistricts(city);
        resetStepsFrom(1);
    });

    // 군/구 변경 이벤트
    $('#districtSelect').on('change', function() {
        const district = $(this).val();
        if (district) {
            $('#step1Btn').prop('disabled', false);
        } else {
            $('#step1Btn').prop('disabled', true);
        }
        resetStepsFrom(1);
    });

    // 1단계 버튼 클릭
    $('#step1Btn').on('click', function() {
        performStep1();
    });

    // 법정동 변경 이벤트
    $('#dongSelect').on('change', function() {
        const dong = $(this).val();
        if (dong) {
            $('#step2Btn').prop('disabled', false);
        } else {
            $('#step2Btn').prop('disabled', true);
        }
        resetStepsFrom(2);
    });

    // 2단계 버튼 클릭
    $('#step2Btn').on('click', function() {
        performStep2();
    });

    // 아파트 변경 이벤트
    $('#apartmentSelect').on('change', function() {
        const apartment = $(this).val();
        if (apartment) {
            $('#step3Btn').prop('disabled', false);
        } else {
            $('#step3Btn').prop('disabled', true);
        }
        resetStepsFrom(3);
    });

    // 3단계 버튼 클릭
    $('#step3Btn').on('click', function() {
        performStep3();
    });

    // 초기화
    resetAllSteps();
});


// 단계별 초기화 함수들
function resetAllSteps() {
    // 폼 초기화
    $('#citySelect').val('');
    $('#districtSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
    $('#dongSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
    $('#apartmentSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
    
    // 버튼 초기화
    $('#step1Btn').prop('disabled', true);
    $('#step2Btn').prop('disabled', true);
    $('#step3Btn').prop('disabled', true);
    
    // 카드 초기화
    $('#step2Card').css('opacity', '0.5');
    $('#step3Card').css('opacity', '0.5');
    
    // 결과 영역 숨기기
    $('#step1Results').addClass('d-none');
    $('#step2Results').addClass('d-none');
    $('#step3Results').addClass('d-none');
    $('#errorMessage').addClass('d-none');
    
    // 전역 변수 초기화
    currentRegionCode = null;
    currentDongName = null;
    currentApartmentName = null;
}

function resetStepsFrom(step) {
    // 해당 단계부터 이후 단계들 초기화
    if (step <= 1) {
        $('#dongSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#step2Btn').prop('disabled', true);
        $('#step2Card').css('opacity', '0.5');
        $('#step2Results').addClass('d-none');
    }
    if (step <= 2) {
        $('#apartmentSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#step3Btn').prop('disabled', true);
        $('#step3Card').css('opacity', '0.5');
        $('#step3Results').addClass('d-none');
    }
}

// 유틸리티 함수들
function formatPrice(amount) {
    if (amount >= 10000) {
        const eok = Math.floor(amount / 10000);
        const man = amount % 10000;
        if (man === 0) {
            return `${eok.toLocaleString()}억원`;
        } else {
            return `${eok.toLocaleString()}억 ${man.toLocaleString()}만원`;
        }
    } else {
        return `${amount.toLocaleString()}만원`;
    }
}

function showError(message) {
    $('#errorText').text(message);
    $('#errorMessage').removeClass('d-none');
}

function hideError() {
    $('#errorMessage').addClass('d-none');
}

function showLoading() {
    $('#loadingSpinner').removeClass('d-none');
}

function hideLoading() {
    $('#loadingSpinner').addClass('d-none');
}

// 1단계: 시도/군구 선택 후 법정동 목록 조회
function performStep1() {
    const city = $('#citySelect').val();
    const district = $('#districtSelect').val();
    
    if (!city || !district) {
        showError('시도와 군구를 모두 선택해주세요.');
        return;
    }
    
    showLoading();
    hideError();
    
    $.ajax({
        url: '/api/search/step1',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            city: city,
            district: district
        }),
        success: function(response) {
            hideLoading();
            if (response.success) {
                currentRegionCode = response.region_code;
                displayStep1Results(response);
                enableStep2();
            } else {
                showError(response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('법정동 목록 조회 중 오류가 발생했습니다.');
        }
    });
}

// 2단계: 법정동 선택 후 아파트 목록 조회
function performStep2() {
    const dongName = $('#dongSelect').val();
    
    if (!dongName || !currentRegionCode) {
        showError('법정동을 선택해주세요.');
        return;
    }
    
    showLoading();
    hideError();
    
    $.ajax({
        url: '/api/search/step2',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            region_code: currentRegionCode,
            dong_name: dongName
        }),
        success: function(response) {
            hideLoading();
            if (response.success) {
                currentDongName = dongName;
                displayStep2Results(response);
                enableStep3();
            } else {
                showError(response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('아파트 목록 조회 중 오류가 발생했습니다.');
        }
    });
}

// 3단계: 아파트 선택 후 거래기록 조회
function performStep3() {
    const aptName = $('#apartmentSelect').val();
    
    if (!aptName || !currentRegionCode) {
        showError('아파트를 선택해주세요.');
        return;
    }
    
    showLoading();
    hideError();
    
    $.ajax({
        url: '/api/search/step3',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            region_code: currentRegionCode,
            apt_name: aptName
        }),
        success: function(response) {
            hideLoading();
            if (response.success) {
                currentApartmentName = aptName;
                displayStep3Results(response);
            } else {
                showError(response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('거래기록 조회 중 오류가 발생했습니다.');
        }
    });
}

// 결과 표시 함수들
function displayStep1Results(response) {
    const dongList = response.dong_list;
    const totalCount = response.total_count;
    const fromCache = response.from_cache;
    
    // 법정동 선택 옵션 업데이트
    $('#dongSelect').find('option:not(:first)').remove();
    dongList.forEach(dong => {
        $('#dongSelect').append(`<option value="${dong}">${dong}</option>`);
    });
    $('#dongSelect').prop('disabled', false);
    
    // 요약 정보 표시
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">총 거래건수</h6>
                    <h4 class="text-primary">${totalCount.toLocaleString()}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">법정동 수</h6>
                    <h4 class="text-success">${dongList.length}개</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">데이터 출처</h6>
                    <h4 class="text-info">${fromCache ? '캐시' : 'API'}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">조회 기간</h6>
                    <h4 class="text-warning">24개월</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#step1Summary').html(summaryHtml);
    $('#step1Results').removeClass('d-none');
}

function displayStep2Results(response) {
    const apartmentList = response.apartment_list;
    const dongName = response.dong_name;
    
    // 아파트 선택 옵션 업데이트
    $('#apartmentSelect').find('option:not(:first)').remove();
    apartmentList.forEach(apt => {
        $('#apartmentSelect').append(`<option value="${apt.apt_name}">${apt.apt_name} (${apt.transaction_count}건)</option>`);
    });
    $('#apartmentSelect').prop('disabled', false);
    
    // 요약 정보 표시
    const totalApartments = apartmentList.length;
    const totalTransactions = apartmentList.reduce((sum, apt) => sum + apt.transaction_count, 0);
    const avgPrice = apartmentList.length > 0 ? 
        Math.round(apartmentList.reduce((sum, apt) => sum + apt.avg_price, 0) / apartmentList.length) : 0;
    
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">법정동</h6>
                    <h4 class="text-primary">${dongName}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">아파트 수</h6>
                    <h4 class="text-success">${totalApartments}개</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">총 거래건수</h6>
                    <h4 class="text-info">${totalTransactions}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">평균 가격</h6>
                    <h4 class="text-warning">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#step2Summary').html(summaryHtml);
    $('#step2Results').removeClass('d-none');
}

function displayStep3Results(response) {
    const transactions = response.transactions;
    const aptName = response.apt_name;
    
    // 요약 정보 표시
    const totalTransactions = transactions.length;
    const avgPrice = totalTransactions > 0 ? 
        Math.round(transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / totalTransactions) : 0;
    const minPrice = totalTransactions > 0 ? Math.min(...transactions.map(tx => tx.price_per_area)) : 0;
    const maxPrice = totalTransactions > 0 ? Math.max(...transactions.map(tx => tx.price_per_area)) : 0;
    
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">아파트명</h6>
                    <h4 class="text-primary">${aptName}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">총 거래건수</h6>
                    <h4 class="text-success">${totalTransactions}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">평균 가격</h6>
                    <h4 class="text-info">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">가격 범위</h6>
                    <h4 class="text-warning">${Math.round(minPrice / 10000).toLocaleString()}~${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#step3Summary').html(summaryHtml);
    $('#step3Results').removeClass('d-none');
}

// 단계 활성화 함수들
function enableStep2() {
    $('#step2Card').css('opacity', '1');
}

function enableStep3() {
    $('#step3Card').css('opacity', '1');
}

// 기존 함수들 (필요한 것들만 유지)
function loadDistricts(city) {
    if (!city) {
        $('#districtSelect').prop('disabled', true).find('option:not(:first)').remove();
        return;
    }
    
    $.ajax({
        url: `/api/districts/${encodeURIComponent(city)}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const districts = response.districts;
                $('#districtSelect').find('option:not(:first)').remove();
                districts.forEach(district => {
                    $('#districtSelect').append(`<option value="${district}">${district}</option>`);
                });
                $('#districtSelect').prop('disabled', false);
            } else {
                showError('군/구 목록을 불러오는데 실패했습니다.');
            }
        },
        error: function() {
            showError('군/구 목록을 불러오는 중 오류가 발생했습니다.');
        }
    });
}

function addToFavorites(aptName, regionCode, regionName, buildYear, event) {
    event.stopPropagation();
    
    // 중복 등록 확인
    $.ajax({
        url: '/api/favorites/check',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            apt_name: aptName,
            region_code: regionCode
        }),
        success: function(response) {
            if (response.exists) {
                showToast('이미 등록된 관심단지입니다.', 'warning');
                return;
            }
            
            // 관심단지 등록
            $.ajax({
                url: '/api/favorites',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    apt_name: aptName,
                    region_code: regionCode,
                    region_name: regionName,
                    build_year: buildYear
                }),
                success: function(response) {
                    if (response.success) {
                        showToast(`${aptName}이(가) 관심단지로 등록되었습니다.`, 'success');
                        // 버튼 상태 변경
                        const button = event.target.closest('button');
                        button.innerHTML = '<i class="fas fa-heart me-1"></i>등록완료';
                        button.classList.remove('btn-outline-success');
                        button.classList.add('btn-success');
                        button.disabled = true;
                    } else {
                        showToast('관심단지 등록에 실패했습니다: ' + response.message, 'error');
                    }
                },
                error: function() {
                    showToast('관심단지 등록 중 오류가 발생했습니다.', 'error');
                }
            });
        },
        error: function() {
            showToast('관심단지 확인 중 오류가 발생했습니다.', 'error');
        }
    });
}
</script>
{% endblock %}

            if (response.success) {
                searchData = response.data;
                console.log('searchData 설정 완료, 길이:', searchData.length);
                displaySearchResults(response);
                
                // 데모 데이터 여부 확인
                if (response.is_demo) {
                    showToast(`${response.total_count}건의 아파트를 찾았습니다. (데모 데이터)`, 'warning');
                } else {
                    showToast(`${response.total_count}건의 아파트를 찾았습니다.`, 'success');
                }
            } else {
                showError(response.message);
            }
        },
        error: function(xhr, status, error) {
            $('#loadingSpinner').addClass('d-none');
            showError('검색 중 오류가 발생했습니다.');
        }
    });
}

function displaySearchResults(response) {
    console.log('displaySearchResults 호출됨');
    console.log('response:', response);
    
    // 데모 데이터 경고 표시
    if (response.is_demo) {
        $('#demoDataWarning').removeClass('d-none');
    } else {
        $('#demoDataWarning').addClass('d-none');
    }

    // 지역코드 필터링 확인 (추가 안전장치)
    const expectedRegionCode = response.region_code;
    if (expectedRegionCode && response.data) {
        const originalLength = response.data.length;
        response.data = response.data.filter(tx => tx.region_code === expectedRegionCode);
        console.log(`지역코드 필터링: ${expectedRegionCode}, 원본: ${originalLength}, 필터링 후: ${response.data.length}`);
    }

    // 요약 정보 표시
    console.log('요약 정보 표시 시작');
    displaySearchSummary(response);

    // 법정동별 분류된 결과 표시
    if (response.classified_data) {
        console.log('법정동별 분류 결과 표시');
        displayClassifiedResults(response.classified_data);
    } else {
        console.log('아파트 목록 표시');
        // 기존 방식으로 아파트 목록 표시
        displayApartmentList(response.data);
    }

    console.log('검색 결과 영역 표시');
    $('#searchResults').removeClass('d-none');
}

function displaySearchSummary(response) {
    const regionName = response.region_name;
    const totalCount = response.total_count;
    
    // 아파트별 통계 계산
    const apartmentStats = {};
    response.data.forEach(tx => {
        const key = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentStats[key]) {
            apartmentStats[key] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                transactions: [],
                build_year: tx.build_year
            };
        }
        apartmentStats[key].transactions.push(tx);
    });

    const apartmentCount = Object.keys(apartmentStats).length;
    const avgPrice = response.data.length > 0 ? 
        response.data.reduce((sum, tx) => sum + tx.price_per_area, 0) / response.data.length : 0;

    const summaryHtml = `
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-primary mb-0">${regionName}</div>
                <small class="text-muted">검색 지역</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-success mb-0">${apartmentCount}</div>
                <small class="text-muted">검색된 아파트</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-info mb-0">${totalCount}</div>
                <small class="text-muted">총 거래건수</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center">
                <div class="h2 text-warning mb-0">${Math.round(avgPrice / 10000).toLocaleString()}</div>
                <small class="text-muted">평균 평당가격 (만원)</small>
            </div>
        </div>
    `;
    $('#searchSummary').html(summaryHtml);
}

function displayClassifiedResults(classifiedData) {
    console.log('displayClassifiedResults 호출됨, classifiedData:', classifiedData);
    
    // 분류된 데이터를 전역 변수에 저장
    currentClassifiedData = classifiedData;
    
    // 법정동별 탭에 데이터 표시
    displayDongTab(classifiedData);
    
    // 월별 탭에 데이터 표시
    displayMonthTab(searchData);
    
    // 아파트별 탭에 데이터 표시
    displayApartmentTab(searchData);
}

function displayDongTab(classifiedData) {
    console.log('법정동별 탭 표시 시작');
    
    const container = $('#dongContent');
    container.empty();
    
    // 지역코드 필터링 (추가 안전장치)
    const expectedRegionCode = searchData.length > 0 ? searchData[0].region_code : null;
    console.log('expectedRegionCode:', expectedRegionCode);
    
    let html = '<div class="accordion" id="dongAccordion">';
    
    Object.entries(classifiedData).forEach(([dongName, dongData], index) => {
        console.log(`동 처리 중: ${dongName}, 데이터:`, dongData);
        const accordionId = `dong-${index}`;
        const collapseId = `collapse-${index}`;
        
        // 해당 동의 모든 거래 데이터 수집
        const dongTransactions = [];
        Object.values(dongData.months).forEach(monthData => {
            dongTransactions.push(...monthData.transactions);
        });
        
        // 월별 및 아파트별 필터 옵션 생성
        const monthOptions = Object.keys(dongData.months).sort().reverse();
        const apartmentOptions = [...new Set(dongTransactions.map(tx => tx.apt_name))].sort();
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${dongName}</strong>
                                <span class="badge bg-primary ms-2">${dongData.total_count}건</span>
                            </div>
                            <div class="text-muted small">
                                ${Object.keys(dongData.months).length}개월 거래
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="heading-${index}" data-bs-parent="#dongAccordion">
                    <div class="accordion-body">
                        <!-- 필터 섹션 -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-calendar-alt me-1"></i>월별 필터</label>
                                <select class="form-select form-select-sm" id="monthFilter-${index}" onchange="filterDongData('${dongName}', 'month', this.value, ${index})">
                                    <option value="">전체 월</option>
                                    ${monthOptions.map(month => {
                                        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
                                        return `<option value="${month}">${monthName}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-building me-1"></i>아파트별 필터</label>
                                <select class="form-select form-select-sm" id="apartmentFilter-${index}" onchange="filterDongData('${dongName}', 'apartment', this.value, ${index})">
                                    <option value="">전체 아파트</option>
                                    ${apartmentOptions.map(apt => `<option value="${apt}">${apt}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetDongFilter(${index})">
                                    <i class="fas fa-undo me-1"></i>필터 초기화
                                </button>
                            </div>
                        </div>
                        
                        <!-- 필터링된 결과 표시 영역 -->
                        <div id="filteredContent-${index}">
                            ${generateMonthSections(dongData.months, expectedRegionCode)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // DOM에 강제로 적용
    console.log('HTML 적용 시작, 길이:', html.length);
    container.html(html);
    console.log('HTML 적용 완료');
    
    // DOM 업데이트 강제 실행
    container.trigger('DOMNodeInserted');
    console.log('DOM 업데이트 이벤트 트리거');
    
    // Bootstrap accordion 초기화
    console.log('Bootstrap accordion 초기화 시작');
    
    // DOM 업데이트를 기다리는 함수
    const waitForAccordion = (attempts = 0) => {
        const accordionElement = document.getElementById('dongAccordion');
        console.log(`Accordion 요소 찾기 시도 ${attempts + 1}, 결과:`, accordionElement);
        
        if (accordionElement) {
            console.log('Accordion 요소 찾음, 초기화 시도');
            // 첫 번째 accordion item을 열어둠
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
                console.log('첫 번째 아코디언 아이템 열기 완료');
            } else {
                console.log('첫 번째 collapse 요소를 찾을 수 없음');
            }
        } else if (attempts < 10) {
            // 최대 10번까지 재시도 (총 1초)
            setTimeout(() => waitForAccordion(attempts + 1), 100);
        } else {
            console.log('Accordion 요소를 찾을 수 없음 - 최대 재시도 횟수 초과');
            // 디버깅을 위해 컨테이너 내용 확인
            console.log('컨테이너 내용:', container.html());
        }
    };
    
    // 즉시 첫 번째 시도
    waitForAccordion();
}

function generateMonthSections(months, expectedRegionCode = null) {
    let html = '';
    
    // 월별로 정렬 (최신순)
    const sortedMonths = Object.entries(months).sort((a, b) => {
        const [yearA, monthA] = a[0].replace('년', '').replace('월', '').split(' ');
        const [yearB, monthB] = b[0].replace('년', '').replace('월', '').split(' ');
        return (parseInt(yearB) * 12 + parseInt(monthB)) - (parseInt(yearA) * 12 + parseInt(monthA));
    });
    
    sortedMonths.forEach(([monthKey, monthData]) => {
        html += `
            <div class="mb-4">
                <h5 class="text-primary border-bottom pb-2">
                    ${monthData.month_display}
                    <span class="badge bg-success ms-2">${monthData.count}건</span>
                    <span class="badge bg-warning text-dark ms-1">
                        평균 ${formatPrice(Math.round(monthData.avg_price))}/㎡
                    </span>
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <small class="text-muted">
                            최저: ${formatPrice(Math.round(monthData.min_price))}/㎡
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">
                            최고: ${formatPrice(Math.round(monthData.max_price))}/㎡
                        </small>
                    </div>
                </div>
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>아파트명</th>
                                <th>거래일</th>
                                <th>층수</th>
                                <th>면적</th>
                                <th>거래가</th>
                                <th>평당가격</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // 거래일 기준으로 정렬 (최신순)
        let sortedTransactions = monthData.transactions.sort((a, b) => 
            new Date(b.deal_date) - new Date(a.deal_date)
        );
        
        // 지역코드 필터링 (추가 안전장치)
        if (expectedRegionCode) {
            sortedTransactions = sortedTransactions.filter(tx => tx.region_code === expectedRegionCode);
        }
        
        sortedTransactions.forEach(tx => {
            html += `
                <tr>
                    <td>
                        <strong>${tx.apt_name}</strong>
                        ${tx.apt_dong ? `<br><small class="text-muted">${tx.apt_dong}</small>` : ''}
                        <br><small class="text-muted">${tx.build_year}년</small>
                    </td>
                    <td>${tx.deal_date}</td>
                    <td>${tx.floor}층</td>
                    <td>${tx.exclusive_area}㎡</td>
                    <td><strong>${formatPrice(tx.deal_amount)}</strong></td>
                    <td>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    return html;
}

function displayApartmentList(data) {
    console.log('displayApartmentList 호출됨, 데이터 길이:', data.length);
    
    const tbody = $('#apartmentTable tbody');
    tbody.empty();

    // 지역코드 필터링 (추가 안전장치)
    const expectedRegionCode = data.length > 0 ? data[0].region_code : null;
    if (expectedRegionCode) {
        const originalLength = data.length;
        data = data.filter(tx => tx.region_code === expectedRegionCode);
        console.log(`아파트 목록 지역코드 필터링: ${expectedRegionCode}, 원본: ${originalLength}, 필터링 후: ${data.length}`);
    }

    // 아파트별 통계 계산
    const apartmentStats = {};
    data.forEach(tx => {
        const key = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentStats[key]) {
            apartmentStats[key] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                region_name: tx.region_name,
                transactions: [],
                build_year: tx.build_year
            };
        }
        apartmentStats[key].transactions.push(tx);
    });

    // 평균 가격 기준으로 정렬
    const sortedApartments = Object.values(apartmentStats).sort((a, b) => {
        const avgA = a.transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / a.transactions.length;
        const avgB = b.transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / b.transactions.length;
        return avgB - avgA;
    });

    console.log('아파트 통계 계산 완료, 아파트 수:', sortedApartments.length);
    console.log('아파트 목록:', sortedApartments.map(apt => apt.name));

    sortedApartments.forEach(apt => {
        const avgPrice = apt.transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / apt.transactions.length;
        const latestTx = apt.transactions.sort((a, b) => new Date(b.deal_date) - new Date(a.deal_date))[0];
        
        const row = `
            <tr>
                <td><strong>${apt.name}</strong></td>
                <td>${apt.region_name}</td>
                <td>${apt.build_year}년</td>
                <td>${latestTx.deal_date}</td>
                <td><strong>${Math.round(avgPrice / 10000).toLocaleString()}만원</strong></td>
                <td><span class="badge bg-primary">${apt.transactions.length}</span></td>
                <td>
                    <i class="fas fa-heart favorite-btn" 
                       onclick="toggleFavorite('${apt.name}', '${apt.region_code}', false)"
                       title="관심단지 추가"></i>
                </td>
                <td>
                    <a href="/apartment/${encodeURIComponent(apt.name)}/${apt.region_code}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chart-line me-1"></i>상세보기
                    </a>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function showError(message) {
    $('#errorText').text(message);
    $('#errorMessage').removeClass('d-none');
}

function exportToCSV() {
    if (searchData.length === 0) {
        showToast('내보낼 데이터가 없습니다.', 'warning');
        return;
    }

    // CSV 헤더
    const headers = ['아파트명', '지역', '거래일', '거래금액', '전용면적', '평당가격', '층', '건축년도'];
    
    // CSV 데이터
    const csvData = searchData.map(tx => [
        tx.apt_name,
        tx.region_name,
        tx.deal_date,
        tx.deal_amount,
        tx.exclusive_area,
        Math.round(tx.price_per_area / 10000),
        tx.floor,
        tx.build_year
    ]);

    // CSV 문자열 생성
    const csvContent = [headers, ...csvData]
        .map(row => row.map(field => `"${field}"`).join(','))
        .join('\n');

    // 파일 다운로드
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `apartment_data_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('CSV 파일이 다운로드되었습니다.', 'success');
}

function displayMonthTab(data) {
    console.log('월별 탭 표시 시작, 데이터 길이:', data.length);
    
    const container = $('#monthContent');
    container.empty();
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">표시할 데이터가 없습니다.</div>');
        return;
    }
    
    // 월별로 데이터 그룹핑
    const monthlyData = {};
    data.forEach(tx => {
        const monthKey = `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = [];
        }
        monthlyData[monthKey].push(tx);
    });
    
    // 월별로 정렬 (최신순)
    const sortedMonths = Object.keys(monthlyData).sort().reverse();
    
    // 전체 법정동 목록 수집 (필터용)
    const allDongs = [...new Set(data.map(tx => tx.umd_nm || '기타'))].sort();
    
    let html = `
        <!-- 월별 탭 안내 -->
        <div class="alert alert-info alert-sm mb-3">
            <i class="fas fa-info-circle me-1"></i>
            <strong>월별 분석:</strong> 선택한 지역의 월별 거래 동향을 확인하세요.
        </div>
        
        <div class="accordion" id="monthAccordion">`;
    
    sortedMonths.forEach((month, index) => {
        const monthData = monthlyData[month];
        const monthName = `${month.substring(0, 4)}년 ${month.substring(5, 7)}월`;
        const collapseId = `month-collapse-${index}`;
        
        // 월별 통계 계산
        const totalCount = monthData.length;
        const avgPrice = monthData.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...monthData.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...monthData.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="month-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${monthName}</strong>
                                <span class="badge bg-success ms-2">${totalCount}건</span>
                            </div>
                            <div class="text-muted small">
                                평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="month-heading-${index}" data-bs-parent="#monthAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>아파트명</th>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthData.map(tx => `
                                        <tr>
                                            <td><strong>${tx.apt_name}</strong></td>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('monthAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

function displayApartmentTab(data) {
    console.log('아파트별 탭 표시 시작, 데이터 길이:', data.length);
    
    const container = $('#apartmentContent');
    container.empty();
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">표시할 데이터가 없습니다.</div>');
        return;
    }
    
    // 아파트별로 데이터 그룹핑
    const apartmentData = {};
    data.forEach(tx => {
        const aptKey = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentData[aptKey]) {
            apartmentData[aptKey] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                region_name: tx.region_name,
                build_year: tx.build_year,
                transactions: []
            };
        }
        apartmentData[aptKey].transactions.push(tx);
    });
    
    // 거래건수 기준으로 정렬
    const sortedApartments = Object.values(apartmentData).sort((a, b) => b.transactions.length - a.transactions.length);
    
    // 전체 법정동 목록 수집 (필터용)
    const allDongs = [...new Set(data.map(tx => tx.umd_nm || '기타'))].sort();
    
    let html = `
        <!-- 아파트별 탭 안내 -->
        <div class="alert alert-info alert-sm mb-3">
            <i class="fas fa-info-circle me-1"></i>
            <strong>아파트별 분석:</strong> 관심있는 아파트를 선택하여 관심단지로 등록하세요.
        </div>
        
        <div class="accordion" id="apartmentAccordion">`;
    
    sortedApartments.forEach((apt, index) => {
        const collapseId = `apt-collapse-${index}`;
        const totalCount = apt.transactions.length;
        
        // 아파트별 통계 계산
        const avgPrice = apt.transactions.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...apt.transactions.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...apt.transactions.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="apt-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${apt.name}</strong>
                                <span class="badge bg-primary ms-2">${totalCount}건</span>
                                <small class="text-muted ms-2">(${apt.build_year}년)</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="text-muted small me-3">
                                    평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                                </div>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="addToFavorites('${apt.name}', '${apt.region_code}', '${apt.region_name}', '${apt.build_year}', event)">
                                    <i class="fas fa-heart me-1"></i>관심단지 등록
                                </button>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="apt-heading-${index}" data-bs-parent="#apartmentAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">거래 내역</h6>
                            <div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${apt.transactions.sort((a, b) => new Date(b.deal_date) - new Date(a.deal_date)).map(tx => `
                                        <tr>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('apartmentAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

// 법정동별 필터링 함수들
function filterDongData(dongName, filterType, filterValue, dongIndex) {
    console.log(`필터링: ${dongName}, 타입: ${filterType}, 값: ${filterValue}`);
    
    // 해당 동의 원본 데이터 찾기
    const classifiedData = getCurrentClassifiedData();
    if (!classifiedData || !classifiedData[dongName]) {
        console.log('해당 동의 데이터를 찾을 수 없음');
        return;
    }
    
    const dongData = classifiedData[dongName];
    let filteredData = { ...dongData };
    
    if (filterType === 'month' && filterValue) {
        // 월별 필터링
        filteredData.months = { [filterValue]: dongData.months[filterValue] };
        filteredData.total_count = dongData.months[filterValue] ? dongData.months[filterValue].transactions.length : 0;
    } else if (filterType === 'apartment' && filterValue) {
        // 아파트별 필터링
        const filteredMonths = {};
        Object.entries(dongData.months).forEach(([month, monthData]) => {
            const filteredTransactions = monthData.transactions.filter(tx => tx.apt_name === filterValue);
            if (filteredTransactions.length > 0) {
                filteredMonths[month] = {
                    ...monthData,
                    transactions: filteredTransactions,
                    count: filteredTransactions.length
                };
            }
        });
        filteredData.months = filteredMonths;
        filteredData.total_count = Object.values(filteredMonths).reduce((sum, month) => sum + month.count, 0);
    }
    
    // 필터링된 결과 표시
    const container = $(`#filteredContent-${dongIndex}`);
    const expectedRegionCode = searchData.length > 0 ? searchData[0].region_code : null;
    container.html(generateMonthSections(filteredData.months, expectedRegionCode));
    
    // 필터 상태 표시
    updateFilterStatus(dongIndex, filterType, filterValue);
}

function resetDongFilter(dongIndex) {
    console.log(`필터 초기화: 동 인덱스 ${dongIndex}`);
    
    // 필터 선택값 초기화
    $(`#monthFilter-${dongIndex}`).val('');
    $(`#apartmentFilter-${dongIndex}`).val('');
    
    // 원본 데이터로 복원
    const classifiedData = getCurrentClassifiedData();
    const dongNames = Object.keys(classifiedData);
    const dongName = dongNames[dongIndex];
    
    if (dongName && classifiedData[dongName]) {
        const dongData = classifiedData[dongName];
        const container = $(`#filteredContent-${dongIndex}`);
        const expectedRegionCode = searchData.length > 0 ? searchData[0].region_code : null;
        container.html(generateMonthSections(dongData.months, expectedRegionCode));
        
        // 필터 상태 초기화
        updateFilterStatus(dongIndex, '', '');
    }
}

function updateFilterStatus(dongIndex, filterType, filterValue) {
    const statusContainer = $(`#filterStatus-${dongIndex}`);
    if (statusContainer.length === 0) {
        // 상태 표시 영역이 없으면 생성
        const statusHtml = `
            <div class="alert alert-info alert-sm mb-3" id="filterStatus-${dongIndex}">
                <i class="fas fa-info-circle me-1"></i>
                <span id="filterStatusText-${dongIndex}">필터가 적용되지 않음</span>
            </div>
        `;
        $(`#filteredContent-${dongIndex}`).before(statusHtml);
    }
    
    let statusText = '필터가 적용되지 않음';
    if (filterType === 'month' && filterValue) {
        const monthName = `${filterValue.substring(0, 4)}년 ${filterValue.substring(5, 7)}월`;
        statusText = `월별 필터 적용: ${monthName}`;
    } else if (filterType === 'apartment' && filterValue) {
        statusText = `아파트별 필터 적용: ${filterValue}`;
    }
    
    $(`#filterStatusText-${dongIndex}`).text(statusText);
}

function getCurrentClassifiedData() {
    // 전역 변수에 저장된 분류된 데이터가 있으면 반환
    if (currentClassifiedData) {
        return currentClassifiedData;
    }
    
    // 전역 변수가 없으면 searchData를 다시 분류하여 반환
    if (searchData.length === 0) return null;
    
    const classified = {};
    searchData.forEach(tx => {
        const dongName = tx.umd_nm || '기타';
        if (!classified[dongName]) {
            classified[dongName] = {
                dong_name: dongName,
                months: {},
                total_count: 0
            };
        }
        
        const monthKey = `${tx.deal_year}-${tx.deal_month.toString().padStart(2, '0')}`;
        if (!classified[dongName].months[monthKey]) {
            classified[dongName].months[monthKey] = {
                month: monthKey,
                transactions: [],
                count: 0,
                min_price: Infinity,
                max_price: 0
            };
        }
        
        classified[dongName].months[monthKey].transactions.push(tx);
        classified[dongName].months[monthKey].count++;
        classified[dongName].total_count++;
        
        // 가격 범위 업데이트
        const price = tx.price_per_area || 0;
        if (price < classified[dongName].months[monthKey].min_price) {
            classified[dongName].months[monthKey].min_price = price;
        }
        if (price > classified[dongName].months[monthKey].max_price) {
            classified[dongName].months[monthKey].max_price = price;
        }
    });
    
    // 무한대 처리
    Object.values(classified).forEach(dongData => {
        Object.values(dongData.months).forEach(monthData => {
            if (monthData.min_price === Infinity) {
                monthData.min_price = 0;
            }
        });
    });
    
    return classified;
}




function displayApartmentTabWithFilter(data, filterDong) {
    console.log('필터링된 아파트별 탭 표시:', filterDong, '데이터 길이:', data.length);
    
    const container = $('#apartmentContent');
    
    if (!data || data.length === 0) {
        container.html('<div class="text-center text-muted py-4">해당 법정동의 거래 데이터가 없습니다.</div>');
        return;
    }
    
    // 아파트별로 데이터 그룹핑
    const apartmentData = {};
    data.forEach(tx => {
        const aptKey = `${tx.apt_name}_${tx.region_code}`;
        if (!apartmentData[aptKey]) {
            apartmentData[aptKey] = {
                name: tx.apt_name,
                region_code: tx.region_code,
                region_name: tx.region_name,
                build_year: tx.build_year,
                transactions: []
            };
        }
        apartmentData[aptKey].transactions.push(tx);
    });
    
    // 거래건수 기준으로 정렬
    const sortedApartments = Object.values(apartmentData).sort((a, b) => b.transactions.length - a.transactions.length);
    
    let html = `
        <!-- 아파트별 탭 필터 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-map-marker-alt me-1"></i>법정동별 필터</label>
                <select class="form-select form-select-sm" id="apartmentTabDongFilter" onchange="filterApartmentTabData(this.value)">
                    <option value="">전체 법정동</option>
                    ${[...new Set(searchData.map(tx => tx.umd_nm || '기타'))].sort().map(dong => 
                        `<option value="${dong}" ${dong === filterDong ? 'selected' : ''}>${dong}</option>`
                    ).join('')}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><i class="fas fa-filter me-1"></i>필터 초기화</label>
                <button class="btn btn-outline-secondary btn-sm w-100" onclick="resetApartmentTabFilter()">
                    <i class="fas fa-undo me-1"></i>필터 초기화
                </button>
            </div>
        </div>
        
        <!-- 필터 상태 표시 -->
        <div class="alert alert-info alert-sm mb-3" id="apartmentTabFilterStatus">
            <i class="fas fa-info-circle me-1"></i>
            <span id="apartmentTabFilterStatusText">법정동별 필터 적용: ${filterDong}</span>
        </div>
        
        <div class="accordion" id="apartmentAccordion">`;
    
    sortedApartments.forEach((apt, index) => {
        const collapseId = `apt-collapse-${index}`;
        const totalCount = apt.transactions.length;
        
        // 아파트별 통계 계산
        const avgPrice = apt.transactions.reduce((sum, tx) => sum + (tx.price_per_area || 0), 0) / totalCount;
        const minPrice = Math.min(...apt.transactions.map(tx => tx.price_per_area || 0));
        const maxPrice = Math.max(...apt.transactions.map(tx => tx.price_per_area || 0));
        
        html += `
            <div class="accordion-item">
                <h2 class="accordion-header" id="apt-heading-${index}">
                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                            aria-expanded="${index === 0 ? 'true' : 'false'}" 
                            aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 me-3">
                            <div>
                                <strong>${apt.name}</strong>
                                <span class="badge bg-primary ms-2">${totalCount}건</span>
                                <small class="text-muted ms-2">(${apt.build_year}년)</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="text-muted small me-3">
                                    평균 ${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡
                                </div>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="addToFavorites('${apt.name}', '${apt.region_code}', '${apt.region_name}', '${apt.build_year}', event)">
                                    <i class="fas fa-heart me-1"></i>관심단지 등록
                                </button>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                     aria-labelledby="apt-heading-${index}" data-bs-parent="#apartmentAccordion">
                    <div class="accordion-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">총 거래건수</h6>
                                        <h4 class="text-primary">${totalCount}건</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">평균 가격</h6>
                                        <h4 class="text-success">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최저 가격</h6>
                                        <h4 class="text-info">${Math.round(minPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">최고 가격</h6>
                                        <h4 class="text-warning">${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">거래 내역</h6>
                            <div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>거래일</th>
                                        <th>거래금액</th>
                                        <th>전용면적</th>
                                        <th>평당가격</th>
                                        <th>층</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${apt.transactions.sort((a, b) => new Date(b.deal_date) - new Date(a.deal_date)).map(tx => `
                                        <tr>
                                            <td>${tx.deal_date}</td>
                                            <td>${formatPrice(tx.deal_amount)}</td>
                                            <td>${tx.exclusive_area}㎡</td>
                                            <td><strong>${Math.round(tx.price_per_area / 10000).toLocaleString()}만원/㎡</strong></td>
                                            <td>${tx.floor}층</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.html(html);
    
    // Bootstrap accordion 초기화
    setTimeout(() => {
        const accordionElement = document.getElementById('apartmentAccordion');
        if (accordionElement) {
            const firstCollapse = accordionElement.querySelector('.accordion-collapse');
            if (firstCollapse) {
                firstCollapse.classList.add('show');
                const firstButton = accordionElement.querySelector('.accordion-button');
                if (firstButton) {
                    firstButton.classList.remove('collapsed');
                    firstButton.setAttribute('aria-expanded', 'true');
                }
            }
        }
    }, 100);
}

function resetApartmentTabFilter() {
    console.log('아파트별 탭 필터 초기화');
    displayApartmentTab(searchData);
}

// 관심단지 등록 함수
function addToFavorites(aptName, regionCode, regionName, buildYear, event) {
    event.stopPropagation(); // 아코디언 토글 방지
    
    console.log('관심단지 등록:', aptName, regionCode, regionName, buildYear);
    
    // 중복 등록 확인
    $.ajax({
        url: '/api/favorites/check',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            apt_name: aptName,
            region_code: regionCode
        }),
        success: function(response) {
            if (response.exists) {
                showToast('이미 등록된 관심단지입니다.', 'warning');
                return;
            }
            
            // 관심단지 등록
            $.ajax({
                url: '/api/favorites',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    apt_name: aptName,
                    region_code: regionCode,
                    region_name: regionName,
                    build_year: buildYear
                }),
                success: function(response) {
                    if (response.success) {
                        showToast(`${aptName}이(가) 관심단지로 등록되었습니다.`, 'success');
                        // 버튼 상태 변경
                        const button = event.target.closest('button');
                        button.innerHTML = '<i class="fas fa-heart me-1"></i>등록완료';
                        button.classList.remove('btn-outline-success');
                        button.classList.add('btn-success');
                        button.disabled = true;
                    } else {
                        showToast('관심단지 등록에 실패했습니다: ' + response.message, 'error');
                    }
                },
                error: function() {
                    showToast('관심단지 등록 중 오류가 발생했습니다.', 'error');
                }
            });
        },
        error: function() {
            showToast('관심단지 확인 중 오류가 발생했습니다.', 'error');
        }
    });
}
</script>
{% endblock %}
