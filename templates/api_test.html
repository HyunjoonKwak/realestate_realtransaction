{% extends "base.html" %}

{% block title %}API 테스트 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-flask text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">국토부 API 테스트</h1>
                <p class="text-muted mb-0">지역코드로 직접 국토부 API 호출 테스트</p>
            </div>
        </div>
    </div>
</div>

<!-- 테스트 폼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>API 호출 테스트
                </h5>
            </div>
            <div class="card-body">
                <!-- API 타입 선택 탭 -->
                <ul class="nav nav-tabs mb-3" id="apiTypeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sale-api-tab" data-bs-toggle="tab" data-bs-target="#sale-api-pane" type="button" role="tab">
                            <i class="fas fa-home me-1"></i>매매 API 테스트
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rent-api-tab" data-bs-toggle="tab" data-bs-target="#rent-api-pane" type="button" role="tab">
                            <i class="fas fa-key me-1"></i>전월세 API 테스트
                        </button>
                    </li>
                </ul>

                <!-- API 테스트 탭 컨텐츠 -->
                <div class="tab-content" id="apiTypeTabContent">
                    <!-- 매매 API 테스트 -->
                    <div class="tab-pane fade show active" id="sale-api-pane" role="tabpanel">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>매매 API:</strong> 아파트 매매 실거래가 정보를 조회합니다.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="saleRegionCode" class="form-label">지역코드 (5자리)</label>
                                    <input type="text" class="form-control" id="saleRegionCode" placeholder="예: 52113" maxlength="5">
                                    <div class="form-text">전북특별자치도 전주시: 52113, 서울 강남구: 11680</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="saleDealYmd" class="form-label">거래년월 (YYYYMM)</label>
                                    <input type="text" class="form-control" id="saleDealYmd" placeholder="예: 202409" maxlength="6">
                                    <div class="form-text">현재: 202409 (2024년 9월)</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" id="saleTestBtn">
                                    <i class="fas fa-play me-1"></i>매매 API 호출 테스트
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearSaleForm()">
                                    <i class="fas fa-undo me-1"></i>초기화
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 전월세 API 테스트 -->
                    <div class="tab-pane fade" id="rent-api-pane" role="tabpanel">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>전월세 API:</strong> 아파트 전세/월세 실거래가 정보를 조회합니다.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="rentRegionCode" class="form-label">지역코드 (5자리)</label>
                                    <input type="text" class="form-control" id="rentRegionCode" placeholder="예: 52113" maxlength="5">
                                    <div class="form-text">전북특별자치도 전주시: 52113, 서울 강남구: 11680</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="rentDealYmd" class="form-label">거래년월 (YYYYMM)</label>
                                    <input type="text" class="form-control" id="rentDealYmd" placeholder="예: 202409" maxlength="6">
                                    <div class="form-text">현재: 202409 (2024년 9월)</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-warning" id="rentTestBtn">
                                    <i class="fas fa-play me-1"></i>전월세 API 호출 테스트
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearRentForm()">
                                    <i class="fas fa-undo me-1"></i>초기화
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 스피너 -->
<div id="loadingSpinner" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">API 호출 중...</span>
    </div>
    <p class="mt-2">국토부 API를 호출하고 있습니다...</p>
</div>

<!-- 결과 표시 -->
<div id="results" class="d-none">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>API 호출 결과
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 요청 정보 -->
                    <div class="mb-3">
                        <h6><i class="fas fa-paper-plane me-2"></i>요청 정보</h6>
                        <div class="row" id="requestInfo">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>

                    <!-- Request URL -->
                    <div class="mb-3">
                        <h6><i class="fas fa-link me-2"></i>Request URL</h6>
                        <div class="alert alert-secondary" id="requestUrl">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>

                    <!-- 요약 정보 -->
                    <div class="mb-3">
                        <h6><i class="fas fa-chart-bar me-2"></i>응답 요약</h6>
                        <div class="row" id="summaryInfo">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>

                    <!-- 원본 요청 -->
                    <div class="mb-3">
                        <h6><i class="fas fa-upload me-2"></i>원본 요청 데이터</h6>
                        <pre id="rawRequest" class="bg-info bg-opacity-10 p-3 border border-info border-opacity-25" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;"></pre>
                    </div>

                    <!-- 원본 응답 -->
                    <div class="mb-3">
                        <h6><i class="fas fa-code me-2"></i>원본 XML 응답</h6>
                        <div class="mb-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="formatXml()">
                                <i class="fas fa-magic me-1"></i>XML 포맷팅
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyXmlToClipboard()">
                                <i class="fas fa-copy me-1"></i>복사
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleXmlView()">
                                <i class="fas fa-expand me-1"></i>전체화면
                            </button>
                        </div>
                        <pre id="rawResponse" class="bg-light p-3 border rounded" style="max-height: 500px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;"></pre>
                    </div>
                    
                    <!-- 파싱된 데이터 -->
                    <div class="mb-3">
                        <h6><i class="fas fa-table me-2"></i>파싱된 거래 데이터</h6>
                        <div id="parsedData" style="max-height: 400px; overflow-y: auto;">
                            <!-- 동적으로 채워짐 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 오류 메시지 -->
<div id="errorMessage" class="alert alert-danger d-none">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> API 호출 오류</h5>
    <p id="errorText" class="mb-0"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 현재 날짜 설정
    const now = new Date();
    const currentMonth = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0');
    $('#saleDealYmd').val(currentMonth);
    $('#rentDealYmd').val(currentMonth);

    // 매매 테스트 버튼 클릭
    $('#saleTestBtn').on('click', function() {
        performApiTest('sale');
    });

    // 전월세 테스트 버튼 클릭
    $('#rentTestBtn').on('click', function() {
        performApiTest('rent');
    });

    // Enter 키 이벤트
    $('#saleRegionCode, #saleDealYmd').on('keypress', function(e) {
        if (e.which === 13) {
            performApiTest('sale');
        }
    });

    $('#rentRegionCode, #rentDealYmd').on('keypress', function(e) {
        if (e.which === 13) {
            performApiTest('rent');
        }
    });
});

function performApiTest(apiType) {
    let regionCode, dealYmd, apiTypeName, apiUrl;

    if (apiType === 'sale') {
        regionCode = $('#saleRegionCode').val().trim();
        dealYmd = $('#saleDealYmd').val().trim();
        apiTypeName = '매매';
        apiUrl = '/api/test/direct';
    } else if (apiType === 'rent') {
        regionCode = $('#rentRegionCode').val().trim();
        dealYmd = $('#rentDealYmd').val().trim();
        apiTypeName = '전월세';
        apiUrl = '/api/test/rental';
    }

    if (!regionCode || !dealYmd) {
        showError('지역코드와 거래년월을 모두 입력해주세요.');
        return;
    }

    if (regionCode.length !== 5) {
        showError('지역코드는 5자리여야 합니다.');
        return;
    }

    if (dealYmd.length !== 6) {
        showError('거래년월은 6자리(YYYYMM)여야 합니다.');
        return;
    }

    showLoading();
    hideError();
    hideResults();

    // 요청 데이터 저장
    const requestData = {
        region_code: regionCode,
        deal_ymd: dealYmd,
        api_type: apiType
    };

    $.ajax({
        url: apiUrl,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function(response) {
            hideLoading();
            console.log(`${apiTypeName} API 테스트 응답:`, response);

            if (response.success) {
                // 응답에 이미 original_request가 없는 경우에만 추가 (구 버전 호환성)
                if (!response.original_request) {
                    response.original_request = requestData;
                }
                // API 타입 정보 추가
                response.api_type = apiType;
                response.api_type_name = apiTypeName;
                displayResults(response);
            } else {
                showError(response.message || `${apiTypeName} API 호출에 실패했습니다.`);
            }
        },
        error: function(xhr, status, error) {
            hideLoading();
            console.error(`${apiTypeName} API 테스트 오류:`, xhr.responseText);
            showError(`${apiTypeName} API 호출 중 오류가 발생했습니다: ` + error);
        }
    });
}

function displayResults(response) {
    const data = response.data;
    const rawXml = response.raw_xml;
    const summary = response.summary;
    const requestInfo = response.request_info;
    const apiType = response.api_type || 'sale';
    const apiTypeName = response.api_type_name || '매매';

    // 요청 정보 표시
    const requestHtml = `
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">API 유형</h6>
                    <h5>${apiTypeName}</h5>
                    <small>${apiType === 'sale' ? '매매 거래' : '전월세 거래'}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">지역코드</h6>
                    <h5>${requestInfo.region_code}</h5>
                    <small>${requestInfo.region_name || requestInfo.region_code}</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">거래년월</h6>
                    <h5>${requestInfo.deal_ymd}</h5>
                    <small>${requestInfo.deal_ymd.substring(0,4)}년 ${requestInfo.deal_ymd.substring(4,6)}월</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">클라이언트 IP</h6>
                    <h5>${requestInfo.client_ip}</h5>
                    <small>요청 출처</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">요청 시간</h6>
                    <h5>${new Date().toLocaleTimeString()}</h5>
                    <small>현재 시각</small>
                </div>
            </div>
        </div>
    `;

    $('#requestInfo').html(requestHtml);

    // Request URL 표시
    const requestUrl = response.request_url || (apiType === 'sale' ?
        'https://apis.data.go.kr/1613000/RTMSDataSvcAptTradeDev/getRTMSDataSvcAptTradeDev' :
        'https://apis.data.go.kr/1613000/RTMSDataSvcAptRent/getRTMSDataSvcAptRent');

    const requestUrlHtml = `
        <div class="small mb-2"><strong>API Endpoint:</strong></div>
        <code class="d-block">${requestUrl}</code>
        <div class="small mt-2 text-muted">
            <strong>Parameters:</strong>
            LAWD_CD=${requestInfo.region_code},
            DEAL_YMD=${requestInfo.deal_ymd},
            serviceKey=***
        </div>
    `;
    $('#requestUrl').html(requestUrlHtml);

    // 응답 요약 정보 표시
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">지역코드</h6>
                    <h4 class="text-primary">${summary.region_code}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">거래년월</h6>
                    <h4 class="text-success">${summary.deal_ymd}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">거래건수</h6>
                    <h4 class="text-info">${summary.total_count}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">HTTP 상태</h6>
                    <h4 class="text-warning">${summary.http_status}</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#summaryInfo').html(summaryHtml);

    // 원본 요청 데이터 표시
    if (response.original_request) {
        const requestJson = JSON.stringify(response.original_request, null, 2);
        $('#rawRequest').text(requestJson);
    }

    // 원본 XML 표시 (자동 포맷팅)
    const formattedXml = formatXmlString(rawXml);
    $('#rawResponse').text(formattedXml);
    
    // 파싱된 데이터 표시
    let parsedHtml = '';
    if (data && data.length > 0) {
        if (apiType === 'sale') {
            // 매매 데이터 테이블
            parsedHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>아파트명</th>
                                <th>거래일</th>
                                <th>거래금액</th>
                                <th>전용면적</th>
                                <th>층</th>
                                <th>건축년도</th>
                                <th>법정동</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(item => {
                const dealAmount = Math.round(item.deal_amount / 10000);
                parsedHtml += `
                    <tr>
                        <td>${item.apt_name || '-'}</td>
                        <td>${item.deal_date || '-'}</td>
                        <td><strong>${dealAmount.toLocaleString()}만원</strong></td>
                        <td>${item.exclusive_area || '-'}㎡</td>
                        <td>${item.floor || '-'}층</td>
                        <td>${item.build_year || '-'}년</td>
                        <td>${item.umd_nm || '-'}</td>
                    </tr>
                `;
            });
        } else {
            // 전월세 데이터 테이블
            parsedHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-warning">
                            <tr>
                                <th>아파트명</th>
                                <th>거래일</th>
                                <th>거래유형</th>
                                <th>보증금</th>
                                <th>월세</th>
                                <th>전용면적</th>
                                <th>층</th>
                                <th>건축년도</th>
                                <th>법정동</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach(item => {
                const transactionType = item.transaction_type === '월세' ? '월세' : '전세';
                const typeClass = item.transaction_type === '월세' ? 'bg-warning text-dark' : 'bg-success';
                const deposit = item.deposit || item.deal_amount || 0;
                const monthlyRent = item.monthly_rent || 0;

                parsedHtml += `
                    <tr>
                        <td>${item.apt_name || '-'}</td>
                        <td>${item.deal_date || '-'}</td>
                        <td><span class="badge ${typeClass}">${transactionType}</span></td>
                        <td><strong>${deposit.toLocaleString()}만원</strong></td>
                        <td>${monthlyRent > 0 ? monthlyRent.toLocaleString() + '만원' : '-'}</td>
                        <td>${item.exclusive_area || '-'}㎡</td>
                        <td>${item.floor || '-'}층</td>
                        <td>${item.build_year || '-'}년</td>
                        <td>${item.umd_nm || '-'}</td>
                    </tr>
                `;
            });
        }

        parsedHtml += `
                    </tbody>
                </table>
            </div>
        `;
    } else {
        parsedHtml = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                해당 기간에 ${apiTypeName} 거래 데이터가 없습니다.
            </div>
        `;
    }
    
    $('#parsedData').html(parsedHtml);
    $('#results').removeClass('d-none');
}

function clearSaleForm() {
    $('#saleRegionCode').val('');
    $('#saleDealYmd').val('');
    hideResults();
    hideError();
    hideLoading();
}

function clearRentForm() {
    $('#rentRegionCode').val('');
    $('#rentDealYmd').val('');
    hideResults();
    hideError();
    hideLoading();
}

function showError(message) {
    $('#errorText').text(message);
    $('#errorMessage').removeClass('d-none');
}

function hideError() {
    $('#errorMessage').addClass('d-none');
}

function showLoading() {
    $('#loadingSpinner').removeClass('d-none');
}

function hideLoading() {
    $('#loadingSpinner').addClass('d-none');
}

function hideResults() {
    $('#results').addClass('d-none');
}

// XML 포맷팅 함수
function formatXmlString(xml) {
    const PADDING = ' '.repeat(2); // 들여쓰기 크기
    const reg = /(>)(<)(\/*)/g;
    let formatted = '';
    let pad = 0;

    // XML 문자열을 줄바꿈으로 구분
    xml = xml.replace(reg, '$1\n$2$3');

    xml.split('\n').forEach(line => {
        let indent = 0;
        if (line.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
        } else if (line.match(/^<\/\w/) && pad > 0) {
            pad -= 1;
        } else if (line.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
        } else {
            indent = 0;
        }

        formatted += PADDING.repeat(pad) + line + '\n';
        pad += indent;
    });

    return formatted.trim();
}

// XML 포맷팅 버튼 함수
function formatXml() {
    const xmlElement = $('#rawResponse');
    const currentXml = xmlElement.text();
    const formattedXml = formatXmlString(currentXml);
    xmlElement.text(formattedXml);

    // 성공 메시지 표시
    showTempMessage('XML이 포맷팅되었습니다.', 'success');
}

// XML 클립보드 복사 함수
function copyXmlToClipboard() {
    const xmlContent = $('#rawResponse').text();

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(xmlContent).then(() => {
            showTempMessage('XML이 클립보드에 복사되었습니다.', 'success');
        }).catch(err => {
            console.error('클립보드 복사 실패:', err);
            fallbackCopyTextToClipboard(xmlContent);
        });
    } else {
        fallbackCopyTextToClipboard(xmlContent);
    }
}

// 클립보드 복사 폴백 함수
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showTempMessage('XML이 클립보드에 복사되었습니다.', 'success');
        } else {
            showTempMessage('클립보드 복사에 실패했습니다.', 'error');
        }
    } catch (err) {
        console.error('클립보드 복사 실패:', err);
        showTempMessage('클립보드 복사에 실패했습니다.', 'error');
    }

    document.body.removeChild(textArea);
}

// XML 전체화면 토글 함수
function toggleXmlView() {
    const xmlElement = $('#rawResponse');
    const isFullscreen = xmlElement.hasClass('xml-fullscreen');

    if (isFullscreen) {
        // 전체화면 해제
        xmlElement.removeClass('xml-fullscreen');
        xmlElement.css({
            'position': '',
            'top': '',
            'left': '',
            'width': '',
            'height': '',
            'z-index': '',
            'max-height': '500px',
            'background': '#f8f9fa'
        });
        $('body').removeClass('xml-modal-open');
    } else {
        // 전체화면 모드
        xmlElement.addClass('xml-fullscreen');
        xmlElement.css({
            'position': 'fixed',
            'top': '20px',
            'left': '20px',
            'width': 'calc(100vw - 40px)',
            'height': 'calc(100vh - 40px)',
            'z-index': '9999',
            'max-height': 'none',
            'background': '#ffffff',
            'border': '2px solid #007bff',
            'box-shadow': '0 0 20px rgba(0,0,0,0.5)'
        });
        $('body').addClass('xml-modal-open');
    }
}

// 임시 메시지 표시 함수
function showTempMessage(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' : 'alert-info';

    const messageHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 10000; min-width: 300px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    $('body').append(messageHtml);

    // 3초 후 자동 제거
    setTimeout(() => {
        $('.alert').alert('close');
    }, 3000);
}
</script>

<style>
/* XML 전체화면 모드를 위한 CSS */
body.xml-modal-open {
    overflow: hidden;
}

.xml-fullscreen {
    cursor: auto !important;
}

/* 전체화면에서 스크롤바 커스터마이징 */
.xml-fullscreen::-webkit-scrollbar {
    width: 12px;
}

.xml-fullscreen::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.xml-fullscreen::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.xml-fullscreen::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* XML 포맷팅을 위한 스타일 */
#rawResponse {
    font-family: 'Courier New', monospace;
    line-height: 1.4;
    tab-size: 2;
}

/* 버튼 그룹 스타일 */
.btn-group-sm > .btn,
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
}
</style>
{% endblock %}
