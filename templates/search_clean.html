{% extends "base.html" %}

{% block title %}아파트 검색 - 실거래가 조회 시스템{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <i class="fas fa-search text-primary me-3" style="font-size: 2rem;"></i>
            <div>
                <h1 class="mb-0">아파트 검색</h1>
                <p class="text-muted mb-0">지역과 아파트명으로 실거래가 정보를 검색하세요</p>
            </div>
        </div>
    </div>
</div>

<!-- 검색 폼 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>검색 조건
                </h5>
            </div>
            <div class="card-body">
                <!-- 단계별 검색 폼 -->
                <div class="row">
                    <!-- 1단계: 시도/군구 선택 -->
                    <div class="col-md-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-map-marker-alt me-1"></i>1단계: 지역 선택</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="citySelect" class="form-label">시/도</label>
                                    <select class="form-select" id="citySelect" required>
                                        <option value="">시/도 선택</option>
                                        {% for city in cities %}
                                        <option value="{{ city }}">{{ city }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="districtSelect" class="form-label">군/구</label>
                                    <select class="form-select" id="districtSelect" required disabled>
                                        <option value="">군/구 선택</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary w-100" id="step1Btn" disabled>
                                    <i class="fas fa-search me-1"></i>법정동 조회
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2단계: 법정동 선택 -->
                    <div class="col-md-4">
                        <div class="card border-success" id="step2Card" style="opacity: 0.5;">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-building me-1"></i>2단계: 법정동 선택</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dongSelect" class="form-label">법정동</label>
                                    <select class="form-select" id="dongSelect" required disabled>
                                        <option value="">법정동 선택</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-success w-100" id="step2Btn" disabled>
                                    <i class="fas fa-list me-1"></i>아파트 목록 조회
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3단계: 아파트 선택 -->
                    <div class="col-md-4">
                        <div class="card border-warning" id="step3Card" style="opacity: 0.5;">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-home me-1"></i>3단계: 아파트 선택</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="apartmentSelect" class="form-label">아파트</label>
                                    <select class="form-select" id="apartmentSelect" required disabled>
                                        <option value="">아파트 선택</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-warning w-100" id="step3Btn" disabled>
                                    <i class="fas fa-chart-line me-1"></i>거래기록 조회
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 초기화 버튼 -->
                <div class="row mt-3">
                    <div class="col-md-12 text-center">
                        <button type="button" class="btn btn-outline-secondary" id="clearBtn">
                            <i class="fas fa-undo me-1"></i>검색 초기화
                        </button>
                    </div>
                </div>
                
                <!-- 검색 안내 -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info alert-sm mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>검색 안내:</strong> 시/도 → 군/구 → 법정동 → 아파트 순서로 단계별 검색하여 관심단지를 등록하세요.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 스피너 -->
<div id="loadingSpinner" class="text-center d-none">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">검색 중...</span>
    </div>
    <p class="mt-2">실거래가 데이터를 검색하고 있습니다...</p>
</div>

<!-- 단계별 검색 결과 -->
<!-- 1단계 결과: 법정동 목록 -->
<div id="step1Results" class="d-none">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>법정동 목록
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="step1Summary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>다음 단계:</strong> 관심있는 법정동을 선택하여 해당 동의 아파트 목록을 확인하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2단계 결과: 아파트 목록 -->
<div id="step2Results" class="d-none">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>아파트 목록
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="step2Summary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-success">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>다음 단계:</strong> 관심있는 아파트를 선택하여 해당 아파트의 거래기록을 확인하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3단계 결과: 거래기록 -->
<div id="step3Results" class="d-none">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>거래기록
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="step3Summary">
                        <!-- 동적으로 채워짐 -->
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="fas fa-heart me-1"></i>
                                <strong>관심단지 등록:</strong> 이 아파트를 관심단지로 등록하여 지속적으로 추적하세요.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 오류 메시지 -->
<div id="errorMessage" class="alert alert-danger d-none">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> 검색 오류</h5>
    <p id="errorText" class="mb-0"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
// 전역 변수
let currentRegionCode = null;
let currentDongName = null;
let currentApartmentName = null;

$(document).ready(function() {
    // 초기화 버튼
    $('#clearBtn').on('click', function() {
        resetAllSteps();
    });

    // 시/도 변경 이벤트
    $('#citySelect').on('change', function() {
        const city = $(this).val();
        $('#districtSelect').val('').prop('disabled', true);
        loadDistricts(city);
        resetStepsFrom(1);
    });

    // 군/구 변경 이벤트
    $('#districtSelect').on('change', function() {
        const district = $(this).val();
        if (district) {
            $('#step1Btn').prop('disabled', false);
        } else {
            $('#step1Btn').prop('disabled', true);
        }
        resetStepsFrom(1);
    });

    // 1단계 버튼 클릭
    $('#step1Btn').on('click', function() {
        performStep1();
    });

    // 법정동 변경 이벤트
    $('#dongSelect').on('change', function() {
        const dong = $(this).val();
        if (dong) {
            $('#step2Btn').prop('disabled', false);
        } else {
            $('#step2Btn').prop('disabled', true);
        }
        resetStepsFrom(2);
    });

    // 2단계 버튼 클릭
    $('#step2Btn').on('click', function() {
        performStep2();
    });

    // 아파트 변경 이벤트
    $('#apartmentSelect').on('change', function() {
        const apartment = $(this).val();
        if (apartment) {
            $('#step3Btn').prop('disabled', false);
        } else {
            $('#step3Btn').prop('disabled', true);
        }
        resetStepsFrom(3);
    });

    // 3단계 버튼 클릭
    $('#step3Btn').on('click', function() {
        performStep3();
    });

    // 초기화
    resetAllSteps();
});

// 단계별 초기화 함수들
function resetAllSteps() {
    // 폼 초기화
    $('#citySelect').val('');
    $('#districtSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
    $('#dongSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
    $('#apartmentSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
    
    // 버튼 초기화
    $('#step1Btn').prop('disabled', true);
    $('#step2Btn').prop('disabled', true);
    $('#step3Btn').prop('disabled', true);
    
    // 카드 초기화
    $('#step2Card').css('opacity', '0.5');
    $('#step3Card').css('opacity', '0.5');
    
    // 결과 영역 숨기기
    $('#step1Results').addClass('d-none');
    $('#step2Results').addClass('d-none');
    $('#step3Results').addClass('d-none');
    $('#errorMessage').addClass('d-none');
    
    // 전역 변수 초기화
    currentRegionCode = null;
    currentDongName = null;
    currentApartmentName = null;
}

function resetStepsFrom(step) {
    // 해당 단계부터 이후 단계들 초기화
    if (step <= 1) {
        $('#dongSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#step2Btn').prop('disabled', true);
        $('#step2Card').css('opacity', '0.5');
        $('#step2Results').addClass('d-none');
    }
    if (step <= 2) {
        $('#apartmentSelect').val('').prop('disabled', true).find('option:not(:first)').remove();
        $('#step3Btn').prop('disabled', true);
        $('#step3Card').css('opacity', '0.5');
        $('#step3Results').addClass('d-none');
    }
}

// 유틸리티 함수들
function formatPrice(amount) {
    if (amount >= 10000) {
        const eok = Math.floor(amount / 10000);
        const man = amount % 10000;
        if (man === 0) {
            return `${eok.toLocaleString()}억원`;
        } else {
            return `${eok.toLocaleString()}억 ${man.toLocaleString()}만원`;
        }
    } else {
        return `${amount.toLocaleString()}만원`;
    }
}

function showError(message) {
    $('#errorText').text(message);
    $('#errorMessage').removeClass('d-none');
}

function hideError() {
    $('#errorMessage').addClass('d-none');
}

function showLoading() {
    $('#loadingSpinner').removeClass('d-none');
}

function hideLoading() {
    $('#loadingSpinner').addClass('d-none');
}

// 1단계: 시도/군구 선택 후 법정동 목록 조회
function performStep1() {
    const city = $('#citySelect').val();
    const district = $('#districtSelect').val();
    
    if (!city || !district) {
        showError('시도와 군구를 모두 선택해주세요.');
        return;
    }
    
    showLoading();
    hideError();
    
    $.ajax({
        url: '/api/search/step1',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            city: city,
            district: district
        }),
        success: function(response) {
            hideLoading();
            if (response.success) {
                currentRegionCode = response.region_code;
                displayStep1Results(response);
                enableStep2();
            } else {
                showError(response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('법정동 목록 조회 중 오류가 발생했습니다.');
        }
    });
}

// 2단계: 법정동 선택 후 아파트 목록 조회
function performStep2() {
    const dongName = $('#dongSelect').val();
    
    if (!dongName || !currentRegionCode) {
        showError('법정동을 선택해주세요.');
        return;
    }
    
    showLoading();
    hideError();
    
    $.ajax({
        url: '/api/search/step2',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            region_code: currentRegionCode,
            dong_name: dongName
        }),
        success: function(response) {
            hideLoading();
            if (response.success) {
                currentDongName = dongName;
                displayStep2Results(response);
                enableStep3();
            } else {
                showError(response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('아파트 목록 조회 중 오류가 발생했습니다.');
        }
    });
}

// 3단계: 아파트 선택 후 거래기록 조회
function performStep3() {
    const aptName = $('#apartmentSelect').val();
    
    if (!aptName || !currentRegionCode) {
        showError('아파트를 선택해주세요.');
        return;
    }
    
    showLoading();
    hideError();
    
    $.ajax({
        url: '/api/search/step3',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            region_code: currentRegionCode,
            apt_name: aptName
        }),
        success: function(response) {
            hideLoading();
            if (response.success) {
                currentApartmentName = aptName;
                displayStep3Results(response);
            } else {
                showError(response.message);
            }
        },
        error: function() {
            hideLoading();
            showError('거래기록 조회 중 오류가 발생했습니다.');
        }
    });
}

// 결과 표시 함수들
function displayStep1Results(response) {
    const dongList = response.dong_list;
    const totalCount = response.total_count;
    const fromCache = response.from_cache;
    
    // 법정동 선택 옵션 업데이트
    $('#dongSelect').find('option:not(:first)').remove();
    dongList.forEach(dong => {
        $('#dongSelect').append(`<option value="${dong}">${dong}</option>`);
    });
    $('#dongSelect').prop('disabled', false);
    
    // 요약 정보 표시
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">총 거래건수</h6>
                    <h4 class="text-primary">${totalCount.toLocaleString()}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">법정동 수</h6>
                    <h4 class="text-success">${dongList.length}개</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">데이터 출처</h6>
                    <h4 class="text-info">${fromCache ? '캐시' : 'API'}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">조회 기간</h6>
                    <h4 class="text-warning">24개월</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#step1Summary').html(summaryHtml);
    $('#step1Results').removeClass('d-none');
}

function displayStep2Results(response) {
    const apartmentList = response.apartment_list;
    const dongName = response.dong_name;
    
    // 아파트 선택 옵션 업데이트
    $('#apartmentSelect').find('option:not(:first)').remove();
    apartmentList.forEach(apt => {
        $('#apartmentSelect').append(`<option value="${apt.apt_name}">${apt.apt_name} (${apt.transaction_count}건)</option>`);
    });
    $('#apartmentSelect').prop('disabled', false);
    
    // 요약 정보 표시
    const totalApartments = apartmentList.length;
    const totalTransactions = apartmentList.reduce((sum, apt) => sum + apt.transaction_count, 0);
    const avgPrice = apartmentList.length > 0 ? 
        Math.round(apartmentList.reduce((sum, apt) => sum + apt.avg_price, 0) / apartmentList.length) : 0;
    
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">법정동</h6>
                    <h4 class="text-primary">${dongName}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">아파트 수</h6>
                    <h4 class="text-success">${totalApartments}개</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">총 거래건수</h6>
                    <h4 class="text-info">${totalTransactions}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">평균 가격</h6>
                    <h4 class="text-warning">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#step2Summary').html(summaryHtml);
    $('#step2Results').removeClass('d-none');
}

function displayStep3Results(response) {
    const transactions = response.transactions;
    const aptName = response.apt_name;
    
    // 요약 정보 표시
    const totalTransactions = transactions.length;
    const avgPrice = totalTransactions > 0 ? 
        Math.round(transactions.reduce((sum, tx) => sum + tx.price_per_area, 0) / totalTransactions) : 0;
    const minPrice = totalTransactions > 0 ? Math.min(...transactions.map(tx => tx.price_per_area)) : 0;
    const maxPrice = totalTransactions > 0 ? Math.max(...transactions.map(tx => tx.price_per_area)) : 0;
    
    const summaryHtml = `
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">아파트명</h6>
                    <h4 class="text-primary">${aptName}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">총 거래건수</h6>
                    <h4 class="text-success">${totalTransactions}건</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">평균 가격</h6>
                    <h4 class="text-info">${Math.round(avgPrice / 10000).toLocaleString()}만원/㎡</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h6 class="card-title">가격 범위</h6>
                    <h4 class="text-warning">${Math.round(minPrice / 10000).toLocaleString()}~${Math.round(maxPrice / 10000).toLocaleString()}만원/㎡</h4>
                </div>
            </div>
        </div>
    `;
    
    $('#step3Summary').html(summaryHtml);
    $('#step3Results').removeClass('d-none');
}

// 단계 활성화 함수들
function enableStep2() {
    $('#step2Card').css('opacity', '1');
}

function enableStep3() {
    $('#step3Card').css('opacity', '1');
}

// 기존 함수들 (필요한 것들만 유지)
function loadDistricts(city) {
    if (!city) {
        $('#districtSelect').prop('disabled', true).find('option:not(:first)').remove();
        return;
    }
    
    $.ajax({
        url: `/api/districts/${encodeURIComponent(city)}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const districts = response.districts;
                $('#districtSelect').find('option:not(:first)').remove();
                districts.forEach(district => {
                    $('#districtSelect').append(`<option value="${district}">${district}</option>`);
                });
                $('#districtSelect').prop('disabled', false);
            } else {
                showError('군/구 목록을 불러오는데 실패했습니다.');
            }
        },
        error: function() {
            showError('군/구 목록을 불러오는 중 오류가 발생했습니다.');
        }
    });
}

function addToFavorites(aptName, regionCode, regionName, buildYear, event) {
    event.stopPropagation();
    
    // 중복 등록 확인
    $.ajax({
        url: '/api/favorites/check',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            apt_name: aptName,
            region_code: regionCode
        }),
        success: function(response) {
            if (response.exists) {
                showToast('이미 등록된 관심단지입니다.', 'warning');
                return;
            }
            
            // 관심단지 등록
            $.ajax({
                url: '/api/favorites',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    apt_name: aptName,
                    region_code: regionCode,
                    region_name: regionName,
                    build_year: buildYear
                }),
                success: function(response) {
                    if (response.success) {
                        showToast(`${aptName}이(가) 관심단지로 등록되었습니다.`, 'success');
                        // 버튼 상태 변경
                        const button = event.target.closest('button');
                        button.innerHTML = '<i class="fas fa-heart me-1"></i>등록완료';
                        button.classList.remove('btn-outline-success');
                        button.classList.add('btn-success');
                        button.disabled = true;
                    } else {
                        showToast('관심단지 등록에 실패했습니다: ' + response.message, 'error');
                    }
                },
                error: function() {
                    showToast('관심단지 등록 중 오류가 발생했습니다.', 'error');
                }
            });
        },
        error: function() {
            showToast('관심단지 확인 중 오류가 발생했습니다.', 'error');
        }
    });
}
</script>
{% endblock %}
